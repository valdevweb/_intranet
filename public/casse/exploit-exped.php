<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


require '../../Class/Db.php';
require('../../Class/casse/ExpDao.php');
require('../../Class/CrudDao.php');




$errors=[];
$success=[];
$db=new Db();
$pdoUser=$db->getPdo('web_users');
$pdoCasse=$db->getPdo('casse');
$pdoMag=$db->getPdo('magasin');

// $paletteDao=new PalettesDao($pdoCasse);
$expDao=new ExpDao($pdoCasse);



$expMag=$expDao->getExpByAffectation(1);
$expOcc=$expDao->getExpByAffectation(2);
$expHs=$expDao->getExpByAffectation(3);






//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>

<div id="container" class="container">
	<div class="row py-5">
		<div class="col">
			<h1 class="text-main-blue">Suivi des expéditions</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="row py-3">
		<div class="col">
			<h5 class="text-main-blue" id="traitement">Suivi des expéditions :</h5>
		</div>
	</div>


	<?php if (!empty($existingExp)): ?>
		<?php foreach ($existingExp as $exp): ?>
			<div class="row pb-5">
				<div class="col">
					<p class="text-main-blue">Livraison n°<?=$exp['id']?> pour le magasin <?=$exp['btlec']?></p>
					<table class="table table-sm light-shadow" id="action">
						<thead>

							<tr>
								<th class="align-top">Palette 4919</th>
								<th class="align-top">Palette <?=$exp['btlec']?></th>
								<th class="align-top">Mail ctrl <br>palettes</th>
								<th class="align-top">Retour ctrl <br>palettes</th>
								<th class="align-top">Expédiée le :</th>
								<th class="align-top">Mail magasin</th>
								<th class="align-top">Facturation</th>
							</tr>
						</thead>


						<?php  $detailExp=getExpAndPalette($pdoCasse,$exp['id']); ?>
						<?php foreach ($detailExp as $detail): ?>
							<?php

							$ddPilote=formatExistingDate($detail['date_dd_pilote']);
							$retourPilote=formatExistingDate($detail['date_retour_pilote']);
							$livraison=formatExistingDate($detail['date_delivery']);
							$mailMag=formatExistingDate($detail['date_info_mag']);
							$fac=formatExistingDate($detail['date_fac']);

							?>
							<tr>
								<td><a href="detail-palette.php?id=<?=$detail['paletteid']?>"><?=$detail['palette']?></a></td>
								<td><?=$detail['contremarque']?></td>
								<td class="text-right"><?=$ddPilote?></td>
								<td class="text-right"><?=$retourPilote?></td>
								<td class="text-right"><?=$livraison?></td>
								<td class="text-right"><?=$mailMag?></td>
								<td class="text-right"><?=$fac?></td>
							</tr>

						<?php endforeach ?>
						<tr >
							<td colspan="2"><h5 class="text-main-blue py-3 heavy">Traitements :</h5></td>
							<?php if ($exp['id_affectation']==2): ?>
								<td class="text-center py-3"><a href="pilote-dd.php?id=<?=$exp['id']?>" id="mailpilote"><button class="btn secOne"><i class="far fa-envelope pr-3"></i>Envoyer</button></a></td>

							<?php else: ?>
								<td class="text-center py-3"><a href="pilote-dd.php?id=<?=$exp['id']?>" id="mailpilote"><button class="btn secOne"><i class="far fa-envelope pr-3"></i>Envoyer</button></a></td>
							<?php endif ?>
							<td class="text-center py-3"><a href="pilote-palette-ok.php?id=<?=$exp['id']?>"><button class="btn secTwo"><i class="far fa-edit pr-3"></i>Saisir</button></a></td>
							<td class="text-center py-3"><a href="delivery-ok.php?id=<?=$exp['id']?>"><button class="btn secThree"><i class="far fa-edit pr-3"></i>Saisir</button></a></td>
							<td class="text-center py-3"><a href="mag-info-casse.php?id=<?=$exp['id']?>" id="mailMag"><button class="btn secFour"><i class="far fa-envelope pr-3"></i>Envoyer</button></a></td>

							<?php if($exp['btlec']==2051 || $exp['btlec']==2054 || $exp['btlec']==2069):?>
								<td class="text-center py-3">
									<a href="casse-dashboard/casse-clos.php?id=<?=$exp['id']?>" ><button class="btn btn-primary"><i class="far fa-credit-card pr-3"></i>Clôturer</button></a>
								</td>
							<?php else: ?>
								<td class="text-center py-3">
									<a href="facturation-casse.php?id=<?=$exp['id']?>" id="mailMag"><button class="btn secFive"><i class="far fa-credit-card pr-3"></i>Facturer</button></a><br>
									<div class="mt-3"><a href="casse-clos.php?id=<?=$exp['id']?>" ><button class="btn btn-primary"><i class="far fa-credit-card pr-3"></i>Clôturer</button></a></div>
								</td>
							<?php endif ?>


						</tr>
					</table>
				</div>
			</div>
			<div class="row">



			</div>
		<?php endforeach ?>
	<?php else: ?>
		aucune palette n'a été sélectionnée pour une livraison magasin
	<?php endif ?>




</div>

<?php
require '../view/_footer-bt.php';
?>