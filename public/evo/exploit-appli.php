<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


require '../../Class/Db.php';
require '../../Class/evo/AppliDao.php';
require '../../Class/evo/ModuleDao.php';
require '../../Class/evo/ChgLogDao.php';
require '../../Class/Evo/EvoDao.php';

// require_once '../../vendor/autoload.php';


$errors=[];
$success=[];
define("UPLOAD_DIR_EVO",DIR_UPLOAD.'evo-doc/' );
define("UPLOAD_URL_EVO",URL_UPLOAD.'evo-doc\\' );
$db=new Db();
$pdoUser=$db->getPdo('web_users');
$pdoEvo=$db->getPdo('evo');


$appliDao=new AppliDao($pdoEvo);
$moduleDao=new ModuleDao($pdoEvo);
$chgDao=new ChgLogDao($pdoEvo);
$evoDao=new EvoDao($pdoEvo);


if(!isset($_GET['id'])){
	echo "une erreur de navigation s'est produite";
	exit;

}

$thisAppli=$appliDao->getAppli($_GET['id']);
$docs=$appliDao->getDocAppli($_GET['id']);
$listModules=$moduleDao->getListModule($_GET['id']);


require_once('exploit-commun/00-init-var.php');
$listChg=$chgDao->getChgLogsByFields($idName, $_GET['id']);
$listDocChg=$chgDao->getChgLogsDocByField($idName, $_GET['id']);


$warning=false;

if(isset($_POST['add_doc'])){
	include 'exploit-commun/01-add-doc.php';
}
if(isset($_POST['add_changelog'])){
	include 'exploit-commun/02-add-chg.php';
}

if(isset($_POST['update_changelog'])){
	include 'exploit-commun/03-update-chg.php';
}



if(isset($_POST['add_module'])){
	if(empty($_POST['module'])){
		$errors[]="Merci de donner un nom au module";
	}

	if(empty($errors)){
		$idModule=$moduleDao->insertModule($_POST['module'], $_GET['id'], $_POST['descr'],$_POST['url'], $_POST['path']);
		if(isset($_FILES['files_module']['tmp_name'][0]) &&  !empty($_FILES['files_module']['tmp_name'][0])){

			for ($i=0; $i <count($_FILES['files_module']['tmp_name']) ; $i++) {
				$orginalFilename=$_FILES['files_module']['name'][$i];
				$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);
				$filenameNoExt = basename($orginalFilename, '.'.$ext);
				$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
				$filename = str_replace("'", '', $filename);

				$uploaded=move_uploaded_file($_FILES['files_module']['tmp_name'][$i],UPLOAD_DIR_EVO.$filename );
				if($uploaded==false){
					$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée 2";
				}else{
					$listFilename[]=$filename;
				}
			}
		}
		if(!empty($listFilename)){
			for ($i=0; $i < count($listFilename); $i++) {
				$moduleDao->insertDoc($idModule,$listFilename[$i], $_POST['filename'][$i],null);
			}
		}
	}
	$successQ='?success=module-add&id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}
if(isset($_GET['update_chg'])){
	$chgToUpdate=$chgDao->getChg($_GET['update_chg']);

}
if(isset($_GET['del_chg_doc'])){
	$chgDao->deleteChgDoc($_GET['del_chg_doc']);
	$successQ='?id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}
if(isset($_GET['del_chg'])){
	$chgDao->deleteChglog($_GET['del_chg']);
	$successQ='?id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}


if(isset($_GET['del_document'])){
	$do=$appliDao->deleteDoc($_GET['del_document']);
	$successQ='?id='.$_GET['id'].'#title-document';
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);

}

if(empty($thisAppli)){
	echo "l'application recherchée n'existe pas";
	exit;
}


//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>

<div class="container pb-5">
	<div class="row pt-5 pb-3">
		<div class="col">
			<h1 class="text-orange">Application : <?=$thisAppli['appli']?></h1>
		</div>
		<div class="col text-right">
			<a href="exploit-main.php" class="btn btn-dark">Retour</a>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>

	<div class="row ">
		<div class="col border-bottom rounded py-2 border-dark bg-light-grey">

			<div class="row">
				<div class="col">
					<i class="fas fa-laptop-code text-orange pr-3"></i>Plateforme : <?=$thisAppli['plateforme']?>
				</div>
				<div class="col">
					<i class="fas fa-user text-orange pr-3"></i>Responsable : <?=$thisAppli['resp']?>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<i class="fas fa-globe-europe pr-3 text-orange"></i>URL : <?=$thisAppli['url']?>
				</div>
				<div class="col">
					<i class="fas fa-folder-open pr-3 text-orange"></i>Chemin : <?=$thisAppli['path']?>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<i class="fas fa-file pr-3 text-orange"></i>Documents :
					<?php if (!empty($docs)): ?>
						<?php foreach ($docs as $key => $doc): ?>
							<a href="<?=UPLOAD_URL_EVO.$doc['file']?>" target="_blank" class="grey-link"><?=$doc['filename']?></a> -
						<?php endforeach ?>
					<?php else: ?>
						<i>Aucun document </i>
					<?php endif ?>
				</div>
			</div>
		</div>

	</div>

		<div class="row mt-3 mb-4">
			<div class="col">
				<h5 class="text-orange">Documents</h5>
				<?php include 'exploit-commun/10-list-document.php' ?>
			</div>

		</div>
		<div class="row mb-3">
			<div class="col text-right align-self-end">
				<div id="add-doc" class="btn btn-dark">Ajouter des documents</div>
			</div>
		</div>
		<div class="row" >
			<div class="col hidden" id="add-doc-form">
				<?php include 'exploit-commun/10-form-doc.php' ?>
			</div>
		</div>
	<div class="bg-separation-thin"></div>
	<div class="row">
		<div class="col">
			<h5 class="text-orange">ChangeLog</h5>
		</div>
	</div>
	<?php if (!empty($listChg)): ?>
		<?php include 'exploit-commun/12-table-chg.php' ?>
	<?php endif ?>
	<div class="row">
		<div class="col text-right">
			<div class="btn btn-dark" id="add-chglog">Ajouter un changelog</div>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<div class="hidden" id="add-chglog-form">
				<?php include 'exploit-commun/13-form-chg.php' ?>
			</div>
		</div>
	</div>
	<?php if (isset($_GET['update_chg'])): ?>
		<?php include 'exploit-commun/14-form-chg-update.php' ?>


	<?php endif ?>
	<div class="bg-separation-thin"></div>


	<div class="row mt-3 mb-4">
		<div class="col">
			<h5 class="text-orange">Modules de l'application</h5>
			<?php include 'exploit-appli/15-list-modules.php' ?>
		</div>

	</div>
	<div class="row">
		<div class="col text-right align-self-end">
			<div id="add-module" class="btn btn-dark">Ajouter un module</div>
		</div>
	</div>
	<div class="row" >
		<div class="col hidden" id="add-module-form">
			<?php include 'exploit-appli/16-form-add-module.php' ?>
		</div>
	</div>



</div>
<script src="../../public/js/upload-helpers.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$("#add-doc").on("click", function() {
			$("#add-doc-form").toggleClass("hidden shown");
			if($("#add-doc-form").is(':visible')){
				$("#add-doc").text("Fermer");
			}else{
				$("#add-doc").text("Ajouter des documents");
			}

		});
		$("#add-chglog").on("click", function() {
			$("#add-chglog-form").toggleClass("hidden shown");

			if($("#add-chglog-form").is(':visible')){
				$("#add-chglog").text("Fermer");
			}else{
				$("#add-chglog").text("Ajouter un changelog");
			}

		});

		$("#add-module").on("click", function() {
			$("#add-module-form").toggleClass("hidden shown");

			if($("#add-module-form").is(':visible')){
				$("#add-module").text("Fermer");
			}else{
				$("#add-module").text("Ajouter un module");
			}

		});
		$('#files-doc').change(function(){
			multipleWithName('files-doc','warning-zone', 'form-zone')
		});
				$("#url").on("click", function() {
			var files=$('#files-doc').get(0).files.length;
			$('input[name^="filename"]').each(function() {
				var filename=$(this).val();
				console.log(filename);
				$('#urlname').val(filename);
			});
		});
		$('#files-chglog').change(function(){
			multipleWithName('files-chglog','warning-chg-zone', 'form-chg-zone')
		});
		$('#files-chglog-new').change(function(){
			multipleWithName('files-chglog-new','warning-chg-zone-new', 'form-chg-zone-new')
		});
			$('#files-chglog-update').change(function(){
			multipleWithName('files-chglog-update','warning-chg-zone-update', 'form-chg-zone-update')
		});

		$("#urlchg").on("click", function() {
			console.log("ddd");
			var files=$('#files-chglog-new').get(0).files.length;
			$('input[name^="filename"]').each(function() {
				var filename=$(this).val();
				$('#urlnamechg').val(filename);

			});
		});
		$("#urlchg-update").on("click", function() {
			console.log("dzdzd");
			var files=$('#files-chglog-update').get(0).files.length;
			$('input[name^="filename"]').each(function() {
				var filename=$(this).val();
				$('#urlnamechgupdate').val(filename);

			});
		});


		$('#files-module').change(function(){
			multipleWithName('files-module','warning-module-zone', 'form-module-zone')
		});

	});
</script>



<?php
require '../view/_footer-bt.php';
?>