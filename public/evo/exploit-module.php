<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


require '../../Class/Db.php';
require '../../Class/Evo/ModuleDao.php';
require '../../Class/Evo/EvoDao.php';
require '../../Class/evo/EvoHelpers.php';
require '../../Class/evo/ChgLogDao.php';

// require_once '../../vendor/autoload.php';


$errors=[];
$success=[];
define("UPLOAD_DIR_EVO",DIR_UPLOAD.'evo-doc/' );
define("UPLOAD_URL_EVO",URL_UPLOAD.'evo-doc\\' );
$db=new Db();
$pdoUser=$db->getPdo('web_users');
$pdoEvo=$db->getPdo('evo');


$moduleDao=new ModuleDao($pdoEvo);
$chgDao=new ChgLogDao($pdoEvo);
$evoDao=new EvoDao($pdoEvo);


if(empty($_GET['id'])){
	echo "une erreur c'est produite, le module n'a pas été trouvé";
	exit;
}

$arrResp=EvoHelpers::arrayAppliRespName($pdoEvo);

$module=$moduleDao->getModule($_GET['id']);


$docs=$moduleDao->getDocModule($_GET['id']);
$listEvo=$evoDao->getEvoByModule($_GET['id']);
$arrayEtat=EvoHelpers::arrayEtat($pdoEvo);
$warning=false;

require_once('exploit-commun/00-init-var.php');

$listChg=$chgDao->getChgLogsByFields($idName, $_GET['id']);
$listDocChg=$chgDao->getChgLogsDocByField($idName, $_GET['id']);




if(isset($_POST['add_doc'])){
	include 'exploit-commun/01-add-doc.php';
}

if(isset($_POST['add_changelog'])){
	include 'exploit-commun/02-add-chg.php';
}
if(isset($_POST['update_changelog'])){
	include 'exploit-commun/03-update-chg.php';
}

if(isset($_GET['update_chg'])){
	$chgToUpdate=$chgDao->getChg($_GET['update_chg']);

}
if(isset($_GET['del_chg_doc'])){
	$chgDao->deleteChgDoc($_GET['del_chg_doc']);
	$successQ='?id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}
if(isset($_GET['del_chg'])){
	$chgDao->deleteChglog($_GET['del_chg']);
	$successQ='?id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}


if(isset($_GET['del_document'])){
	$do=$moduleDao->deleteDoc($_GET['del_document']);
	$successQ='?id='.$_GET['id'].'#title-document';
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);

}

//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>

<div class="container">
	<div class="row pt-5 pb-3">
		<div class="col">
			<h1 class="text-orange">Module : <?=$module['module']?></h1>
		</div>
		<div class="col text-right">
			<a href="exploit-main.php" class="btn btn-dark">Retour</a>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="row">
		<div class="col border-bottom rounded py-2 border-dark bg-light-grey">
			<div class="row">
				<div class="col">
					<i class="fas fa-laptop-code text-orange pr-3"></i><?=$module['plateforme']?><i class="fas fa-angle-double-right px-3"></i><?=$module['appli']?>
				</div>
				<div class="col"><i class="fas fa-user pr-3 text-orange"></i>Développeur : <?=$arrResp[$module['id_resp']]?></div>
			</div>
			<div class="row">
				<div class="col">
					<i class="fas fa-comment-alt text-orange pr-3"></i>Description :<br>
					<?=$module['descr']?>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<i class="fas fa-file pr-3 text-orange"></i>Documents :
					<?php if (!empty($docs)): ?>

						<?php foreach ($docs as $key => $doc): ?>
							<a href="<?=UPLOAD_URL_EVO.$doc['file']?>" target="_blank" class="grey-link"><?=$doc['filename']?></a> -
						<?php endforeach ?>
					<?php else: ?>
						<i>aucun document</i>
					<?php endif ?>
				</div>
			</div>
		</div>
	</div>
	<div class="row mt-3 mb-4">
		<div class="col">
			<h5 class="text-orange">Documents</h5>
			<?php include 'exploit-commun/10-list-document.php' ?>
		</div>

	</div>
	<div class="row mb-3">
		<div class="col text-right align-self-end">
			<div id="add-doc" class="btn btn-dark">Ajouter des documents</div>
		</div>
	</div>
	<div class="row" >
		<div class="col hidden" id="add-doc-form">
			<?php include 'exploit-commun/10-form-doc.php' ?>
		</div>
	</div>
	<div class="bg-separation-thin"></div>
	<div class="row">
		<div class="col">
			<h5 class="text-orange">ChangeLog</h5>
		</div>
	</div>
	<?php if (!empty($listChg)): ?>
		<?php include 'exploit-commun/12-table-chg.php' ?>
	<?php endif ?>
	<div class="row mb-3">
		<div class="col text-right">
			<div class="btn btn-dark" id="add-chglog">Ajouter un changelog</div>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<div class="hidden" id="add-chglog-form">
				<?php include 'exploit-commun/13-form-chg.php' ?>
			</div>
		</div>
	</div>
	<?php if (isset($_GET['update_chg'])): ?>
		<?php include 'exploit-commun/14-form-chg-update.php' ?>
	<?php endif ?>
	<div class="bg-separation-thin"></div>
	<div class="row">
		<div class="col">
			<h5 class="text-orange">Evos</h5>
		</div>
	</div>
	<?php if (!empty($listEvo)): ?>
		<?php include 'exploit-module/13-table-evos.php' ?>
	<?php else: ?>
		aucune demande d''évo sur ce module
	<?php endif ?>

</div>
<script src="../../public/js/upload-helpers.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$("#add-doc").on("click", function() {
			$("#add-doc-form").toggleClass("hidden shown");

			if($("#add-doc-form").is(':visible')){
				$("#add-doc").text("Fermer");
			}else{
				$("#add-doc").text("Ajouter des documents");
			}

		});
		$("#add-chglog").on("click", function() {
			$("#add-chglog-form").toggleClass("hidden shown");

			if($("#add-chglog-form").is(':visible')){
				$("#add-chglog").text("Fermer");
			}else{
				$("#add-chglog").text("Ajouter un changelog");
			}

		});
		$('#files-doc').change(function(){
			multipleWithName('files-doc','warning-zone', 'form-zone')
		});

		$("#url").on("click", function() {
			var files=$('#files-doc').get(0).files.length;
			$('input[name^="filename"]').each(function() {
				var filename=$(this).val();
				console.log(filename);
				$('#urlname').val(filename);
			});
		});
		$("#urlchg").on("click", function() {
			console.log("ddd");
			var files=$('#files-chglog-new').get(0).files.length;
			$('input[name^="filename"]').each(function() {
				var filename=$(this).val();
				$('#urlnamechg').val(filename);

			});
		});
		$("#urlchg-update").on("click", function() {
			console.log("dzdzd");
			var files=$('#files-chglog-update').get(0).files.length;
			$('input[name^="filename"]').each(function() {
				var filename=$(this).val();
				$('#urlnamechgupdate').val(filename);

			});
		});

		$('#files-chglog').change(function(){
			console.log("ici");
			multipleWithName('files-chglog','warning-chg-zone', 'form-chg-zone')
		});
		$('#files-chglog-new').change(function(){
			multipleWithName('files-chglog-new','warning-chg-zone-new', 'form-chg-zone-new')
		});
		$('#files-chglog-update').change(function(){
			multipleWithName('files-chglog-update','warning-chg-zone-update', 'form-chg-zone-update')
		});
	});
</script>
<?php
require '../view/_footer-bt.php';
?>