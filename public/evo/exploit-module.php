<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


require '../../Class/Db.php';
require '../../Class/Evo/ModuleDao.php';
require '../../Class/Evo/EvoDao.php';
require '../../Class/evo/EvoHelpers.php';
require '../../Class/evo/ChgLogDao.php';

// require_once '../../vendor/autoload.php';


$errors=[];
$success=[];
define("UPLOAD_DIR_EVO",DIR_UPLOAD.'evo-doc/' );
define("UPLOAD_URL_EVO",URL_UPLOAD.'evo-doc\\' );
$db=new Db();
$pdoUser=$db->getPdo('web_users');
$pdoEvo=$db->getPdo('evo');


$moduleDao=new ModuleDao($pdoEvo);
$chgDao=new ChgLogDao($pdoEvo);
$evoDao=new EvoDao($pdoEvo);


if(empty($_GET['id'])){
	echo "une erreur c'est produite, le module n'a pas été trouvé";
	exit;
}

$arrResp=EvoHelpers::arrayAppliRespName($pdoEvo);

$module=$moduleDao->getModule($_GET['id']);


$docModule=$moduleDao->getDocModule($_GET['id']);
$listChg=$chgDao->getChgLogsByModule($_GET['id']);
$listDocChg=$chgDao->getChgLogsDocByModule($_GET['id']);
$listEvo=$evoDao->getEvoByModule($_GET['id']);
$arrayEtat=EvoHelpers::arrayEtat($pdoEvo);
$warning=false;

if(isset($_POST['add_doc'])){

	$listFilename=[];
	if(isset($_FILES['files_doc']['tmp_name'][0]) &&  !empty($_FILES['files_doc']['tmp_name'][0])){
		for ($i=0; $i <count($_FILES['files_doc']['tmp_name']) ; $i++) {
			if(empty($_POST['filename'][$i])){
				$warning=true;
			}
			if(!$warning){
				$orginalFilename=$_FILES['files_doc']['name'][$i];
				$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);
				$filenameNoExt = basename($orginalFilename, '.'.$ext);
				$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
				$filename = str_replace("'", '', $filename);
				$uploaded=move_uploaded_file($_FILES['files_doc']['tmp_name'][$i],UPLOAD_DIR_EVO.$filename );
				if($uploaded==false){
					$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée 2";
				}else{
					$listFilename[]=$filename;
				}
			}

		}
	}
	if($warning){
		$errors[]="Merci de donner un nom à vos fichiers";
	}
	if(!empty($listFilename) && empty($errors)){
		for ($i=0; $i < count($listFilename); $i++) {

			$moduleDao->insertDoc($_GET['id'], $listFilename[$i], $_POST['filename'][$i], $_POST['cmt'][$i]);

		}
	}
	$successQ='?success=doc&id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}
if(isset($_POST['add_changelog'])){

	if(empty($_POST['changelog']) || empty($_POST['date_chglog'])){
		$errors[]="Merci de saisir le texte du change log et la date";
	}

	if(empty($errors)){
		$idChg=$chgDao->insertChgLog($_POST['changelog'], $_POST['date_chglog'],null, $_GET['id']);
		if(isset($_FILES['files_chg']['tmp_name'][0]) &&  !empty($_FILES['files_chg']['tmp_name'][0])){

			for ($i=0; $i <count($_FILES['files_chg']['tmp_name']) ; $i++) {
				$orginalFilename=$_FILES['files_chg']['name'][$i];
				$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);
				$filenameNoExt = basename($orginalFilename, '.'.$ext);
				$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
				$filename = str_replace("'", '', $filename);

				$uploaded=move_uploaded_file($_FILES['files_chg']['tmp_name'][$i],UPLOAD_DIR_EVO.$filename );
				if($uploaded==false){
					$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée 2";
				}else{
					$listFilename[]=$filename;
				}
			}
		}
		if(!empty($listFilename)){
			for ($i=0; $i < count($listFilename); $i++) {
				$chgDao->insertDoc($idChg,$listFilename[$i], $_POST['filename'][$i]);
			}
		}

	}
	$successQ='?success=chg-add&id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}
if(isset($_POST['update_changelog'])){

	if(empty($_POST['changelog']) || empty($_POST['date_chglog'])){
		$errors[]="Merci de saisir le texte du change log et la date";
	}

	if(empty($errors)){
		$idChg=$_GET['update_chg'];
		$chgDao->updateChgLog($idChg, $_POST['changelog'], $_POST['date_chglog'],null, $_GET['id']);
		if(isset($_FILES['files_chg']['tmp_name'][0]) &&  !empty($_FILES['files_chg']['tmp_name'][0])){

			for ($i=0; $i <count($_FILES['files_chg']['tmp_name']) ; $i++) {
				$orginalFilename=$_FILES['files_chg']['name'][$i];
				$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);
				$filenameNoExt = basename($orginalFilename, '.'.$ext);
				$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
				$filename = str_replace("'", '', $filename);

				$uploaded=move_uploaded_file($_FILES['files_chg']['tmp_name'][$i],UPLOAD_DIR_EVO.$filename );
				if($uploaded==false){
					$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée 2";
				}else{
					$listFilename[]=$filename;
				}
			}
		}
		if(!empty($listFilename)){
			for ($i=0; $i < count($listFilename); $i++) {
				$chgDao->insertDoc($idChg,$listFilename[$i], $_POST['filename'][$i]);
			}
		}

	}
	$successQ='?success=chg-add&id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}

if(isset($_GET['update_chg'])){
	$chgToUpdate=$chgDao->getChg($_GET['update_chg']);

}
if(isset($_GET['del_chg_doc'])){
	$chgDao->deleteChgDoc($_GET['del_chg_doc']);
	$successQ='?id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}
if(isset($_GET['del_chg'])){
	$chgDao->deleteChglog($_GET['del_chg']);
	$successQ='?id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}


if(isset($_GET['del_document'])){
	$do=$moduleDao->deleteDoc($_GET['del_document']);
	$successQ='?id='.$_GET['id'].'#title-document';
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);

}

//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>

<div class="container">
	<div class="row pt-5 pb-3">
		<div class="col">
			<h1 class="text-orange">Module : <?=$module['module']?></h1>
		</div>
		<div class="col text-right">
			<a href="exploit-main.php" class="btn btn-dark">Retour</a>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="row">
		<div class="col border-bottom rounded py-2 border-dark bg-light-grey">
			<div class="row">
				<div class="col">
					<i class="fas fa-laptop-code text-orange pr-3"></i><?=$module['plateforme']?><i class="fas fa-angle-double-right px-3"></i><?=$module['appli']?>
				</div>
				<div class="col"><i class="fas fa-user pr-3 text-orange"></i>Développeur : <?=$arrResp[$module['id_resp']]?></div>
			</div>
			<div class="row">
				<div class="col">
					<i class="fas fa-comment-alt text-orange pr-3"></i>Description :<br>
					<?=$module['descr']?>
				</div>
			</div>
			<div class="row">
				<div class="col">
					<i class="fas fa-file pr-3 text-orange"></i>Documents :
					<?php if (!empty($docModule)): ?>

						<?php foreach ($docModule as $key => $doc): ?>
							<a href="<?=UPLOAD_URL_EVO.$doc['file']?>" target="_blank" class="grey-link"><?=$doc['filename']?></a> -
						<?php endforeach ?>
					<?php else: ?>
						<i>aucun document</i>
					<?php endif ?>
				</div>
			</div>
		</div>
	</div>
	<div class="row mt-3 mb-4">
		<div class="col">
			<h5 class="text-orange">Documents</h5>
			<?php include 'exploit-module/01-list-document.php' ?>
		</div>

	</div>
	<div class="row mb-3">
		<div class="col text-right align-self-end">
			<div id="add-doc" class="btn btn-dark">Ajouter des documents</div>
		</div>
	</div>
	<div class="row" >
		<div class="col hidden" id="add-doc-form">
			<?php include 'exploit-module/10-form-doc.php' ?>
		</div>
	</div>
	<div class="bg-separation-thin"></div>
	<div class="row">
		<div class="col">
			<h5 class="text-orange">ChangeLog</h5>
		</div>
	</div>
	<?php if (!empty($listChg)): ?>
		<?php include 'exploit-module/12-table-chg.php' ?>
	<?php endif ?>
	<div class="row mb-3">
		<div class="col text-right">
			<div class="btn btn-dark" id="add-chglog">Ajouter un changelog</div>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<div class="hidden" id="add-chglog-form">
				<?php include 'exploit-module/11-form-chg.php' ?>
			</div>
		</div>
	</div>
	<?php if (isset($_GET['update_chg'])): ?>
		<?php include 'exploit-module/12-form-chg-update.php' ?>
	<?php endif ?>
	<div class="bg-separation-thin"></div>
	<div class="row">
		<div class="col">
			<h5 class="text-orange">Evos</h5>
		</div>
	</div>
<?php if (!empty($listEvo)): ?>
<?php include 'exploit-module/13-table-evos.php' ?>
<?php else: ?>
	aucune demande d''évo sur ce module
<?php endif ?>

</div>
<script src="../../public/js/upload-helpers.js"></script>
<script type="text/javascript">
	$(document).ready(function(){
		$("#add-doc").on("click", function() {
			$("#add-doc-form").toggleClass("hidden shown");

			if($("#add-doc-form").is(':visible')){
				$("#add-doc").text("Fermer");
			}else{
				$("#add-doc").text("Ajouter des documents");
			}

		});
		$("#add-chglog").on("click", function() {
			$("#add-chglog-form").toggleClass("hidden shown");

			if($("#add-chglog-form").is(':visible')){
				$("#add-chglog").text("Fermer");
			}else{
				$("#add-chglog").text("Ajouter un changelog");
			}

		});
		$('#files-doc').change(function(){
			multipleWithName('files-doc','warning-zone', 'form-zone')
		});
		$('#files-chglog').change(function(){
			multipleWithName('files-chglog','warning-chg-zone', 'form-chg-zone')
		});
			$('#files-chglog-new').change(function(){
			multipleWithName('files-chglog-new','warning-chg-zone-new', 'form-chg-zone-new')
		});

	});
</script>
<?php
require '../view/_footer-bt.php';
?>