<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


require '../../Class/Db.php';
require '../../Class/evo/EvoHelpers.php';
require '../../Class/FormHelpers.php';
require '../../Class/evo/EvoDao.php';
require '../../Class/evo/PlateformeDao.php';
require '../../Class/evo/AppliDao.php';
require '../../Class/evo/ModuleDao.php';
// require_once '../../vendor/autoload.php';



$errors=[];
$success=[];
$db=new Db();
$pdoUser=$db->getPdo('web_users');

$pdoEvo=$db->getPdo('evo');

$evoDao=new EvoDao($pdoEvo);
$appliDao=new AppliDao($pdoEvo);
$moduleDao=new ModuleDao($pdoEvo);
$plateformeDao=new PlateformeDao($pdoEvo);


$arrayPlateForm=EvoHelpers::arrayPlateformeName($pdoEvo);
$arrayAppli=EvoHelpers::arrayAppliName($pdoEvo);
$arrayModule=EvoHelpers::arrayModuleName($pdoEvo);
$arrayRespLong=EvoHelpers::arrayRespName($pdoEvo);
$arrayResp=EvoHelpers::arrayRespShort($pdoEvo);

$listResp=$evoDao->getListResp();
if(array_search($_SESSION['id_web_user'],array_column($listResp, 'idwebuser'))){
	$idwebuser=$_SESSION['id_web_user'];
}

if(isset($_POST['resp'])){
	$idwebuser=$_POST['resp'];
}


if(isset($idwebuser)){
	$idResp=$evoDao->getRespId($idwebuser);
	$listPlateform=$plateformeDao->getListPlateformeResp($idResp['id']);

	$listAppli=$appliDao->getApplisResp($idResp['id']);
	$listModules=$moduleDao->getModulesResp($idResp['id']);
}else{
	$listPlateform=$plateformeDao->getListPlateforme();
	$listAppli=$appliDao->getApplis();
	$listModules=$moduleDao->getModules();

}




if(isset($_POST['add-plateforme'])){
	include 'exploit-main/01-add-plateforme.php';
	$successQ='?success=add-plateforme';
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}
if(isset($_POST['add_appli'])){
	include 'exploit-main/02-add-appli.php';
}


if(isset($_GET['del_plateforme'])){
	$plateformeInUse=$plateformeDao->plateFormeInUse($_GET['del_plateforme']);
	if($plateformeInUse){
		$errors[]="Impossible de supprimer cette plateforme car elle est utilisée. Si aucune demande d'évo n'a été saisie sur cette plateforme, vous pourrez la supprimer si vous supprimez les applications ou les modules associés à cette plateforme. ";
	}
	if(empty($errors)){
		$plateformeDao->deletePlateforme($_GET['del_plateforme']);
		$successQ='?success=del-plateforme';
		unset($_POST);
		header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
	}
}


if(isset($_GET['success'])){
	$arrSuccess=[
		'add-plateforme'=>'Plateforme ajoutée',
		'del-plateforme'=>'Plateforme supprimée',
		'maj-plateforme'=>'Plateforme modifiée',
		'add-appli'=>'Appli ajoutée',
	];
	$success[]=$arrSuccess[$_GET['success']];
}








//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>

<div class="container">
	<div class="row pt-5 pb-3">
		<div class="col">
			<h1 class="text-main-blue">Exploitation</h1>
		</div>
	</div>


	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>

	<div class="row">
		<div class="col-auto">
			<h5 class="text-main-blue py-3">Filtrer la page par développeur</h5>
		</div>
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post">
				<div class="row mt-4">
					<?php foreach ($listResp as $key => $resp): ?>
						<div class="col-auto">
							<div class="form-check form-inline">
								<input class="form-check-input" type="radio" value="<?=$resp['idwebuser']?>" name="resp" onchange='this.form.submit()' <?= isset($idResp)? FormHelpers::restoreChecked($resp['idwebuser'], $idResp['idwebuser']):"" ?>>
								<label class="form-check-label" for="model"><?=$resp['resp']?></label>
							</div>
						</div>
					<?php endforeach ?>
				</div>
			</form>
		</div>
	</div>


	<div class="row">
		<div class="col">
			<h5 class="text-main-blue py-3">Liste des plateformes</h5>
		</div>
	</div>




	<?php if (!empty($listPlateform)) include 'exploit-main/10-table-plateforme.php'?>

	<div class="row">
		<div class="col hidden border py-3 px-5" id="add-plateforme-form">
			<?php include 'exploit-main/12-form-add-plateforme.php'?>

		</div>
	</div>
	<div class="bg-separation-thin my-3"></div>

	<div class="row">
		<div class="col">
			<h5 class="text-main-blue py-3">Liste des applications</h5>
		</div>
	</div>

	<?php if (!empty($listAppli)) include 'exploit-main/13-table-appli.php'?>
	<div class="row">
		<div class="col text-right">
			<div id="add-appli" class="btn btn-dark">Ajouter des applications</div>
		</div>
	</div>

	<div class="row">
		<div class="col hidden border py-3 px-5" id="add-appli-form">
			<?php  include 'exploit-main/14-form-add-appli.php'?>
		</div>
	</div>
	<?php if(isset($_GET['edit-appli'])) include 'exploit-main/15-form-edit-appli.php'?>
	<div class="bg-separation-thin my-3"></div>

	<div class="row">
		<div class="col">
			<h5 class="text-main-blue py-3">Liste des modules</h5>
		</div>
	</div>
	<?php if (!empty($listModules)): ?>
		<?php include 'exploit-main/16-table-module.php'?>

	<?php endif ?>

	<div id="floating-nav">
		<h6 class="text-main-blue text-center">Aller à</h6>
		<div class="pb-2"><i class="fas fa-angle-double-right fa-sm circle-icon-orange mr-3"></i><a href="#table-plateforme">Plateforme</a></div>
		<div class="pb-2"><i class="fas fa-angle-double-right fa-sm circle-icon-orange mr-3"></i><a href="#table-application">Applications</a></div>
		<div class="pb-2"><i class="fas fa-angle-double-right fa-sm circle-icon-orange mr-3"></i><a href="#table-module">Module</a></div>
	</div>

</div>
<script src="../js/datatables.min.js"></script>
<script src="../js/datatables-dates.js"></script>

<script type="text/javascript">
	function getReadableFileSizeString(fileSizeInBytes) {
		var i = -1;
		var byteUnits = [' ko', ' Mo', ' Go'];
		do {
			fileSizeInBytes = fileSizeInBytes / 1024;
			i++;
		} while (fileSizeInBytes > 1024);

		return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
	};

	$(document).ready(function() {

		$("#add-plateforme").on("click", function() {
			$("#add-plateforme-form").toggleClass("hidden shown");
			if($("#add-plateforme-form").is(':visible')){
				$("#add-plateforme").text("Fermer");
			}else{
				$("#add-plateforme").text("Ajouter des plateformes");
			}
		});

		$("#add-appli").on("click", function() {
			$("#add-appli-form").toggleClass("hidden shown");
			if($("#add-appli-form").is(':visible')){
				$("#add-appli").text("Fermer");
			}else{
				$("#add-appli").text("Ajouter des applications");
			}
		});
		$('div.hidden-text').hide();
		$('.hide-path-pointer').on("click", function(){
			var id= $(this).data("path-appli-pointer");
			if($('div[data-path-appli-target="'+id+'"]').is(":visible")){
				$('div[data-path-appli-target="'+id+'"]').hide();
				$('div[data-path-appli-pointer="'+id+'"]').html('<i class="fas fa-eye"></i>')


			}else{
				$('div[data-path-appli-target="'+id+'"]').show();
				$('div[data-path-appli-pointer="'+id+'"]').html('<i class="fas fa-times"></i>')

			}
		});

		$('.hide-url-pointer').on("click", function(){
			var id= $(this).data("url-appli-pointer");
			if($('div[data-url-appli-target="'+id+'"]').is(":visible")){
				$('div[data-url-appli-target="'+id+'"]').hide();
				$('div[data-url-appli-pointer="'+id+'"]').html('<i class="fas fa-eye"></i>')


			}else{
				$('div[data-url-appli-target="'+id+'"]').show();
				$('div[data-url-appli-pointer="'+id+'"]').html('<i class="fas fa-times"></i>')

			}
		});

		var url = window.location + '';
		var splited=url.split("#");
		console.log(url);
		if(splited[1]==undefined){
			var line='';
		}
		else if(splited.length==2){
			var line=splited[1];
			if(line.includes("appli-")){
				line=line.replace("appli-", "");
				$("tr#appli-"+line).addClass("anim");
			}

		}


		$('#table-plateforme').DataTable({
			paging: false, searching: false,info: false
		});
		$('#table-application').DataTable({
			language: {
				processing:     "Traitement en cours...",
				search:         "Rechercher&nbsp;:",
				lengthMenu:    "Afficher _MENU_ &eacute;l&eacute;ments",
				info:           "Affichage de l'&eacute;lement _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&eacute;ments",
				infoEmpty:      "Affichage de l'&eacute;lement 0 &agrave; 0 sur 0 &eacute;l&eacute;ments",
				infoFiltered:   "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
				infoPostFix:    "",
				loadingRecords: "Chargement en cours...",
				zeroRecords:    "Aucun &eacute;l&eacute;ment &agrave; afficher",
				emptyTable:     "Aucune donnée disponible dans le tableau",
				paginate: {
					first:      "Premier",
					previous:   "Pr&eacute;c&eacute;dent",
					next:       "Suivant",
					last:       "Dernier"
				},
				aria: {
					sortAscending:  ": activer pour trier la colonne par ordre croissant",
					sortDescending: ": activer pour trier la colonne par ordre décroissant"
				}
			},
			searching: false,info: false,
			bLengthChange: false,



		});
		$('#table-module').DataTable({
			language: {
				processing:     "Traitement en cours...",
				search:         "Rechercher&nbsp;:",
				lengthMenu:    "Afficher _MENU_ &eacute;l&eacute;ments",
				info:           "Affichage de l'&eacute;lement _START_ &agrave; _END_ sur _TOTAL_ &eacute;l&eacute;ments",
				infoEmpty:      "Affichage de l'&eacute;lement 0 &agrave; 0 sur 0 &eacute;l&eacute;ments",
				infoFiltered:   "(filtr&eacute; de _MAX_ &eacute;l&eacute;ments au total)",
				infoPostFix:    "",
				loadingRecords: "Chargement en cours...",
				zeroRecords:    "Aucun &eacute;l&eacute;ment &agrave; afficher",
				emptyTable:     "Aucune donnée disponible dans le tableau",
				paginate: {
					first:      "Premier",
					previous:   "Pr&eacute;c&eacute;dent",
					next:       "Suivant",
					last:       "Dernier"
				},
				aria: {
					sortAscending:  ": activer pour trier la colonne par ordre croissant",
					sortDescending: ": activer pour trier la colonne par ordre décroissant"
				}
			},
			info: false,
			bLengthChange: false,

		});


		$('input[name="file-appli[]"]').change(function(){
			var totalSize=0;
			var fileName='';
			var fileList='';
			var nbFiles = $(this).get(0).files.length;
			var formGroup="<div class='form-group'>";
			var endDiv="</div>";
			var titre="<div class='text-main-blue heavy'>Donner un intitulé au fichier :</div>";
			$("#zone-intitule").empty();

			for (var i = 0; i < nbFiles; ++i) {
				var fileSize=$(this).get(0).files[i].size;
				fileName=$(this).get(0).files[i].name;
				totalSize = totalSize+fileSize;
				fileList += fileName + '<br>';

				var label="<label>"+fileName+"</label>";
				var input="<input type='text' class='form-control'  name='intitule[" +i +"]' required>";

				$("#zone-intitule").append(titre+formGroup+label+input+endDiv);
			}

			if(typeof(hiddenOppSize)!="undefined" && hiddenOppSize!=null && hiddenOppSize!=0){
				totalSize=parseInt(hiddenOppSize)+totalSize;
			}


			if(totalSize <= 52428800){
				$("#file-appli-msg").text("");
				$('input[type="submit"]').removeAttr('disabled','disabled');
				console.log("taille totale ok "+ getReadableFileSizeString(totalSize));

			}else{
				$("#file-appli-msg").append("<div class='alert alert-danger'>Impossible de télécharger les fichiers vers le serveur, la taille totale des fichiers est de "+getReadableFileSizeString(totalSize)+". Vous ne pouvez pas dépasser 50Mo</div>");
				$('input[type="submit"]').attr('disabled','disabled');



				console.log("nb de fichier et taille totale NON ok. taille" +getReadableFileSizeString(totalSize));

			}
			titre='<p><span class="text-main-blue heavy">Fichier(s) sélectionnés : <br></span>'
			end='</p>';
			all=titre+fileList+end;
			$('#filename-appli').empty();
			console.log(all);
			$('#filename-appli').append(all);
			fileList="";
		});
	});
</script>

<?php
require '../view/_footer-bt.php';
?>