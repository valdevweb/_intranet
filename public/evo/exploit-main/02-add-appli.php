<?php

if(empty($_POST['appli']) || empty($_POST['id_plateforme']) ){
	$errors[]="Merci de renseigner le nom de l'application et  la plateforme";
}
if(!isset($idwebuser)){
	if(!isset($_POST['id_resp']) || empty($_POST['id_resp'])){
		$errors[]="Merci de renseigner le nom du responsable";
	}
}


if(empty($errors)){
	$listFilename=[];
	if(isset($_POST['id_resp'])){
		$thisResp=$_POST['id_resp'];
	}else{
		$thisResp=$idwebuser;

	}
	$idAppli=$appliDao->insertAppli($_POST['appli'], $_POST['id_plateforme'], $thisResp, $_POST['path'], $_POST['url']);

	if(isset($_FILES['file-appli']['tmp_name'][0]) &&  !empty($_FILES['file-appli']['tmp_name'][0])){

		for ($i=0; $i <count($_FILES['file-appli']['tmp_name']) ; $i++) {
			$orginalFilename=$_FILES['file-appli']['name'][$i];
			$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);
			$filenameNoExt = basename($orginalFilename, '.'.$ext);
			$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
        // echo $filename;
        // echo "<br>";
			$uploaded=move_uploaded_file($_FILES['file-appli']['tmp_name'][$i],DIR_UPLOAD.'evo-doc\\'.$filename );
			if($uploaded==false){
				$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée 2";
			}else{
				$listFilename[]=$filename;
			}
		}
	}


	if(!empty($listFilename)){
		for ($i=0; $i < count($listFilename); $i++) {
			$evoDao->insertDoc($_POST['intitule'][$i], $listFilename[$i], $idAppli, null);

		}
	}
	$successQ='?success=add-appli#appli-'.$idAppli;
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);

}
