<?php

if(empty($_POST['changelog']) || empty($_POST['date_chglog'])){
	$errors[]="Merci de saisir le texte du change log et la date";
}

if(empty($errors)){
	$idChg=$chgDao->insertChgLog($_POST['changelog'], $_POST['date_chglog'],$idAppli, $idModule, $idEvo);
	if(isset($_FILES['files_chg']['tmp_name'][0]) &&  !empty($_FILES['files_chg']['tmp_name'][0])){
		for ($i=0; $i <count($_FILES['files_chg']['tmp_name']) ; $i++) {
			$orginalFilename=$_FILES['files_chg']['name'][$i];
			$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);
			$filenameNoExt = basename($orginalFilename, '.'.$ext);
			$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
			$filename = str_replace("'", '', $filename);

			$uploaded=move_uploaded_file($_FILES['files_chg']['tmp_name'][$i],UPLOAD_DIR_EVO.$filename );
			if($uploaded==false){
				$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée 2";
			}else{
				$listFilename[]=$filename;
			}
		}
	}

}

if(!empty($listFilename) && empty($errors)){
	for ($i=0; $i < count($listFilename); $i++) {
		$chgDao->insertDoc($idChg,$listFilename[$i], $_POST['filename'][$i],$_POST['url'][$i], $_POST['urlname'][$i]);
	}
}
if(empty($listFilename) && empty($errors)){
	$chgDao->insertDoc($idChg,null, null,$_POST['url'][0], $_POST['urlname'][0]);
}
if(empty($errors)){
	$successQ='?success=chg-add&id='.$_GET['id'];
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);

}



