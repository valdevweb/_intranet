<?php
function statServices($pdoBt, $startDate,$endDate){
	$filtreService="";
	if(isset($_POST['services'])){
		$filtreService='AND (' .join(' OR ', array_map(function($value){return 'id_service='.$value;},$_POST['services'])) .')';
	}
	$query="SELECT
	DATE_FORMAT(date_msg,'%c') as mois,
	DATE_FORMAT(date_msg,'%Y') as year,
	count(msg.id) as nb_msg, id_service,
	service, services.id as servicesid FROM msg
	LEFT JOIN web_users.services on services.id= id_service WHERE DATE_FORMAT(date_msg,'%Y-%m') BETWEEN :startDate AND :endDate $filtreService
	GROUP BY id_service, DATE_FORMAT(date_msg,'%Y-%m') ORDER BY DATE_FORMAT(date_msg, '%Y-%m') ASC, id_service";
	// echo $query;
	$req=$pdoBt->prepare($query);
	$req->execute(array(
		':startDate'	=>$startDate->format('Y-m'),
		':endDate' =>$endDate->format('Y-m')

	));
	// return $req->errorInfo();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

//listes des services qui ont une page contact (slug non vide)
function servicesToDisplay($pdoUser){
	$req=$pdoUser->query("SELECT * FROM services WHERE service<>'test' AND mask_contact=0 ORDER BY service");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}



function getStartMonth($period){
	$arKey=array_keys($period);
	return $arKey[0];
}
function getEndMonth($period){
	$nbKeys=count($period)-1;
	$arKey=array_keys($period);
	return $arKey[$nbKeys];
}

function getLastDayOfMonth($month,$year){
	$date=(new DateTime($year.'-'.$month));
	$date=new DateTime('last day of '.$date ->format('M Y'));
	return $date->format('d');
}



if(isset($_POST['submit-service'])){
	$endDate=new DateTime($_POST['date-end']);
	$startDate=new DateTime($_POST['date-start']);
}else{
	$endDate=new DateTime();
	$startDate=new DateTime('first day of january this year');
}


$servicesList=servicesToDisplay($pdoUser);
$stats=statServices($pdoBt, $startDate,$endDate);




$halfServices=ceil(count($servicesList)/3);
$countbox=0;
$sArr=[];

// pour le graphique, on fait le total par service quelque soit le mois, l'année
$graphAr=[];

// tableau indéxé par l'année puis les numéros de mois
$period=[];


foreach ($stats as $stat) {
	// stats reorg sur année => service => mois =resultat
	$statServices[$stat['year']][$stat['service']][$stat['mois']]=$stat['nb_msg'];
	// 1 sous tableau par année avec les mois pour pouvoir boucler sur les année (un tableau html par année ) puis par les les mois
	if($stat['nb_msg']!=0){
		$period[$stat['year']][$stat['mois']]=0;
		// créa du tableau de service
		if(!in_array($stat['service'],$sArr)){
			$sArr[]=$stat['service'];
		}
	}
	if(!isset($graphAr[$stat['service']])){
		$graphAr[$stat['service']]=$stat['nb_msg'];
	}else{
		$graphAr[$stat['service']]=$stat['nb_msg'] + $graphAr[$stat['service']];

	}
}
 $maxDde=max($graphAr);

