<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}
//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
// require_once '../../vendor/autoload.php';

include '../../Class/FlashDao.php';
include '../../Class/FormHelpers.php';

//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);


 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];
$flash=[];

$flashDao= new FlashDao($pdoBt);
$listFlash=$flashDao->getListFlash((new DateTime())->format('Y-m-d'));



$notMandatoryFields=[
	0=>[
		'field'=>'date_start',
		'warning'	=>'Vous dvez sélectionner une date de début de parution'
	],
	1=>[
		'field'=>'date_end',
		'warning'	=>'Vous dvez sélectionner une date de fin de parution'
	],
	2=>[
		'field'=>'title',
		'warning'	=>'Vous devez saisir un titre'
	],
	3=>[
		'field'=>'content',
		'warning'	=>'Vous devez saisir un texte'
	],
];


if (isset($_POST['preview'])) {
	foreach ($notMandatoryFields as $key => $field) {
		if(empty($_POST[$field['field']])){
			$errors[]=$field['warning'];
		}
	}
	if(!isset($_POST['portail_bt'])&& !isset($_POST['portail_sav'])&& !isset($_POST['portail_fournisseur'])){
		$errors[]="Vous devez au moins sélectionner un site de parution";
	}
	if((new DateTime($_POST['date_end']))->setTime(23,59) < (new DateTime())->setTime(23,59)){
		$errors[]="La date de fin de parution est erronée";
	}
	if(empty($errors) && !isset($_GET['id'])){
		$lastInsertId=$flashDao->insertFlash();
		$successQ='?id='.$lastInsertId;
		unset($_POST);
		header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
	}
	if(empty($errors) && isset($_GET['id'])){

		$flashDao->updateFlash($_GET['id']);
		$successQ='?id='.$_GET['id'];
		unset($_POST);
		header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
	}
}

if (isset($_POST['save'])) {
	$flashDao->updateFlash($_GET['id']);
	$done=$flashDao->updateValidated(1,$_GET['id']);
	if($done==1){
		unset($_POST);
		header("Location: ".$_SERVER['PHP_SELF'],true,303);
	}
}
if(isset($_GET['id'])){
	$flash=$flashDao->getFlash($_GET['id']);
	$action = htmlspecialchars($_SERVER['PHP_SELF'])."?id=".$_GET['id'];
}else{
	$action = htmlspecialchars($_SERVER['PHP_SELF']);

}


//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container">
	<h1 class="text-main-blue py-5 ">Exploitation informations flash</h1>

	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="row">
		<div class="col">
			<h5 class="text-main-blue py-3"><i class="fas fa-newspaper pr-3"></i>Informations actuelles et à venir</h5>
		</div>
	</div>
	<?php if (isset($listFlash) && !empty($listFlash)): ?>

	<table class="table table-sm">
		<thead class="thead-dark">
			<tr>
				<th>#</th>
				<th>titre</th>
				<th>contenu</th>
				<th>diffusion</th>
				<th>Début</th>
				<th>Fin</th>
				<th class="text-center"><i class="fas fa-trash-alt"></i></th>
			</tr>
		</thead>
		<tbody>
			<?php foreach ($listFlash as $key => $OneF): ?>

				<tr>
					<td><?=$OneF['id']?></td>
					<td><?=$OneF['title']?></td>
					<td><?=$OneF['content']?></td>
					<td>
						<?=($OneF['portail_bt']==1)?"Portail BTLec<br>":""?>
						<?=($OneF['portail_sav']==1)?"Portail SAV<br>":""?>
						<?=($OneF['portail_fournisseur']==1)?"Portail fournisseurs<br>":""?>
					</td>
					<td><?=date('d-m-y', strtotime($OneF['date_start']))?></td>
					<td><?=date('d-m-y', strtotime($OneF['date_end']))?></td>
					<td class="text-center"><a href="delete-flash.php?id=<?=$OneF['id']?>"><i class="fas fa-trash-alt"></i></a></td>
				</tr>
			<?php endforeach ?>

		</tbody>
	</table>
	<?php else: ?>
		<div class="row">
			<div class="col">
				<div class="alert alert-primary">Aucune information actuelle ou à venir à afficher</div>
			</div>
		</div>
	<?php endif ?>
	<div class="bg-separation my-3"></div>

	<?php if (isset($_GET['id'])): ?>
		<div class="row">
			<div class="col">
				<h5 class="text-main-blue py-3"><i class="fas fa-newspaper pr-3"></i>Prévisualisation de l'information</h5>
			</div>
		</div>
		<div class="row">
			<div class="col border p-5">
				<div class="row">
					<div class="col shadow">
						<div class="row no-margin-bottom">
							<div class="col-auto align-self-center">
								<img src="../img/documents/flash-300.png" class="float-left">
							</div>
							<div class="col">
								<div class="row">
									<div class="col">
										<h1 class="text-main-blue mt-5"><?=$flash['title']?></h1>
										<p><?=$flash['content']?></p>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="bg-separation my-3"></div>
	<?php endif ?>
	<div class="row">
		<div class="col">
			<h5 class="text-main-blue py-3"><i class="fas fa-newspaper pr-3"></i>Saisie d'information</h5>
		</div>
	</div>
	<div class="row pb-5">
		<div class="col">
			<form action="<?=$action?>" method="post">
				<div class="row">
					<div class="col font-weight-bold">
						Diffusion :
					</div>
				</div>
				<div class="row border rounded mx-3 mt-2 py-2">
					<div class="col-auto">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="1" id="portail_bt" name="portail_bt" <?= isset($flash['portail_bt'])?FormHelpers::restoreChecked(1,$flash['portail_bt']):""?>>
							<label class="form-check-label" for="portail_bt">Portail BTLec</label>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="1" id="portail_sav" name="portail_sav" <?= isset($flash['portail_sav'])?FormHelpers::restoreChecked(1,$flash['portail_sav']):""?>>
							<label class="form-check-label" for="portail_sav">Portail SAV</label>
						</div>
					</div>
					<div class="col-auto">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="1" id="portail_fournisseur" name="portail_fournisseur" <?= isset($flash['portail_fournisseur'])?FormHelpers::restoreChecked(1,$flash['portail_fournisseur']):""?>>
							<label class="form-check-label" for="portail_fournisseur" >Portail fournisseur</label>
						</div>
					</div>
				</div>
				<div class="row mt-3">
					<div class="col font-weight-bold">
						Période de diffusion :
					</div>
				</div>
				<div class="row border rounded mx-3 mt-2 py-2">
					<div class="col-auto">
						<div class="form-group">
							<label for="date_start">Date de début :</label>
							<input type="date" class="form-control" name="date_start" id="date_start" value="<?= isset($flash['date_start'])?FormHelpers::restoreValue($flash['date_start']):""?>">
						</div>
					</div>
					<div class="col-auto">
						<div class="form-group">
							<label for="date_end">Date de fin :</label>
							<input type="date" class="form-control" name="date_end" id="date_end" value="<?= isset($flash['date_end'])?FormHelpers::restoreValue($flash['date_end']):""?>">
						</div>
					</div>
				</div>
				<div class="row mt-2">
					<div class="col mr-4">
						<div class="form-group">
							<label for="title" class="font-weight-bold">Titre :</label>
							<input type="text" class="form-control mx-3 mt-2" name="title" id="title" value="<?= isset($flash['title'])?FormHelpers::restoreValue($flash['title']):""?>">
						</div>
					</div>
				</div>

				<div class="row">
					<div class="col mr-4">
						<div class="form-group">
							<label for="content" class="font-weight-bold">Information :</label>
							<textarea  class="form-control mx-3 mt-2"  name="content" id="content"><?= isset($flash['content'])?FormHelpers::restoreValue($flash['content']):""?></textarea>
						</div>
					</div>
				</div>
				<div class="row justify-content-end">
					<div class="col-auto">
						<button class="btn btn-primary" name="preview" >Prévisualiser</button>
					</div>
					<?php if (isset($_GET['id'])): ?>
						<div class="col-auto">
							<button class="btn btn-primary" name="save">Enregistrer</button>
						</div>
					<?php endif ?>
				</div>

			</form>
		</div>
	</div>
</div>




<?php
require '../view/_footer-bt.php';
?>