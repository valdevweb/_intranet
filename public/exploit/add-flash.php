<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
include '../../Class/Db.php';

include '../../Class/FlashDao.php';
include '../../Class/FormHelpers.php';
include '../../Class/CrudDao.php';

//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);


 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];

$db=new Db();
$pdoBt=$db->getPdo('btlec');
$pdoUser=$db->getPdo('web_users');


$flash=[];

$flashDao= new FlashDao($pdoBt);
$crudBtlec=new CrudDao($pdoBt);


$listFlash=$flashDao->getListFlash((new DateTime())->format('Y-m-d'));



$notMandatoryFields=[
	0=>[
		'field'=>'date_start',
		'warning'	=>'Vous dvez sélectionner une date de début de parution'
	],
	1=>[
		'field'=>'date_end',
		'warning'	=>'Vous dvez sélectionner une date de fin de parution'
	],
	2=>[
		'field'=>'title',
		'warning'	=>'Vous devez saisir un titre'
	],
	3=>[
		'field'=>'content',
		'warning'	=>'Vous devez saisir un texte'
	],
];


// if (isset($_POST['preview'])) {
// 	foreach ($notMandatoryFields as $key => $field) {
// 		if(empty($_POST[$field['field']])){
// 			$errors[]=$field['warning'];
// 		}
// 	}
// 	if(!isset($_POST['portail_bt'])&& !isset($_POST['portail_sav'])&& !isset($_POST['portail_fournisseur'])){
// 		$errors[]="Vous devez au moins sélectionner un site de parution";
// 	}
// 	if((new DateTime($_POST['date_end']))->setTime(23,59) < (new DateTime())->setTime(23,59)){
// 		$errors[]="La date de fin de parution est erronée";
// 	}
// 	if(empty($errors) && !isset($_GET['id'])){
// 		$lastInsertId=$flashDao->insertFlash();
// 		$successQ='?id='.$lastInsertId;
// 		unset($_POST);
// 		header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
// 	}
// 	if(empty($errors) && isset($_GET['id'])){

// 		$flashDao->updateFlash($_GET['id']);
// 		$successQ='?id='.$_GET['id'];
// 		unset($_POST);
// 		header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
// 	}
// }

if (isset($_POST['validate'])) {
	$done=$flashDao->updateValidated(1,$_GET['id']);
	if($done==1){
		unset($_POST);
		header("Location: ".$_SERVER['PHP_SELF'],true,303);
	}
}




if(isset($_GET['id'])){
	$flash=$flashDao->getFlash($_GET['id']);
	$contentJs=$flash['content'];

	$action = htmlspecialchars($_SERVER['PHP_SELF'])."?id=".$_GET['id'];

}else{
	$contentJs="";
	$action = htmlspecialchars($_SERVER['PHP_SELF']);

}



//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
	DEBUT CONTENU CONTAINER
	*********************************-->
	<div class="container">
		<h1 class="text-main-blue py-5 ">Exploitation informations flash</h1>

		<div class="row">
			<div class="col-lg-1"></div>
			<div class="col">
				<?php
				include('../view/_errors.php');
				?>
			</div>
			<div class="col-lg-1"></div>
		</div>
		<div class="row">
			<div class="col">
				<h5 class="text-main-blue py-3"><i class="fas fa-newspaper pr-3"></i>Informations actuelles et à venir</h5>
			</div>
		</div>
		<?php if (isset($listFlash) && !empty($listFlash)): ?>
		<table class="table table-sm">
			<thead class="thead-dark">
				<tr>
					<th>#</th>
					<th>titre</th>
					<th>contenu</th>
					<th>diffusion</th>
					<th>Début</th>
					<th>Fin</th>
					<th class="text-center"><i class="fas fa-trash-alt"></i></th>
				</tr>
			</thead>
			<tbody>
				<?php foreach ($listFlash as $key => $OneF): ?>
					<tr>
						<td><?=$OneF['id']?></td>
						<td><?=$OneF['title']?></td>
						<td><?=$OneF['content']?></td>
						<td>
							<?=($OneF['portail_bt']==1)?"Portail BTLec<br>":""?>
							<?=($OneF['portail_sav']==1)?"Portail SAV<br>":""?>
							<?=($OneF['portail_fournisseur']==1)?"Portail fournisseurs<br>":""?>
						</td>
						<td><?=date('d-m-y', strtotime($OneF['date_start']))?></td>
						<td><?=date('d-m-y', strtotime($OneF['date_end']))?></td>
						<td class="text-center"><a href="delete-flash.php?id=<?=$OneF['id']?>"><i class="fas fa-trash-alt"></i></a></td>
					</tr>
				<?php endforeach ?>
			</tbody>
		</table>
	<?php else: ?>
		<div class="row">
			<div class="col">
				<div class="alert alert-primary">Aucune information actuelle ou à venir à afficher</div>
			</div>
		</div>
	<?php endif ?>
	<div class="bg-separation my-3"></div>
	<?php if (isset($_GET['id'])): ?>
		<div class="row">
			<div class="col">
				<h5 class="text-main-blue py-3"><i class="fas fa-newspaper pr-3"></i>Prévisualisation de l'information</h5>
			</div>
		</div>
		<div class="row">
			<div class="col border px-5 py-3">
				<div class="row">
					<div class="col shadow">
						<div class="row no-margin-bottom">
							<div class="col-auto align-self-center">
								<img src="../img/documents/flash-300.png" class="float-left">
							</div>
							<div class="col">
								<div class="row">
									<div class="col">
										<h1 class="text-main-blue mt-5"><?=$flash['title']?></h1>
										<p><?=$flash['content']?></p>
									</div>
								</div>

							</div>
						</div>
					</div>
				</div>
				<div class="row mt-3">
					<div class="col">
						<form action="<?= htmlspecialchars($_SERVER['PHP_SELF']).'?id='.$_GET['id']?>" method="post">

							<div class="row">
								<div class="col text-right">
									<button class="btn btn-danger" name="validate">Valider</button>
								</div>
								<div class="col">
									<a href="#title" class="btn btn-primary">Modifier</a>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>

		<div class="bg-separation my-3"></div>
	<?php endif ?>
	<div class="row">
		<div class="col">
			<h5 class="text-main-blue py-3"><i class="fas fa-newspaper pr-3"></i>Saisie d'information</h5>
		</div>
	</div>
	<?php include 'add-flash/form-saisie.php' ?>
</div>

<script type="text/javascript">
	richText.document.designMode='on';
	document.richText.document.body.style.fontFamily = "Arial";
	var showingSourceCode=false;
	var isInEditMode=true;

	function execCmd(command){
		richText.document.execCommand(command, false, null);
	}
	function execCommandWithArg(command, arg){
		richText.document.execCommand(command, false, arg);
	}
	function toggleSource(){
		if(showingSourceCode){
			richText.document.getElementsByTagName('body')[0].innerHTML=richText.document.getElementsByTagName('body')[0].textContent;
			showingSourceCode=false;
		}else{
			richText.document.getElementsByTagName('body')[0].textContent=richText.document.getElementsByTagName('body')[0].innerHTML;

			showingSourceCode=true;
		}
	}
	function toggleEdit(){
		if(isInEditMode){
			richText.document.designMode='off';
			isInEditMode=false;
		}else{
			richText.document.designMode='on';
			isInEditMode=true;
		}
	}

	$(document).ready(function(){
		var queryString = (new URL(document.location)).searchParams;
		if(queryString.has("id") === true){
			var id = queryString.get("id");

		}else{
			var id=0;
		}
		var frameContent='<?=$contentJs?>';
		console.log(frameContent);
		// on fait disparaitre le btn preview dès que l'utilisateur retourne dans le iframe pour le forcer à enregistrer avant la previsualisation
		var frameBody = $("#richText").contents().find("body");
		frameBody.append(frameContent);
		$('#save_flash').on('click',function(){
			console.log("click");
			if($('#portail_bt').is(":checked")){
				var portailBtlec=1;
			}else{
				var portailBtlec=0;
			}

			console.log("p btlec " + portailBtlec)
			if($('#portail_sav').is(":checked")){
				var portailSav=1;
			}else{
				var portailSav=0;
			}
			if($('#portail_fournisseur').is(":checked")){
				var portailFou=1;
			}else{
				var portailFou=0;
			}



			var dateStart=$('#date_start').val();
			var dateEnd=$('#date_end').val();
			var title=$('#title').val();
			console.log("date start "+dateStart);
			if(portailBtlec==0 && portailSav==0 && portailFou==0){
				alert("vous devez au moins sélectionner un portail");
				return false;
			}
			if(dateStart==""){
				alert("vous devez sélectionner une date de début");
				return false;
			}
			if(dateEnd==""){
				alert("vous devez sélectionner une date de fin");
				return false;
			}
			if(dateStart!="" && dateEnd!=""){
				var datetimeStart = new Date(dateStart);
				var datetimeEnd = new Date(dateEnd);
				var today=new Date();
				if(datetimeStart>datetimeEnd){
					alert("la date de début doit être inférieure à la date de fin");
					return false;
				}
					if(datetimeEnd<today){
					alert("la date de fin doit être inférieure à la date du jour");
					return false;
				}
			}




			console.log("id flash" +id);
			var iframeContent = richText.document.getElementsByTagName('body')[0].innerHTML;
			iframeContent=iframeContent.replace(/&nbsp;/gi,'');
			console.log(iframeContent);
			console.log()
			if(iframeContent){
				$.ajax({
					type:'POST',
					dataType : 'html',
					url:'add-flash/ajax-save.php',
					data:{iframe:iframeContent,id:id, portailBtlec:portailBtlec, portailSav:portailSav,portailFou:portailFou,title:title, dateStart:dateStart, dateEnd:dateEnd},
					success:function(id){
						console.log(id);
						// window.location.href = window.location.pathname+"?id="+id;
					}
				}).done(function(id) {
					console.log("id après done" +id);
					window.location.href = window.location.pathname+"?id="+id;

				});
			}

		});

	});

</script>

<?php
require '../view/_footer-bt.php';
?>