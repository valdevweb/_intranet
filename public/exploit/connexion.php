<?php

 // require('../../config/pdo_connect.php');
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	echo "pas de variable session";
	header('Location:'. ROOT_PATH.'/index.php');
}
//----------------------------------------------------------------
//			DEPENDANCES
//----------------------------------------------------------------

require '../../vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
//----------------------------------------------------------------
//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";
//------------------------------------------------------
//			FONCTION
//------------------------------------------------------
function getConnexion($pdoStat, $dateStartStr,$dateEndStr)
{
	$more='';
	// si le formualire a été soumis, on vérifie si valeur dans centrale et mag
	if(isset($_POST['submit']))
	{
			// si on reprend toute centrale, on prend forcément tous les mag donc more=vide
		if($_POST['centrale']=='all')
		{
			$more='';
		}
		else
		{
			$centrale='AND centrale = "'.$_POST['centrale'] .'"';
			if($_POST['magasin']=='all')
			{
				$mag='';
			}
			else
			{
				$mag=' AND galec= "'.$_POST['magasin'].'"';
			}
			$more=$centrale .$mag;
		}

	}
	else
	{
		$more='';
	}
	$req=$pdoStat->prepare("SELECT date_connexion, galec,btlec, deno, centrale, DATE_FORMAT(date_connexion,'%e') as day, DATE_FORMAT(date_connexion,'%c') as month, DATE_FORMAT(date_connexion,'%Y') as year FROM pbt_connexion_mag WHERE date_connexion BETWEEN :date_start AND :date_end $more ORDER BY  date_connexion ASC");
	$req->execute(array(
		':date_start'	=> $dateStartStr,
		':date_end'		=> $dateEndStr
	));
	return $req->fetchAll(PDO::FETCH_ASSOC);

}
//------------------------------------------------------
//			FORM DATA
//------------------------------------------------------
$monthForm=array("","Janvier", "Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre");







//------------------------------------------------------
//			FORM TRAITEMENT
//------------------------------------------------------

// initialisation des valeurs : soit valeur actuelle soit valeurs du form
if(!isset($_POST['submit']))
{
	$monthStart=date('n');
	$monthEnd=date('n');
	$yearStart=date('Y');
	$yearEnd=date('Y');
	$centrale='all';
	$mag='all';
}
else
{
	$monthStart=$_POST['month-start'];
	$monthEnd=$_POST['month-end'];
	$yearStart=$_POST['year-start'];
	$yearEnd=$_POST['year-end'];
	$centrale=$_POST['centrale'];
	$mag=$_POST['magasin'];
}

//------------------------------------------------------
//			INITIALISATION POUR TEST !!!!!!!!
//------------------------------------------------------
$monthStart=12;
$yearStart=2018;

$monthEnd=1;
$yearEnd=2019;
$centrale='all';
$mag='all';



// commun
$dateStart=new DateTime($yearStart.'-'.$monthStart.'-01');
$dateEnd=new DateTime($yearEnd.'-'.$monthEnd.'-28');
// on rajoute 1 car => juin -janv =5 or on veut le mois en cours donc 6
$nbMonth=$dateStart->diff($dateEnd)->m + ($dateStart->diff($dateEnd)->y*12) + 1;

$dateStartStr=$dateStart->format('Y-m-d');
// t permet d'avoir le nb de jour dans un mois => der jour du mois
$dateEndStr=$dateEnd->format('Y-m-t');
$nbAnneesDifferentes=floor(($monthStart+$nbMonth-1)/12);
// a partir du moment où on a au moins une année différente
$connexions=getConnexion($pdoStat, $dateStartStr, $dateEndStr);
$wYear='';
$wMonth='';
$data=[];
$jour=[];
foreach ($connexions as $c)
{
	// $data[$c['year']][$c['month']][$c['galec']]=$c['galec'];
	$data[$c['year']][$c['month']][$c['galec']]['centrale']=$c['centrale'];
	$data[$c['year']][$c['month']][$c['galec']]['galec']=$c['galec'];
	$data[$c['year']][$c['month']][$c['galec']][$c['day']]=$c['date_connexion'];


	// $data[$c['year']][$c['month']][$c['galec']]=$c['centrale'];
	// $data[$c['year']][$c['month']][$c['galec']];
// array_push($data[$c['year']][$c['month']][$c['galec']]['jour']$c['day']);
// $data[$c['year']][$c['month']][$c['galec']]['jour'][$c['day']]=$c['date_connexion'];

}

foreach ($data as $annee => $mois) {
	echo $annee . '<br>';
	foreach ($annee as $mois => $galec)
	{
		echo $key .'<br>';
		foreach($galec as $numGalec =>)
	}
}


echo "<pre>";
print_r($data);
echo '</pre>';
// echo "<pre>";
// print_r($connexions);
// echo '</pre>';



if($centrale=='all')
{
	$more='';
}
else
{
	if($mag=='all')
	{
		$more=' - ' .$centrale;
	}
	else{
		$more=' - '.$mag;
	}
}
if($nbMonth >1)
{
	$htmlTitle='de ' . $monthForm[$monthStart] .' '.$yearStart .' à '.$monthForm[$monthEnd] .' '.$yearEnd .$more;
}
elseif($nbMonth==1)
{
	$htmlTitle= $monthForm[$monthStart].' '.$yearStart .$more;

}
else
{
	$htmlTitle='';
}
	// echo "<pre>";
	// print_r($connexions);
	// echo '</pre>';

//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container">
	<h1 class="text-main-blue pt-5 ">Suivi des connexions et demandes magasins</h1>

	<div class="row mt-5">
		<div class="col shadow">
			<!-- form -->
			<h5 class="pl-5 pt-5 georgia text-main-blue "><i class="fas fa-hand-point-right pr-3"></i><span class="text-main-blue">Modifiez la sélection :</span></h5>

			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post">
				<div class="row">
					<div class="col-1"></div>
					<div class="col">
						<p class="text-orange">Choississez une période : </p>
					</div>
				</div>

				<div class="row">
					<!-- mois deb -->
					<div class="col-1"></div>
					<div class="col">
						<div class="form-group">
							<select class="form-control" name="month-start" id="month-start" required>
								<option value="">du mois de ...</option>
								<?php
								for ($i=1; $i <=12 ; $i++)
								{
									echo '<option value="'.$i.'">'.$monthForm[$i].'</option>';
								}

								?>
							</select>
						</div>
					</div>
					<!-- annee deb -->
					<div class="col-auto">
						<div class="form-group">
							<select class="form-control" name="year-start" id="year-start" required>
								<option value="">année...</option>
								<?php
								for ($i=2018; $i <=date('Y') ; $i++)
								{
									echo '<option value="'.$i.'">'.$i.'</option>';
								}

								?>
							</select>
						</div>
					</div>
					<div class="col-6"></div>
				</div>
				<div class="row">
					<!-- mois fin -->
					<div class="col-1"></div>
					<div class="col">
						<div class="form-group">
							<select class="form-control" name="month-end" id="month-end" required>
								<option value="">au mois de ...</option>
								<?php
								for ($i=1; $i <=12 ; $i++)
								{
									echo '<option value="'.$i.'">'.$monthForm[$i].'</option>';
								}

								?>
							</select>
						</div>
					</div>
					<!-- annee fin -->
					<div class="col-auto">
						<div class="form-group">
							<select class="form-control" name="year-end" id="year-end" required>
								<option value="">année...</option>
								<?php
								for ($i=2018; $i <=date('Y') ; $i++)
								{
									echo '<option value="'.$i.'">'.$i.'</option>';
								}

								?>
							</select>
						</div>
					</div>
					<div class="col-6">
					</div>
				</div>
				<div class="row">
					<div class="col-1"></div>
					<div class="col">
						<p class="text-orange">Spécifiez une centrale / un magasin : </p>
					</div>
				</div>
				<div class="row">
					<div class="col-1"></div>
					<div class="col-3">
						<div class="form-group">
							<select name="centrale" class="custom-select" id="centrale">
								<option value="all">Toutes centrales</option>
								<option value="LECASUD" >LECASUD</option>
								<option value="SCACENTRE"  >SCACENTRE</option>
								<option value="SCAPALSACE" >SCAPALSACE</option>
								<option value="SCAPARTOIS">SCAPARTOIS</option>
								<option value="SCAPEST">SCAPEST</option>
								<option value="SCADIF" >SCADIF</option>
								<option value="SCAPNOR">SCAPNOR</option>
								<option value="SOCAMIL">SOCAMIL</option>
								<option value="SOCARA">SOCARA</option>
							</select>
						</div>
					</div>
					<div class="col-3">
						<div class="form-group">
							<div id="mag-drop">
								<select id="magasin" name="magasin" class="custom-select">
									<option value='all'>tout magasins</option>
								</select>
							</div>
						</div>
					</div>
					<div class="col"></div>

				</div>
				<div class="row">
					<div class="col-7">
						<p class="text-right"><button class="btn btn-primary" type="submit" id="" name="submit">valider</button></p>
					</div>
					<div class="col"></div>
				</div>
				<!-- submit -->
				<!-- ./submit -->
			</form>
			<!-- ./form -->
		</div>

	</div>





	<div class="row">
		<div class="col">
			<h5 class="text-main-blue pl-5 pt-5"><i class="fas fa-hand-point-right pr-3"></i>Connexions magasins : <?=$htmlTitle?></h5>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<?php
			$wYear='';
			$wMonth='';
			foreach ($data as $annee => $mois)
			{
				echo $annee .'<br>';
				foreach ($mois as $galec => $arrDay)
				{
					echo "galec ". $arrDay['galec']  .'<br>';
					for ($i=1; $i <31 ; $i++) {
						if(isset($arrDay[$i]))
						{
							echo "1 ";
						}
						else
						{
							echo "0 ";
								echo "<pre>";
								print_r($arrDay);
								echo '</pre>';

						}
					}

				}

			}







			if($nbMonth==1)
			{
				echo '<p>tableau ' .$nbMonth.'</p>';

			}
			elseif ($nbMonth>1)
			{

				echo "supérieur à 1  mois<br>";

					//si on commence par janvier, on ne compte pas le changement d'année
				$nbAnneesDifferentes=floor(($monthStart+$nbMonth-1)/12);
			}

			$monthToDisplay=$monthStart;
			$yearToDisplay=$yearStart;
			for ($i=0; $i <$nbMonth ; $i++)
			{
				if($monthToDisplay<=12)
				{
					$nbDays= cal_days_in_month(CAL_GREGORIAN, $monthToDisplay, $yearToDisplay);
					echo'<table class="table"><thead class="thead-blue"><tr><th>Galec</th><th>Magasin</th><th>Centrale</th>';
					echo $monthForm[$monthToDisplay] . ' '. $yearToDisplay . ' : ' .$nbDays.'<br>';
					for ($i=1; $i <=$nbDays ; $i++)
					{
						echo '<th>'	.$i .'</th>';
					}
					echo '</tr></thead><tbody>';
					$magBoucle='';
					foreach ($connexions as $con)
					{
						if($con['galec'] !=$magBoucle)
						{
							echo '<tr><td>'.$con['galec'].'</td><td>'.$con['deno'].'</td><td>'.$con['centrale'].'</td>';

							$magBoucle=$con['galec'];

						}
						else
						{

						}
					}
					echo '</tbody></table>';
					$monthToDisplay++;
				}
				else
				{
					$monthToDisplay=1;
					$yearToDisplay++;
					if($monthToDisplay<=12)
					{
						$nbDays= cal_days_in_month(CAL_GREGORIAN, $monthToDisplay, $yearToDisplay);
						echo $monthForm[$monthToDisplay] . ' '. $yearToDisplay . ' : ' .$nbDays.'<br>';
						$monthToDisplay++;
					}
				}
			}

			?>
			<table class="table">
				<thead class="thead-blue">
					<tr>
						<th>Galec</th>
						<th>Magasin</th>
						<th>Centrale</th>
					</tr>
				</thead>
				<tbody>

				</tbody>
			</table>
		</div>

	</div>


	<!-- ./container -->
</div>

<script type="text/javascript">
	$(document).ready(function(){
		$('#centrale').on('change',function(){
				//réinitialise la liste sinon les selections s'ajoutent
				$('#magasin').html("<option value='all'>tout magasins</option>");
				var centrale =$(this).val();
				// console.log (centrale);
				if (centrale){
					$.ajax({
						type:'POST',
						url:'ajaxMag.php',
						data:'centrale='+centrale,
						success:function(html){
							$('#magasin').append(html);
						}

					});
				}
				window.localStorage.setItem("magasin", magasin);

			});
	});
</script>



<?php

require '../view/_footer-bt.php';

?>