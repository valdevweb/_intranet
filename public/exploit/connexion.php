<?php

// require('../config/autoload.php');
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	echo "pas de variable session";
	header('Location:'. ROOT_PATH.'/index.php');
}
//----------------------------------------------------------------
//			css dynamique
//----------------------------------------------------------------
$page=(basename(__FILE__));
$page=explode(".php",$page);
$page=$page[0];
$cssFile=ROOT_PATH ."/public/css/".$page.".css";

//----------------------------------------------------------------
//			DATA
//----------------------------------------------------------------

// mois en français pour affichage
$monthsFr=array("","Janvier", "Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre");

//----------------------------------------------------------------

// demandes mag par services => génération du tableau pour traitement js
$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' GROUP BY `id_service`");
$ddServices->execute();
$resDdServices=$ddServices->fetchAll(PDO::FETCH_ASSOC);
$shortLabel=[];

// racourci des labels
foreach ($resDdServices as $key =>$dds) {
	if($dds['full_name']=="achats PEM GEM")
	{
		$resDdServices[$key]['full_name']="PEM GEM";
	}
	elseif($dds['full_name']=="achats gris")
	{
		$resDdServices[$key]['full_name']="gris";
	}
	elseif($dds['full_name']=="direction commerciale")
	{
		$resDdServices[$key]['full_name']="dir ciale";
	}
	else
	{
		$resDdServices[$key]['full_name']=$dds['full_name'];
	}
}
//----------------------------------------------------------------




//----------------------------------------------------------------
//			 mag connectés par mois et centrales
//----------------------------------------------------------------


//----------------------------------------------------------------
//			récup sélections formulaire
//			ou initialisation de valeur par défaut (mois, année actuelle)
//----------------------------------------------------------------
	if(!isset($_POST['connexion']))
	{
		$start=date('m');
		$end=date('m');
		$year=date('Y');
		$centrale="LECASUD";
	}
	else
	{
		extract($_POST);
	}

//----------------------------------------------------------------
//			récup liste des mag
//----------------------------------------------------------------
	//toutes centrales
	if($centrale=="all")
	{
		$reqSca=$pdoBt->query("SELECT * FROM sca3");
		$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
	}
	else
	{
		// si une centrale : récup mag de la centrale sélectionnée dans le sca3
		$reqSca=$pdoBt->prepare("SELECT * FROM sca3 WHERE centrale= :centrale");
		$reqSca->execute(array(
		 ':centrale' =>$centrale
		));
		$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
	}

	// réorg tableau sous forme clé=pano galec => nom mag
	$mags=array();
	foreach ($magList as $key => $mag)
	{
		$mags[$mag['galec']]= $mag['mag'];

	}

//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-mig.php');
include('../view/_navbar.php');



?>
<div class="container">

	<!-- demandes par services -->
	<h1 class="blue-text text-darken-4">Demandes par services </h1>
	<p>&nbsp;</p>
	<div id="chartServices"></div>

	<!-- connexions mag -->
	<h1 class="blue-text text-darken-4">Magasins connectés par centrales et par mois</h1>

	<!-- formulaire -->
	<div class="row">
		<div class="col s12">
		<!-- <h3 class="blue-text text-darken-4">Choix de la période et de la centrale</h3> -->

			<form method="post" class="bggrey int-padding">
			<p>Sélectionnez la période :</p>
			<br>
			<div class="form-group row">
				<div class="col-1">
					<p>De</p>
				</div>
				<div class="col-2">
						<select name="start" class="form-control">
						<option value="01" <?=$start=='01' ? ' selected="selected"' : '' ?> >Janvier</option>
						<option value="02" <?=$start=='02' ? ' selected="selected"' : '' ?> >Février</option>
						<option value="03" <?=$start=='03' ? ' selected="selected"' : '' ?> >Mars</option>
						<option value="04" <?=$start=='04' ? ' selected="selected"' : '' ?> >Avril</option>
						<option value="05" <?=$start=='05' ? ' selected="selected"' : '' ?> >Mai</option>
						<option value="06" <?=$start=='06' ? ' selected="selected"' : '' ?> >Juin</option>
						<option value="07" <?=$start=='07' ? ' selected="selected"' : '' ?> >Juillet</option>
						<option value="08" <?=$start=='08' ? ' selected="selected"' : '' ?> >Août</option>
						<option value="09" <?=$start=='09' ? ' selected="selected"' : '' ?> >Septembre</option>
						<option value="10" <?=$start=='10' ? ' selected="selected"' : '' ?> >Octobre</option>
						<option value="11" <?=$start=='11' ? ' selected="selected"' : '' ?> >Novembre</option>
						<option value="12" <?=$start=='12' ? ' selected="selected"' : '' ?> >Décembre</option>
					</select>
				</div>
				<div class="col-1">
					<select  name="year" class="custom-select">
						<option value="2018" selected="select">2018</option>
					</select>
				</div>
				<div class="col-1">
					<p class="text-center">à</p>
				</div>
				<div class="col-2">
						<select name="end" class="form-control">
						<option value="01" <?=$end=='01' ? ' selected="selected"' : '' ?> >Janvier</option>
						<option value="02" <?=$end=='02' ? ' selected="selected"' : '' ?> >Février</option>
						<option value="03" <?=$end=='03' ? ' selected="selected"' : '' ?> >Mars</option>
						<option value="04" <?=$end=='04' ? ' selected="selected"' : '' ?> >Avril</option>
						<option value="05" <?=$end=='05' ? ' selected="selected"' : '' ?> >Mai</option>
						<option value="06" <?=$end=='06' ? ' selected="selected"' : '' ?> >Juin</option>
						<option value="07" <?=$end=='07' ? ' selected="selected"' : '' ?> >Juillet</option>
						<option value="08" <?=$end=='08' ? ' selected="selected"' : '' ?> >Août</option>
						<option value="09" <?=$end=='09' ? ' selected="selected"' : '' ?> >Septembre</option>
						<option value="10" <?=$end=='10' ? ' selected="selected"' : '' ?> >Octobre</option>
						<option value="11" <?=$end=='11' ? ' selected="selected"' : '' ?> >Novembre</option>
						<option value="12" <?=$end=='12' ? ' selected="selected"' : '' ?> >Décembre</option>
					</select>
				</div>
				<div class="col-1">
					<select  name="year" class="custom-select">
						<option value="2018" selected="select">2018</option>
					</select>
				</div>
			<!-- 	<div class="col-7">
				</div> -->

			</div>
			<br>
			<p>Sélectionnez la centrale :</p>

			<div class="form-group row">
				<div class="col-2">

					<select name="centrale" class="custom-select">
						<option value="all" <?=$centrale=='all' ? ' selected="selected"' : '' ?> >TOUTE CENTRALE</option>
						<option value="LECASUD" <?=$centrale=='LECASUD' ? ' selected="selected"' : '' ?> >LECASUD</option>
						<option value="SCACENTRE" <?=$centrale=='SCACENTRE' ? ' selected="selected"' : '' ?> >SCACENTRE</option>
						<option value="SCAPALSACE" <?=$centrale=='SCAPALSACE' ? ' selected="selected"' : '' ?> >SCAPALSACE</option>
						<option value="SCAPARTOIS" <?=$centrale=='SCAPARTOIS' ? ' selected="selected"' : '' ?> >SCAPARTOIS</option>
						<option value="SCAPEST" <?=$centrale=='SCAPEST' ? ' selected="selected"' : '' ?> >SCAPEST</option>
						<option value="SCADIF" <?=$centrale=='SCADIF' ? ' selected="selected"' : '' ?> >SCADIF</option>
						<option value="SCAPNOR" <?=$centrale=='SCAPNOR' ? ' selected="selected"' : '' ?> >SCAPNOR</option>
						<option value="SOCAMIL" <?=$centrale=='SOCAMIL' ? ' selected="selected"' : '' ?> >SOCAMIL</option>
						<option value="SOCARA" <?=$centrale=='SOCARA' ? ' selected="selected"' : '' ?> >SOCARA</option>
					</select>
				</div>
			</div>
				<input type="submit" name="connexion">
			</div>
			</form>
		</div>
		<br><br>
		<div class="row">
		<?php


//----------------------------------------------------------------
//			traitement période
//----------------------------------------------------------------
	// nombre de mois sélectionnés

	$nbMonth= intval($end-$start +1);
	// echo $nbMonth;
	if($nbMonth==1)
	{
		$formDate=$start."/".$year;
		$nbDays= cal_days_in_month(CAL_GREGORIAN, $start, $year);
		$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND description='user authentifié' AND DATE_FORMAT(date_heure, '%m/%Y') = :formDate ORDER BY users.galec ASC");
		$reqStat->execute(array(
			':formDate'	=>$formDate
			// ':formDate'	=>'05/2018'

		));
		$statRes=$reqStat->fetchAll(PDO::FETCH_ASSOC);
		$magArray=array();
		$precedentPano="";
		foreach ($statRes as $key => $stat)
		{
			// si le code galec des stats est trouvé dans le tableau de sca 3
			if(isset($mags[$stat['galec']]))
			{
				$key=$stat['galec']." - " .$mags[$stat['galec']];
				if($stat['galec']<>$actuPano)
				{
				// on commence un nouveau mag
				// echo "<br>" . $stat['galec'] ." - " . $mags[$stat['galec']] ."<br>";
					$actuPano= $stat['galec'];
				 // echo $stat['jour'];
				//on créé le "tableau mag"
				// $key=$stat['galec'] .$mags[$stat['galec']];
				// echo $key;
					$magArray[$key]=array();
					array_push($magArray[$key], $stat['jour']);

				// $magArray[$stat['galec']]=array();
				// array_push($magArray[$stat['galec']], $stat['jour']);

				}
				else
				{
				//tj même mag
					array_push($magArray[$key], $stat['jour']);
				// array_push($magArray[$stat['galec']], $stat['jour']);

				// echo ", ". $stat['jour'];

				}
			}
			else
			// si le mag n'appartient pas à la centrale, on avance
			{
				$actuPano= $stat['galec'];
			}
		}
			echo "<div class='row'><div class='col'>";

			$start= $start + 0;
			echo "<h3 class='blue-text text-darken-4'>". $monthsFr[$start]."</h3><br>";

			echo "<table class='striped'><tr><td>&nbsp;</td>";
			for ($j=1; $j <= $nbDays ; $j++)
			{
				echo "<td>" .$j ."</td>";
			}
			foreach ($magArray as $pano => $jour)
			{
				echo "</tr><tr><td>".$pano ."</td>";

				for ($i=1; $i <= $nbDays ; $i++)
				{

					if(in_array($i, $jour))
					{
						echo "<td>X</td>";
					}
					else
					{
						echo "<td>&nbsp;</td>";
					}
				}
			}
			echo "</tr></table>";
			echo "</div></div>";




		// echo "hello";
	}
	elseif($nbMonth > 1) //plus d'un mois
	{
		//boucle pour afficher lien vers tableau mois
		// à faire

		for ($k=0; $k < $nbMonth ; $k++)
		{
			$formDate=$start + $k."/".$year;
			$formDate="0" .$formDate;
			// $formDate=date_format($formDate,"m/Y");
			// echo $formDate;
			$formMonth=$start + $k;
			$nbDays= cal_days_in_month(CAL_GREGORIAN, $formMonth, $year);
			// echo $nbDays;
			$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND description='user authentifié' AND DATE_FORMAT(date_heure, '%m/%Y') = :formDate ORDER BY users.galec ASC");
			$reqStat->execute(array(
				':formDate'	=>$formDate
			));
			$statRes=$reqStat->fetchAll(PDO::FETCH_ASSOC);
			$magArray=array();
			$precedentPano="";

			foreach ($statRes as $key => $stat)
			{
			// si le code galec des stats est trouvé dans le tableau de sca 3
				if(isset($mags[$stat['galec']]))
				{
					$key=$stat['galec']." - " .$mags[$stat['galec']];
					if($stat['galec']<>$actuPano)
					{
						$actuPano= $stat['galec'];
						$magArray[$key]=array();
						array_push($magArray[$key], $stat['jour']);
					}
					else
					{
				//tj même mag
						array_push($magArray[$key], $stat['jour']);
					}
				}
				else
			// si le mag n'appartient pas à la centrale, on avance
				{
					$actuPano= $stat['galec'];
				}
			}

			echo "<div class='row'><div class='col'>";
			echo "<h3 class='blue-text text-darken-4'>". $monthsFr[$start + $k]."</h3><br>";
			echo "<table class='striped'><tr><td>&nbsp;</td>";
			for ($j=1; $j <= $nbDays ; $j++)
			{
				echo "<td>" .$j ."</td>";
			}
			foreach ($magArray as $pano => $jour)
			{
				echo "</tr><tr><td>".$pano ."</td>";

				for ($i=1; $i <= $nbDays ; $i++)
				{

					if(in_array($i, $jour))
					{
						echo "<td>X</td>";
					}
					else
					{
						echo "<td>&nbsp;</td>";
					}
				}
			}
			echo "</tr></table>";
			echo "</div></div>";


		}




	}
	else
	{
		echo "période incorrecte";
	}
		 ?>




		</div>



	</div>




	<script src="https://cdn.zingchart.com/zingchart.min.js"></script>
	<script type="text/javascript">
		var servicesData=[<?php
			foreach ($resDdServices as $dds) {
				echo   $dds['nb'] . ',';
			}
			?>];
		var servicesLabels=[<?php
			foreach ($resDdServices as $dds) {
				echo '"'. $dds['full_name'] .'",';
			}
			?>];
			window.onload=function(){

								zingchart.render({
									id:"chartServices",
									width:1200,
									height:400,
									data:{
										"type":"bar",
										"title":{
											"text":"Nombre de demandes par services"
										},
										"plot": {
											"value-box": {
												"text": "%v"
											}
										},
										"scale-x":{
											"item":{
												"font-size":10
											},
											"labels":servicesLabels,
										},
										"series":[
										{
											"values":servicesData
										}
										]
									}
								});


							};


	</script>



	<?php
//----------------------------------------------------
// VIEW - FOOTER
//----------------------------------------------------
	require '../view/_footer.php';

	?>