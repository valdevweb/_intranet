<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}
require '../../config/db-connect.php';
require '../../vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;


$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";
include '../../Class/mag/MagHelpers.php';
include '../../Class/FormHelpers.php';
include '../../Class/ConnexionDao.php';
function getStartMonth($period){
	$arKey=array_keys($period);
	return $arKey[0];
}
function getEndMonth($period){
	$nbKeys=count($period)-1;
	$arKey=array_keys($period);
	return $arKey[$nbKeys];
}

function getLastDayOfMonth($month,$year){
	$date=(new DateTime($year.'-'.$month));
	$date=new DateTime('last day of '.$date ->format('M Y'));
	return $date->format('d');
}

function getNameFromNumber($num) {
	$numeric = $num % 26;
	$letter = chr(65 + $numeric);
	$num2 = intval($num / 26);
	if ($num2 > 0) {
		return getNameFromNumber($num2 - 1) . $letter;
	} else {
		return $letter;
	}
}
function statServices($pdoBt, $startDate,$endDate){
	$filtreService="";
	if(isset($_POST['services'])){
		$filtreService='AND (' .join(' OR ', array_map(function($value){return 'id_service='.$value;},$_POST['services'])) .')';
	}
	$query="SELECT
	DATE_FORMAT(date_msg,'%c') as mois,
	DATE_FORMAT(date_msg,'%Y') as year,
	count(msg.id) as nb_msg, id_service,
	service, services.id as servicesid FROM msg
	LEFT JOIN web_users.services on services.id= id_service WHERE DATE_FORMAT(date_msg,'%Y-%m') BETWEEN :startDate AND :endDate $filtreService
	GROUP BY id_service, DATE_FORMAT(date_msg,'%Y-%m') ORDER BY DATE_FORMAT(date_msg, '%Y-%m') ASC, id_service";
	$req=$pdoBt->prepare($query);
	$req->execute(array(
		':startDate'	=>$startDate->format('Y-m'),
		':endDate' =>$endDate->format('Y-m')

	));
	// return $req->errorInfo();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

//listes des services qui ont une page contact (slug non vide)
function servicesToDisplay($pdoUser){
	$req=$pdoUser->query("SELECT * FROM services WHERE service<>'test' AND mask_contact=0 ORDER BY service");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}



$monthsFr=array("","Janv.", "Fév.","Mars","Avril","Mai","Juin","Juil.","Août","Sept.","Oct.","Nov.","Déc.");
$days=array("D","L","M","M","J","V","S");

$errors=[];
$success=[];
$connexionDao=new ConnexionDao();

$idCentralesList=[];
$thisCentrale='';
$periodConn=[];
$magInfo=[];
$nbMagCentrale=0;
$nbConnCentrale=0;
$arCentrale=MagHelpers::getListCentraleStats($pdoMag);

if(isset($_POST['submit-conn']) || isset($_POST['export_connexion'])){
	if(!isset($_POST['centrales'])){
		$idCentralesList=array_keys($arCentrale);

	}else{
		$idCentralesList=$_POST["centrales"];
	}
	$endDateConn=new DateTime($_POST['conn-date-end']);
	$startDateConn=new DateTime($_POST['conn-date-start']);
}else{
	$endDateConn=$startDateConn=new DateTime();
	$idCentralesList=array_keys($arCentrale);
}




$connexions=$connexionDao->getConnexion($pdoStat,$startDateConn,$endDateConn,$idCentralesList);
$mags=$connexionDao->getMag($pdoUser,$idCentralesList);

foreach ($mags as $mag) {
	$magList[]=$mag['galec'];
	$magInfo[$mag['galec']]['centrale']=$mag['centrale'];
	$magInfo[$mag['galec']]['deno']=$mag['deno'];
}


foreach ($connexions as $conn) {
	$statConn[$conn['year']][$conn['mois']][$conn['galec']][$conn['jour']]=$conn['date_entiere'];
	$periodConn[$conn['year']][$conn['mois']]=0;
}

if(isset($_POST['export_connexion'])){
	include 'connexion/01-connexion-data-export.php';
}



if(isset($_POST['submit-service']) || isset($_POST['export_contact'])){
	$endDate=new DateTime($_POST['date-end']);
	$startDate=new DateTime($_POST['date-start']);
}else{
	$endDate=new DateTime();
	$startDate=new DateTime('first day of january this year');
}



$servicesList=servicesToDisplay($pdoUser);
$stats=statServices($pdoBt, $startDate,$endDate);
$halfServices=ceil(count($servicesList)/3);
$countbox=0;
$sArr=[];

// pour le graphique, on fait le total par service quelque soit le mois, l'année
$graphAr=[];

// tableau indéxé par l'année puis les numéros de mois
$period=[];



if(!empty($stats)){
	foreach ($stats as $stat) {
	// stats reorg sur année => service => mois =resultat
		$statServices[$stat['year']][$stat['service']][$stat['mois']]=$stat['nb_msg'];
	// 1 sous tableau par année avec les mois pour pouvoir boucler sur les année (un tableau html par année ) puis par les les mois
		if($stat['nb_msg']!=0){
			$period[$stat['year']][$stat['mois']]=0;
		// créa du tableau de service
			if(!in_array($stat['service'],$sArr)){
				$sArr[]=$stat['service'];
			}
		}
		if(!isset($graphAr[$stat['service']])){
			$graphAr[$stat['service']]=$stat['nb_msg'];
		}else{
			$graphAr[$stat['service']]=$stat['nb_msg'] + $graphAr[$stat['service']];
		}
	}


}


if (empty($graphAr)){
	$maxDde=0;
}else{
	$maxDde=max($graphAr);
}


if(isset($_POST['export_contact'])){
	include 'connexion/02-contact-data-export.php';
}







include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
	DEBUT CONTENU CONTAINER
	*********************************-->
	<div class="container">
		<h1 class="text-main-blue pt-5 pb-3">Stats de connexion et de demandes magasin</h1>

		<div class="row">
			<div class="col-lg-1"></div>
			<div class="col">
				<?php
				include('../view/_errors.php');
				?>
			</div>
			<div class="col-lg-1"></div>
		</div>

		<?php
		include 'connexion/11-contact-view.php';
		?>



		<?php
		include 'connexion/10-connexion-view.php';
		?>

		<!-- ./container -->
	</div>
	<script src="../js/sortmultitable.js"></script>

	<script type="text/javascript">
		function sortTable(id,n) {
			sort_table(document.getElementById(id), n);
		}

	</script>
	<?php
	require '../view/_footer-bt.php';
?>