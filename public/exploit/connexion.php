<?php

// require('../config/autoload.php');
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	echo "pas de variable session";
	header('Location:'. ROOT_PATH.'/index.php');
}
//----------------------------------------------------------------
//			css dynamique
//----------------------------------------------------------------
$page=(basename(__FILE__));
$page=explode(".php",$page);
$page=$page[0];
$cssFile=ROOT_PATH ."/public/css/".$page.".css";


//----------------------------------------------------------------
//			DATA
//----------------------------------------------------------------

// mois en français pour affichage
$monthsFr=array("","Janvier", "Fevrier","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Decembre");
$days=array("D","L","M","M","J","V","S");
//----------------------------------------------------------------


//----------------------------------------------------------------
//			récup sélections formulaire
//			ou initialisation de valeur par défaut (mois, année actuelle)
//----------------------------------------------------------------
if(!isset($_POST['connexion']))
{
	$start=date('m');
	$end=date('m');
	$year=date('Y');
	$centrale="all";
	$magTitre="tout magasins";
}
else
{
	extract($_POST);
}
//pour passer en clé du tableeau monthFr, il faut retirer le zéro initial
//mois de début
$startForArray=$start + 0;
//mois de fin
$endForArray=$end + 0;
//nb de mois => traitement différent si 1 mois ou plus
$nbMonth= intval($end-$start +1);

// mois/année de début pour requete demande par service
$formDateServiceUn=$start."/".$year;
// mois/année de fin pour requete demande par service
$formDateServiceDeux=$end."/".$year;
//requete demande par service différente si toute centrale ou non
if($centrale=="all")
{
	$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' AND DATE_FORMAT(msg.date_msg, '%m/%Y') BETWEEN :formDate1 AND :formDate2 GROUP BY `id_service`");
	$ddServices->execute(array(
		':formDate1'	=>$formDateServiceUn,
		':formDate2'	=>$formDateServiceDeux,

	));
	//pour titre
	$centraleForTxt="toutes centrales";
	$magTitre="tout magasins";

}
elseif($magasins != "allMag")
	{
		$reqGalec=$pdoBt->prepare("SELECT * FROM sca3 WHERE mag= :magasins");
		$reqGalec->execute(array(
			':magasins'	=>$magasins
		));
		$result=$reqGalec ->fetch();
		// echo $result['galec'] . $magasins;
		$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' AND DATE_FORMAT(msg.date_msg, '%m/%Y') AND id_galec= :id_galec AND DATE_FORMAT(msg.date_msg, '%m/%Y') BETWEEN :formDate1 AND :formDate2 GROUP BY `id_service`");
		$ddServices->execute(array(
		':formDate1'	=>$formDateServiceUn,
		':formDate2'	=>$formDateServiceDeux,
		':id_galec'		=>$result['galec']
	));

		$magTitre=$magasins;
	}
else
{
	$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' AND centrale = :centrale AND DATE_FORMAT(msg.date_msg, '%m/%Y') BETWEEN :formDate1 AND :formDate2 GROUP BY `id_service`");
	$ddServices->execute(array(
		':formDate1'	=>$formDateServiceUn,
		':formDate2'	=>$formDateServiceDeux,
		':centrale'		=> $centrale

	));
	//pour titre
	$centraleForTxt=$centrale;
	$magTitre="tout magasins";

}
$resDdServices=$ddServices->fetchAll(PDO::FETCH_ASSOC);
	// echo "<pre>";
	// var_dump($resDdServices);
	// echo '</pre>';
$nbTotConn=0;
foreach ($resDdServices as $nbConn) {
	$nbTotConn = $nbTotConn + $nbConn['nb'];
}



// racourci des labels - nom de services
$shortLabel=[];
foreach ($resDdServices as $key =>$dds)
{
	if($dds['full_name']=="achats PEM GEM")
	{
		$resDdServices[$key]['full_name']="PEM GEM";
	}
	elseif($dds['full_name']=="achats gris")
	{
		$resDdServices[$key]['full_name']="gris";
	}
	elseif($dds['full_name']=="direction commerciale")
	{
		$resDdServices[$key]['full_name']="dir ciale";
	}
	elseif($dds['full_name']=="achats brun")
	{
		$resDdServices[$key]['full_name']="brun";
	}
	elseif($dds['full_name']=="communication")
	{
		$resDdServices[$key]['full_name']="comm";
	}
	elseif($dds['full_name']=="comptabilité")
	{
		$resDdServices[$key]['full_name']="compta";
	}
	elseif($dds['full_name']=="ressources humaines")
	{
		$resDdServices[$key]['full_name']="RH";
	}

	else
	{
		$resDdServices[$key]['full_name']=$dds['full_name'];
	}
}
//----------------------------------------------------------------
//			 mag connectés par mois et centrales
//----------------------------------------------------------------



//----------------------------------------------------------------
//			récup liste des mag
//----------------------------------------------------------------
	//toutes centrales
	if($centrale=="all")
	{
		$reqSca=$pdoBt->query("SELECT * FROM sca3");
		$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
	}
	//tout mag
	elseif($magasins=="allMag")
	{
		// si une centrale : récup mag de la centrale sélectionnée dans le sca3
		$reqSca=$pdoBt->prepare("SELECT * FROM sca3 WHERE centrale= :centrale");
		$reqSca->execute(array(
		 ':centrale' =>$centrale
		));
		$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
	}
	else
	{
		//uniquement un mag
		$reqSca=$pdoBt->prepare("SELECT * FROM sca3 WHERE mag= :mag");
		$reqSca->execute(array(
		 ':mag' =>$magasins
		));
		$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
	}
	// réorg tableau sous forme clé=pano galec => nom mag
	$mags=array();
	foreach ($magList as $key => $mag)
	{
		$mags[$mag['galec']]= $mag['mag'];

	}

//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-mig.php');
include('../view/_navbar.php');




?>
<div class="container">
	<h1 class="blue-text text-darken-4">Suivi des connexions et demandes magasins</h1>
	<!-- formulaire de sélection -->


	<div class="row">
		<div class="col-5">
			<div class="bgblue">
				<p class="text-white">SELECTION ACTIVE :</p>
				<div class="row no-gutters bgblue">
					<div class="col-5 bgwhite p-2"><?= strtoupper($monthsFr[$startForArray]) . ' ' .$year ?></div>
					<div class="col-2 text-white p-2 text-center">à </div>
					<div class="col-5 bgwhite p-2"><?= strtoupper($monthsFr[$endForArray]) . ' ' .$year  ?></div>
				</div>
					<div class="row no-gutters bgblue">
					<div class="col-5 bgwhite p-2"><?=  $centraleForTxt ?></div>
					<div class="col-2"></div>
					<div class="col-5 bgwhite p-2"><?= $magTitre ?></div>
				</div>
			</div>
		</div>
		<div class="col">
			<form method="post" class="border int-padding" id="affichage">
			<!-- <p>Modifier la sélection active : </p>
			<br> -->
			<div class="form-group row">
				<div class="col">
					<label>De</label>
					<select name="start" class="form-control">
						<option value="" >du mois de</option>
						<option value="01" >Janvier</option>
						<option value="02" >Février</option>
						<option value="03" >Mars</option>
						<option value="04" >Avril</option>
						<option value="05" >Mai</option>
						<option value="06" >Juin</option>
						<option value="07" >Juillet</option>
						<option value="08" >Août</option>
						<option value="09" >Septembre</option>
						<option value="10" >Octobre</option>
						<option value="11" >Novembre</option>
						<option value="12" >Décembre</option>
					</select>
				</div>
				<div class="col">
					<label>&nbsp;</label>
					<select  name="year" class="custom-select">
						<option value="2018" selected="select">2018</option>
					</select>
				</div>
				<div class="col">
					<label>A</label>
					<select name="end" class="form-control">
						<option value="" >au mois de</option>
						<option value="01" >Janvier</option>
						<option value="02" >Février</option>
						<option value="03" >Mars</option>
						<option value="04" >Avril</option>
						<option value="05" >Mai</option>
						<option value="06" >Juin</option>
						<option value="07" >Juillet</option>
						<option value="08" >Août</option>
						<option value="09" >Septembre</option>
						<option value="10" >Octobre</option>
						<option value="11" >Novembre</option>
						<option value="12" >Décembre</option>
					</select>
				</div>
				<div class="col">
					<label>&nbsp;</label>
					<select  name="year" class="custom-select">
						<option value="2018" selected="select">2018</option>
					</select>
				</div>
			</div>
			<div class="form-group row">
				<div class="col-6">
					<label>Centrale :</label>
					<select name="centrale" class="custom-select" id="centrale">
						<!-- <option value="" >Centrales</option> -->
						<option value="all" selected>Toutes centrales</option>
						<option value="LECASUD">LECASUD</option>
						<option value="SCACENTRE">SCACENTRE</option>
						<option value="SCAPALSACE">SCAPALSACE</option>
						<option value="SCAPARTOIS">SCAPARTOIS</option>
						<option value="SCAPEST">SCAPEST</option>
						<option value="SCADIF">SCADIF</option>
						<option value="SCAPNOR">SCAPNOR</option>
						<option value="SOCAMIL">SOCAMIL</option>
						<option value="SOCARA">SOCARA</option>
					</select>
				</div>
				<div class="col-6">
					<label>Magasin</label>
					<select id="magasins" name="magasins" class="custom-select">
						<option value="">magasin</option>
						<option value="allMag" selected>tout magasins</option>
					</select>
				</div>

			</div> <!-- ./form-group row -->
			<div class="form-group">
				<p class="text-right">
						<button type="submit" class="btn btn-primary" name="connexion">valider</button>
			</p>
			</div>
			</form>
		</div> <!-- ./col -->
	</div> <!-- ./row -->
	<!-- ./formulaire de sélection -->
	<br><br>
	<!-- demandes par services -->
	<div class="row">
		<div class='col'>
			<h2 class="blue-text text-darken-4 mb-5">Nombre de demandes par services </h2>

			<h3 class="text-center"><?= 'De  '. strtolower($monthsFr[$startForArray]) .' à ' . strtolower($monthsFr[$endForArray]) . ' ' .$year ." - " . $centraleForTxt ." - ". $magTitre ?> </h3>

			<div id="chartServices"></div>
		</div>
	</div>

	<!-- connexions mag -->
		<div class="row">
			<div class='col'>
				<h2 class="blue-text text-darken-4 mb-5">Connexions magasins</h2>
				<h3 class="text-center"><?= 'De  '. strtolower($monthsFr[$startForArray]) .' à ' . strtolower($monthsFr[$endForArray]) . ' ' .$year ." - " . $centraleForTxt ." - ". $magTitre ?> </h3>
			</div>
		</div>
		<?php
		//----------------------------------------------------------------
		//		CONNEXION MAG TRAITEMENT ET AFFICHAGE
		//----------------------------------------------------------------
		// if($magasins != "allMag")
		// {
		// 	echo "mag choisi" .$magasins;
		// }
		// else
		// {
		// 	echo "centrale " .$centrale;
		// }
		// echo $nbMonth;
		if($nbMonth==1)
		{
			//----------------------------------------------------------------
			//				TRAITEMENT PERIODE 1 MOIS - UNE OU PLUSIEURS CENTRALTES
			//----------------------------------------------------------------

			//date formaté pour la requete
			$formDate=$start."/".$year;
			//nb de jour dans le mois
			$nbDays= cal_days_in_month(CAL_GREGORIAN, $start, $year);
			//récup toutes les connexion réussi pour tout les utilisateurs en fonction du mois
			$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND description='user authentifié' AND DATE_FORMAT(date_heure, '%m/%Y') = :formDate ORDER BY users.galec ASC");
			$reqStat->execute(array(
				':formDate'	=>$formDate
				// ':formDate'	=>'05/2018'
			));
			$statRes=$reqStat->fetchAll(PDO::FETCH_ASSOC);
			$magArray=array();
			//permettra de comparer les pano et savoir si nouveau pano donc nvlle boucle
			$actuPano="";
			foreach ($statRes as $key => $stat)
			{
				// si le code galec des stats est trouvé dans le tableau de sca 3
				if(isset($mags[$stat['galec']]))
				{
					// exemple : 0101 - HOLDIS
					$key=$stat['galec']." - " .$mags[$stat['galec']];
					if($stat['galec']<>$actuPano)
					{
						// on commence un nouveau mag
						$actuPano= $stat['galec'];
						//on créé le "tableau mag"
						$magArray[$key]=array();
						array_push($magArray[$key], $stat['jour']);
					}
					else
					{
					//tj même mag
						array_push($magArray[$key], $stat['jour']);
					}
				}
				else
				// si le mag n'appartient pas à la centrale, on passe au pano suivant
				{
					$actuPano= $stat['galec'];
				}
			}
			//-------------------------fin de construction du tableau de résultat
			// echo "<pre>";
			// print_r($magArray);
			// echo '</pre>';

			//----------------------------------------------------------------
			//				AFFICHAGE PERIODE 1 MOIS
			//----------------------------------------------------------------

				$xlsHeader="[";
				//['titre 1','titre 2']
				echo "<div class='row'><div class='col'>";
				//force chiffre => tableau monthsFr
				$start= $start + 0;
				echo "<h3 class='blue-text text-darken-4'>". $monthsFr[$start]."</h3><br>";
				echo "<div class='nopadding'><table class='striped'><tr><td>&nbsp;</td>";
				//ligne d'entête
				for ($j=1; $j <= $nbDays ; $j++)
				{
					$xlsHeader=$xlsHeader. "'".$j ."',";
					// calcul lettre du jour dayTxt
					$jourTxt=new DateTime($year.'-'.$start .'-'.$j);
					$jourTxt=$jourTxt->format('w');
					$dayTxt=$days[$jourTxt];
					echo "<td >" . $dayTxt ."<br>".$j ." </td>";
				}
				echo $xlsHeader;
				foreach ($magArray as $pano => $jour)
				{
					echo "</tr><tr><td>".$pano ."</td>";
					for ($i=1; $i <= $nbDays ; $i++)
					{
						if(in_array($i, $jour))
						{
							echo "<td>x</td>";
						}
						else
						{
							echo "<td>&nbsp;</td>";
						}
					}
				}
				echo "</tr></table></div>";
				echo "</div></div>";
		}
		elseif($nbMonth > 1)
		{
		//----------------------------------------------------------------
		//				TRAITEMENT PERIODE PLUSIEURS MOIS - UNE OU PLUSIEURS CENTRALES
		//----------------------------------------------------------------

		//pour chaque mois, une nouvelle requete - un nouveau tableau, un nouveau traitement
		for ($k=0; $k < $nbMonth ; $k++)
		{
			//attention passage en string donc on perd le 0 initiale
			$formDate=$start + $k."/".$year;
			// rajoute le 0 initiale pour les mois infèrieurs à 10
			if($formDate < 10)
			{
				$formDate="0" .$formDate;
			}
			// $formDate=date_format($formDate,"m/Y");
			// echo $formDate;
			$formMonth=$start + $k;
			$nbDays= cal_days_in_month(CAL_GREGORIAN, $formMonth, $year);
			// echo $nbDays;
			$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND description='user authentifié' AND DATE_FORMAT(date_heure, '%m/%Y') = :formDate ORDER BY users.galec ASC");
			$reqStat->execute(array(
				':formDate'	=>$formDate
			));
			$statRes=$reqStat->fetchAll(PDO::FETCH_ASSOC);
			$magArray=array();
			$actuPano="";

			foreach ($statRes as $key => $stat)
			{
			// si le code galec des stats est trouvé dans le tableau de sca 3
				if(isset($mags[$stat['galec']]))
				{
					$key=$stat['galec']." - " .$mags[$stat['galec']];
					if($stat['galec']<>$actuPano)
					{
						$actuPano= $stat['galec'];
						$magArray[$key]=array();
						array_push($magArray[$key], $stat['jour']);
					}
					else
					{
					//tj même mag
						array_push($magArray[$key], $stat['jour']);
					}
				}
				else
				{
					$actuPano= $stat['galec'];
				}
			}

			echo "<div class='row'><div class='col'>";
			echo "<h3 class='blue-text text-darken-4'>". $monthsFr[$start + $k]."</h3><br>";
			echo "<table class='striped'><tr><td>&nbsp;</td>";
			for ($j=1; $j <= $nbDays ; $j++)
			{
				$jourTxt=new DateTime($year.'-'.($start + $k).'-'.$j);
				$jourTxt=$jourTxt->format('w');
				$dayTxt=$days[$jourTxt];
				echo "<td >" . $dayTxt ."<br>".$j ." </td>";
				// echo "<td>" .$j ."</td>";
			}
			foreach ($magArray as $pano => $jour)
			{
				echo "</tr><tr><td>".$pano ."</td>";

				for ($i=1; $i <= $nbDays ; $i++)
				{

					if(in_array($i, $jour))
					{
						echo "<td>x</td>";
					}
					else
					{
						echo "<td>&nbsp;</td>";
					}
				}
			}
			echo "</tr></table>";
			echo "</div></div>";
		}
	}
	else
	{
		echo "période incorrecte";
	}
?>




		</div>



	</div>




	<script src="https://cdn.zingchart.com/zingchart.min.js"></script>
	<script type="text/javascript">

		//liste des mags

		$(document).ready(function(){
			$('#centrale').on('change',function(){
				//réinitialise la liste sinon les selections s'ajoutent
				$('#magasins').html("<option value='allMag'>tout magasins</option>");
				var centrale =$(this).val();
				// console.log (centrale);
				if (centrale){
					$.ajax({
						type:'POST',
						url:'ajaxMag.php',
						data:'centrale='+centrale,
						success:function(html){
							$('#magasins').append(html);
						}

					});
				}
				else
				{
						$('#magasins').html("<option value='allMag'>tout magasins</option>");
				}


			});
			// $('#affichage').submit(function(){
			// 	$('#magasins').html("<option value='allMag'>tout magasins</option>");

			// });

		});

		// graphique demandes oar services
		var servicesData=[<?php
			foreach ($resDdServices as $dds) {
				echo   $dds['nb'] . ',';
			}
			?>];
			console.log(servicesData);
		var servicesLabels=[<?php
			foreach ($resDdServices as $dds) {
				echo '"'. $dds['full_name'] .'",';
			}
			?>];
			window.onload=function(){
								zingchart.render({
									id:"chartServices",
									width:1200,
									height:400,
									data:{
										"type":"bar",
										"title":{
											 "text":"Nombre total de demandes : " + <?= $nbTotConn ?>
										},
										"plot": {
											"styles":["red","#ff6666","#ff99cc","#cc99ff","#6699ff","blue"],
											"value-box": {
												"text": "%v"
											}
										},
										"scale-x":{
											"item":{
												"font-size":10
											},
											"labels":servicesLabels,
										},
										"series":[
										{
											"values":servicesData
										}
										]
									}
								});
							};


	</script>



	<?php
//----------------------------------------------------
// VIEW - FOOTER
//----------------------------------------------------
	require '../view/_footer.php';

	?>