<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	echo "pas de variable session";
	header('Location:'. ROOT_PATH.'/index.php');
}
//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";
//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
// require_once '../../vendor/autoload.php';
//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);

// nb de demande par services pour l'année en cours
// récupère le nb de messsage par service et inclu service où 0 message
function statServices($pdoBt, $startDate,$endDate){
	$critere="";
	if(isset($_POST['services'])){
		for($i=0;$i<count($_POST['services']);$i++){
			if($i==0){
				$critere.=" AND id_service= ".$_POST['services'][$i];

			}
			else{
				$critere.=" OR id_service= ".$_POST['services'][$i];

			}
		}

	}

	$req=$pdoBt->prepare("SELECT DATE_FORMAT(date_msg,'%c') as mois, DATE_FORMAT(date_msg,'%Y') as year, count(msg.id) as nb_msg, id_service, full_name, services.id as servicesid FROM msg LEFT JOIN services on services.id= id_service WHERE DATE_FORMAT(date_msg,'%Y-%m-%d') BETWEEN :startDate AND :endDate $critere GROUP BY id_service, DATE_FORMAT(date_msg,'%Y-%m-%d') ORDER BY full_name, date_msg");
	$req->execute(array(
		':startDate'	=>$startDate->format('Y-m-d'),
		':endDate' =>$endDate->format('Y-m-d')

	));
	return $req->fetchAll(PDO::FETCH_ASSOC);
	// return $req->errorInfo();
}

//listes des services qui ont une page contact (slug non vide)
function servicesToDisplay($pdoBt){
	$req=$pdoBt->query("SELECT * FROM services WHERE full_name<>'test' AND slug<>'' ORDER BY full_name");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getCentrale($pdoUser){
	$req=$pdoUser->query("SELECT * FROM mag_centrales WHERE mask=0 ORDER BY centrale");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getConnexion ($pdoStat,$startDateConn,$endDateConn){
	$req=$pdoStat->prepare("SELECT DATE_FORMAT(date_heure,'%c') as mois, DATE_FORMAT(date_heure,'%Y') as year, DATE_FORMAT(date_heure,'%e') as jour,DATE_FORMAT(date_heure,'%Y-%m-%d') as journee,id_web_user, web_users.mag.galec
		FROM stats_logs
		LEFT JOIN web_users.users ON stats_logs.id_user=web_users.users.login
		LEFT JOIN web_users.mag ON web_users.users.galec=web_users.mag.galec
		WHERE site='portail BT' AND type_log='prod' AND description='user authentifié' AND web_users.mag.galec IS NOT NULL
		-- AND (web_users.users.galec='0120' OR web_users.users.galec='0170')
		AND web_users.users.type='mag'
		AND date_heure BETWEEN :datestart AND :dateend
		GROUP BY DATE_FORMAT(date_heure,'%Y-%m-%d'),`id_web_user`
		ORDER BY centrale, deno, date_heure ");
	$req->execute([
		':datestart'		=>$startDateConn->format('Y-m-d'),
		':dateend'			=>$endDateConn->format('Y-m-d')
	]);
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getMag($pdoUser,$centraleList){
	$more=' AND (';
	for ($i=0; $i < count($centraleList) ; $i++) {
		if($i ==count($centraleList) -1){
			$more.=" id_centrale = " .$centraleList[$i] .')';
		}else{
			$more.=" id_centrale = " .$centraleList[$i] . ' OR ';

		}


	}
	$req=$pdoUser->prepare("SELECT * FROM mag LEFT JOIN mag_centrales ON mag.id_centrale=mag_centrales.id  WHERE mask=0 AND sorti=0 $more ORDER BY mag.centrale, deno");
	$req->execute();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}
//------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];

$monthsFr=array("","Janv.", "Fév.","Mars","Avril","Mai","Juin","Juil.","Août","Sept.","Oct.","Nov.","Déc.");
$days=array("D","L","M","M","J","V","S");
$centraleList=[];
$thisCentrale='';
$nbMagCentrale=0;
$nbConnCentrale=0;
if(isset($_POST['submit-service'])){
	$endDate=new DateTime($_POST['date-end']);
	$endDate->modify('last day of '.$endDate->format('M Y'));
	$startDate=new DateTime($_POST['date-start']);
}else{
	$endDate=new DateTime();
	$startDate=new DateTime('first day of january this year');
}

$stats=statServices($pdoBt,$startDate, $endDate);



$servicesList=servicesToDisplay($pdoBt);

$halfServices=ceil(count($servicesList)/3);
$countbox=0;
$sArr=[];
$period=[];


foreach ($stats as $stat) {
	// stats reorg sur année => service => mois =resultat
	$statServices[$stat['year']][$stat['full_name']][$stat['mois']]=$stat['nb_msg'];
	// 1 sous tableau par année avec les mois pour pouvoir boucler sur les année (un tableau html par année ) puis par les les mois
	if($stat['nb_msg']!=0){
		$period[$stat['year']][$stat['mois']]=0;
		// créa du tableau de service
		if(!in_array($stat['full_name'],$sArr)){
			$sArr[]=$stat['full_name'];
		}
	}

}




function getStartMonth($period){
	$arKey=array_keys($period);
	return $arKey[0];
}
function getEndMonth($period){
	$nbKeys=count($period)-1;
	$arKey=array_keys($period);
	return $arKey[$nbKeys];
}

function getLastDayOfMonth($month,$year){
	$date=(new DateTime($year.'-'.$month));
	$date=new DateTime('last day of '.$date ->format('M Y'));
	return $date->format('d');
}

$ldCentrales=getCentrale($pdoUser);

if(isset($_POST['submit-conn'])){
	if(!isset($_POST['centrales'])){
		$errors[]="merci de sélectionner une centrale";
	}else{
		for($i=0;$i<count($_POST["centrales"]);$i++){
			$centraleList[]=$_POST["centrales"][$i];
		}
		$endDateConn=new DateTime($_POST['conn-date-end']);
		$endDateConn->modify('last day of '.$endDate->format('M Y'));
		$startDateConn=new DateTime($_POST['conn-date-start']);
			echo "<pre>";
			print_r($endDateConn);
			echo '</pre>';


		echo "<pre>";
			print_r($startDateConn);
			echo '</pre>';

			echo "<pre>";
			print_r($_POST);
			echo '</pre>';
	}

}else{
	$endDateConn=new DateTime();
	$endDateConn->modify('+ 1 day');
	$startDateConn=new DateTime('first day of this month');
	foreach($ldCentrales as $centrales){
		$centraleList[]=$centrales['id'];
	}

	// $startDateConn=new DateTime('2019-08-01');

}
	// $endDateConn=new DateTime();
	// $endDateConn->modify('+ 1 day');
	// $startDateConn=new DateTime('first day of this month');

$connexions=getConnexion($pdoStat,$startDateConn,$endDateConn);
$mags=getMag($pdoUser,$centraleList);


$periodConn=[];
$magInfo=[];
foreach ($mags as $mag) {
	$magList[]=$mag['galec'];
	$magInfo[$mag['galec']]['centrale']=$mag['centrale'];
	$magInfo[$mag['galec']]['deno']=$mag['deno'];
}

// if(array_key_exists('9999',$magList)){
// 	echo 'yes';
// }else{
// 	echo 'non';
// }


foreach ($connexions as $conn) {
	$statConn[$conn['year']][$conn['mois']][$conn['galec']][$conn['jour']]=$conn['journee'];
	// $statConn[$conn['year']][$conn['mois']][$conn['galec']][$conn['jour']]['centrale']=$conn['centrale'];
	// $statConn[$conn['year']][$conn['mois']][$conn['galec']][$conn['jour']]['deno']=$conn['deno'];
	$periodConn[$conn['year']][$conn['mois']]=0;

}



// echo "<pre>";
// print_r($period);
// echo '</pre>';




//------------------------------------------------------
//			FONCTION
//------------------------------------------------------


//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container">
	<h1 class="text-main-blue pt-5 pb-3">Stats de connexion et de demandes magasin</h1>

	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>

	<div class="row">
		<div class="col">
			<h5>Demandes par services</h5>
		</div>
	</div>
	<div class="row mb-3">
		<div class="col">
			<form method="post" action="<?=$_SERVER['PHP_SELF']?>">
				<div class="row">
					<div class="col text-center text-orange">
						Filtrer par services
					</div>
				</div>
				<div class="row justify-content-around">
					<div class="col-auto">
						<?php foreach ($servicesList as $key => $service): ?>
							<?php if ($countbox==$halfServices ): ?>
								<?php $countbox=0 ?>

							</div>
							<div class="col-auto">

							<?php endif ?>
							<div class="form-check">
								<input class="form-check-input" type="checkbox" value="<?=$service['id']?>" id="<?=$service['id']?>" name="services[]">
								<label class="form-check-label" for="<?=$service['id']?>"><?=$service['full_name']?></label>
							</div>
							<?php $countbox++ ?>
						<?php endforeach ?>
					</div>
				</div>
				<div class="row">
					<div class="col text-center text-orange">
						Changer la période
					</div>
				</div>
				<div class="row  justify-content-center">
					<div class="col-md-6 col-lg-4 col-xl-3">
						<div class="form-group">
							<label for="date-start">Du mois de</label>
							<input type="month" class="form-control" id="date-start" min="2018-01" max="<?=date('Y-m')?>" name="date-start" value="<?=$startDate->format('Y-m')?>">
						</div>
					</div>
					<div class="col-md-6 col-lg-4 col-xl-3">
						<div class="form-group">
							<label for="date-end">Au mois de </label>
							<input type="month" class="form-control" id="date-end" name="date-end" value="<?=$endDate->format('Y-m')?>">
						</div>
					</div>
					<div class="col-md-6 col-lg-4 col-xl-3 mt-4 pt-2 text-right">
						<button class="btn btn-primary" name="submit-service" type="submit">Afficher</button>
					</div>
				</div>


			</form>


		</div>
	</div>


	<?php for($yearIndex=$startDate->format('Y'); $yearIndex<count($statServices)+$startDate->format('Y'); $yearIndex++): ?>
	<?= $yearIndex?>
	<div class="row ">
		<div class="col">
			<table class="table table-sm table-striped table-responsive-md servicetable" id="services<?= $yearIndex?>">
				<thead>
					<tr>
						<th class="sortable" onclick="sortTable(0);">Services</th>
						<!-- ./table -->
						<?php for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++): ?>
						<th class="text-right sortable" onclick="sortTable('services<?= $yearIndex?>',<?=$month?>);"><?=$monthsFr[$month]?></th>
					<?php endfor ?>
					<th class="text-right sortable" onclick="sortTable('services<?= $yearIndex?>',<?=$month?>);">TOTAL</th>
				</tr>
			</thead>
			<?php
			$newService='';
			$sumPerMonth=[];

			for($i=0;$i<count($sArr);$i++){
				for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++){

					if($sArr[$i]!=$newService){
						echo '</tr>';
						echo '<tr>';
						echo '<td class="text-right">'.$sArr[$i].'</td>';
						$newService=$sArr[$i];
						$sommeService=0;

					}
					if(isset($statServices[$yearIndex][$sArr[$i]][$month])){

						echo '<td class="text-right">'. $statServices[$yearIndex][$sArr[$i]][$month] .'</td>';
						$sommeService=$sommeService+$statServices[$yearIndex][$sArr[$i]][$month];
						// on en profite pour calculer la somme par mois en créant un nouveau tableau indexé par le numéro de mois
						// à chaque fois que nécessaire
						if(isset($sumPerMonth[$month])){
							$sumPerMonth[$month]+=$statServices[$yearIndex][$sArr[$i]][$month];
						}else{
							$sumPerMonth[$month]=$statServices[$yearIndex][$sArr[$i]][$month];

						}

					}else{
						echo '<td class="text-right">0</td>';
					}
					if($month==getEndMonth($period[$yearIndex])){
						echo '<td class="text-right font-weight-bold" >'.$sommeService.'</td>';
					}
				}

			}

			?>
		</tr>
		<tfoot>
			<tr class="font-weight-bold">
				<td class="text-right">TOTAL</td>
				<?php for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++): ?>
				<td class="text-right"><?=$sumPerMonth[$month]?></td>
			<?php endfor?>
			<td class="text-right"><?=array_sum($sumPerMonth)?></td>
		</tr>
	</tfoot>
</table>
</div>
</div>
<?php endfor ?>

<div class="row">
	<div class="col">
		<h5>Connexions magasin</h5>
	</div>
</div>

<div class="row mb-3">
	<div class="col">
		<form method="post" action="<?=$_SERVER['PHP_SELF']?>">
			<div class="row">
				<div class="col">
					<div class="form-group">
						<select name="centrales[]" id="centrales" class="form-control" multiple>
							<?php foreach ($ldCentrales as $key => $centrale): ?>
								<?php if (in_array($centrale['id'],$_POST['centrales'])) {
									$selected="selected";
								}else{
									$selected="";
								}


								?>

								<option value="<?=$centrale['id']?>" <?=$selected?>><?=$centrale['centrale']?></option>
							<?php endforeach ?>
						</select>
					</div>
				</div>
				<div class="col-md-6 col-lg-4 col-xl-3">
					<div class="form-group">
						<label for="conn-date-start">Du mois de</label>
						<input type="month" class="form-control" id="conn-date-start" min="2018-01" max="<?=date('Y-m')?>" name="conn-date-start" value="<?=$startDateConn->format('Y-m')?>">
					</div>
				</div>
				<div class="col-md-6 col-lg-4 col-xl-3">
					<div class="form-group">
						<label for="conn-date-end">Au mois de </label>
						<input type="month" class="form-control" id="conn-date-end" name="conn-date-end" value="<?=$endDateConn->format('Y-m')?>">
					</div>
				</div>
				<div class="col-md-6 col-lg-4 col-xl-3 mt-4 pt-2 text-right">
					<button class="btn btn-primary" name="submit-conn" type="submit">Afficher</button>
				</div>
			</div>
		</form>
	</div>
</div>


<!-- une année par tableau donc nb année = taille tableau -->
<?php for($yearIndex=$startDateConn->format('Y'); $yearIndex<count($statConn)+$startDateConn->format('Y'); $yearIndex++): ?>
<?php for($month=getStartMonth($periodConn[$yearIndex]);$month<=getEndMonth($periodConn[$yearIndex]);$month++): ?>
<h5><?= $monthsFr[$month].' ' .$yearIndex ?></h5>
<?php
// echo "<pre>";
// print_r($statConn[$yearIndex][$month]);
// echo '</pre>';

?>
<table class="table-sm table-striped table-bordered">
	<tr>
		<th>mag</th>
		<th>mag</th>
		<th>mag</th>
		<?php for($day=1;$day<= getLastDayOfMonth($month,$yearIndex);$day++):?>
			<th><?=$day?></th>
		<?php endfor ?>
		<th>T</th>

	</tr>
	<?php for($i=0;$i<count($magList);$i++):?>
		<?php
		$daysInMonth=getLastDayOfMonth($month,$yearIndex);
		// nb colonne = nb jour + mag +centrale, +agelc +total
		$nbCol=$daysInMonth+4;
		if($thisCentrale==$magInfo[$magList[$i]]['centrale'])
		{

		}
		elseif($thisCentrale==''){
			$nbMagCentrale=0;
			$nbConnCentrale=0;
		}
		else{

			echo '<tr class="sum"><td colspan="'. $nbCol .'">En '.$thisCentrale . ', ' .$nbConnCentrale.' sur '.$nbMagCentrale.' magasins se sont connectés au moins une fois dans le mois </td></tr>';
			$nbMagCentrale=0;
			$nbConnCentrale=0;
		}
		?>

		<tr>
			<td><?= $magList[$i]?></td>
			<td class="deno"><?= strtolower($magInfo[$magList[$i]]['deno'])?></td>
			<td class="deno"><?= strtolower($magInfo[$magList[$i]]['centrale'])?></td>
			<!-- si stat pour le mag -->
			<?php
			$magCon=0;
			$nbMagCentrale++;
			if(in_array($magList[$i],array_keys($statConn[$yearIndex][$month]))){
				// magasin qui se connecte danc on ajoute une fois avant de parcourir les jours
				$nbConnCentrale++;
				for($day=1;$day<= $daysInMonth;$day++){
					if (isset($statConn[$yearIndex][$month][$magList[$i]][$day])){
						echo '<td class="connection">'.$day.'</td>';
						$magCon++;
					}else{
						echo '<td class="no-connection">&nbsp;</td>';
					}
				}
			}else{
				for($day=1;$day<= getLastDayOfMonth($month,$yearIndex);$day++){
					echo '<td class="no-connection">&nbsp;</td>';
				}
			}
			echo '<td>'.$magCon.'</td>';
			echo '</tr>';
			$thisCentrale=$magInfo[$magList[$i]]['centrale'];
			?>

		<?php endfor ?>

			<tr class="sum"><td colspan="<?=$nbCol?>">En <?=$thisCentrale.', ' .$nbConnCentrale .' sur '.$nbMagCentrale ?> magasins se sont connectés au moins une fois dans le mois</td></tr>
			<?php

$nbConnCentrale=0;
$nbMagCentrale=0;
			 ?>
	</table>
<?php endfor ?>

<?php endfor ?>






<!-- ./container -->
</div>
<script src="../js/sortmultitable.js"></script>

<script type="text/javascript">


	function sortTable(id,n) {
		sort_table(document.getElementById(id), n);
	}




</script>
<?php
require '../view/_footer-bt.php';
?>