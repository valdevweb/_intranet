<?php

 // require('../../config/pdo_connect.php');
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	echo "pas de variable session";
	header('Location:'. ROOT_PATH.'/index.php');
}
/*----------------------------------------------------------------
			FONCTIONNALITES
----------------------------------------------------------------
#1 : formulaire : mois, années, centrales, magasins (ajax)
#2 : nb de demandes par services - graphique - période et centrales liées au formulaire
#3 : tableau demande par services sur l'année en cours
#4 : formulaire choix année (par défaut année courante)
#5 : export xl tableau annuel ddes mag par services
#6 : tableau connexion mag par jour (%formulaire #1)
#7 : extraction xl connexion mag par jour
 */

//----------------------------------------------------------------
//			DEPENDANCES
//----------------------------------------------------------------

require '../../vendor/autoload.php';

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;
//----------------------------------------------------------------
//			css dynamique
//----------------------------------------------------------------
$page=(basename(__FILE__));
$page=explode(".php",$page);
$page=$page[0];
// $cssFile=ROOT_PATH ."/public/css/connexion.css";
$cssFile=ROOT_PATH ."/public/css/".$page.".css";

//----------------------------------------------------------------
//			DATA
//----------------------------------------------------------------

$monthsFr=array("","Janvier", "Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Decembre");
$days=array("D","L","M","M","J","V","S");
//nom colonne pour excel
$col=array("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","AA","AB","AC","AD","AE","AF","AG","AH","AI","AJ");


// #1
//----------------------------------------------------------------
//			récup sélections formulaire
//			ou initialisation de valeur par défaut (mois, année actuelle)
//----------------------------------------------------------------
if(!isset($_POST['connexion']))
{
	//valeur par défaut = mois et année en cours, toutes centrales
	$start=date('m');
	$end=date('m');
	$year=date('Y');
	$centrale="all";
	$magTitre="";
}
else
{
	extract($_POST);
}

/*-----------------------------------------------------------------------------------------------

#2 REQUETES NB DE DEMANDES PAR SERVICES EN FONCTION DU RETOUR DU FORMULAIRE => alimente le graphique

----------------------------------------------------------------------------------------------*/
// mois/année de début pour requete demande par service
$formDateServiceUn=$start."/".$year;
// mois/année de fin pour requete demande par service
$formDateServiceDeux=$end."/".$year;
//requete demande par service différente si toute centrale ou non
if($centrale=="all")
{
	$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' AND DATE_FORMAT(msg.date_msg, '%m/%Y') BETWEEN :formDate1 AND :formDate2 GROUP BY `id_service`");
	$ddServices->execute(array(
		':formDate1'	=>$formDateServiceUn,
		':formDate2'	=>$formDateServiceDeux,

	));
	//pour titre
	$centraleForTxt="toutes centrales";
}
// un seul mag
elseif($magasins != "allMag")
{
	$reqGalec=$pdoBt->prepare("SELECT * FROM sca3 WHERE mag= :magasins");
	$reqGalec->execute(array(
		':magasins'	=>$magasins
	));
	$result=$reqGalec ->fetch();
	$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' AND DATE_FORMAT(msg.date_msg, '%m/%Y') AND id_galec= :id_galec AND DATE_FORMAT(msg.date_msg, '%m/%Y') BETWEEN :formDate1 AND :formDate2 GROUP BY `id_service`");
	$ddServices->execute(array(
		':formDate1'	=>$formDateServiceUn,
		':formDate2'	=>$formDateServiceDeux,
		':id_galec'		=>$result['galec']
	));
	$centraleForTxt =$magasins;

}
//une centrale
else
{
	$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' AND centrale = :centrale AND DATE_FORMAT(msg.date_msg, '%m/%Y') BETWEEN :formDate1 AND :formDate2 GROUP BY `id_service`");
	$ddServices->execute(array(
		':formDate1'	=>$formDateServiceUn,
		':formDate2'	=>$formDateServiceDeux,
		':centrale'		=> $centrale

	));
	//pour titre
	$centraleForTxt=$centrale;
}
$resDdServices=$ddServices->fetchAll(PDO::FETCH_ASSOC);

$nbTotConn=0;
foreach ($resDdServices as $nbConn)
{
	$nbTotConn = $nbTotConn + $nbConn['nb'];
}
// racourci des labels - nom de services  pour graphque
foreach ($resDdServices as $key =>$dds)
{
	if($dds['full_name']=="achats PEM GEM")
	{
		$resDdServices[$key]['full_name']="PEM GEM";
	}
	elseif($dds['full_name']=="achats gris")
	{
		$resDdServices[$key]['full_name']="gris";
	}
	elseif($dds['full_name']=="direction commerciale")
	{
		$resDdServices[$key]['full_name']="dir ciale";
	}
	elseif($dds['full_name']=="achats brun")
	{
		$resDdServices[$key]['full_name']="brun";
	}
	elseif($dds['full_name']=="communication")
	{
		$resDdServices[$key]['full_name']="comm";
	}
	elseif($dds['full_name']=="comptabilité")
	{
		$resDdServices[$key]['full_name']="compta";
	}
	elseif($dds['full_name']=="ressources humaines")
	{
		$resDdServices[$key]['full_name']="RH";
	}

	else
	{
		$resDdServices[$key]['full_name']=$dds['full_name'];
	}
}


/*-----------------------------------------------------------------------------------------------

TITRES (h3) ET NOM DE FICHIER EN FONCTION DES SELECTION DU FORMULAIRE

----------------------------------------------------------------------------------------------*/
//pour passer en clé du tableeau monthFr, il faut retirer le zéro initial => on converti en integer en ajoutant 0
//mois de début
$startForArray=$start + 0;
//mois de fin
$endForArray=$end + 0;
// un mois
if($monthsFr[$startForArray]==$monthsFr[$endForArray])
{
	$xlFileTitle= "connexions magasin - " .$centraleForTxt . ' - ' .$monthsFr[$startForArray] . ' ' .$year. '.xlsx';
	$hTitle = $monthsFr[$startForArray] . ' ' .$year ." - " . $centraleForTxt;
	$hService ="nb de demandes par service - ".$monthsFr[$startForArray] . ' ' .$year;

}
//plusieurs mois
else
{
	$xlFileTitle= "connexions magasin - " .$centraleForTxt . ' - ' .$monthsFr[$startForArray] .' - ' . $monthsFr[$endForArray] . ' ' .$year. '.xlsx';
	$hTitle ='De ' . $monthsFr[$startForArray] .' à ' . $monthsFr[$endForArray] . ' ' .$year ." - " . $centraleForTxt;
	$hService ="nb de demandes par service - ".$monthsFr[$startForArray] .' à ' . $monthsFr[$endForArray] . ' ' .$year;

}
/*-----------------------------------------------------------------------------------------------

#3 GENERATION DU FICHIER XLS ET DU TABLEAU HTML DE NB DE DEMANDES PAR SERVICES

----------------------------------------------------------------------------------------------*/
/*---------------------------------------------------------------------
#4 traitement de l'année : soit année par défaut soit celle du formulaire
---------------------------------------------------------------------*/

if(isset($_POST['form_services']) && isset($_POST['annee_services']))
{
$annee=$_POST['annee_services'];
}
else
{
// par défaut on affiche l'année en cours
$annee=date('Y');
}
$listYears=[];

for ($firstYear=2018; $firstYear <=date('Y') ; $firstYear++) {
	array_push($listYears,$firstYear);
}


// #3
// récupère le nb de messsage par service et inclu service où 0 message
function statServices($pdoBt, $mois,$annee,$idservice)
{
$req=$pdoBt->prepare("SELECT DATE_FORMAT(date_msg,'%c') as mois, DATE_FORMAT(date_msg,'%Y') as year, count(msg.id) as nb_msg, id_service, full_name FROM msg LEFT JOIN services on services.id= id_service WHERE id_service= :idservice AND DATE_FORMAT(date_msg,'%c')= :mois AND DATE_FORMAT(date_msg,'%Y')= :annee ");
$req->execute(array(
	':mois'	=>$mois,
	':annee' =>$annee,
	':idservice'	=>$idservice

));
return $req->fetchAll(PDO::FETCH_ASSOC);
}

//listes des services qui ont une page contact (slug non vide)
function servicesToDisplay($pdoBt){
	$req=$pdoBt->query("SELECT * FROM services WHERE full_name<>'test' AND slug<>'' ORDER BY id");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}
$servicesList=servicesToDisplay($pdoBt);

//-----------------------------
//initialisation des tableaux qui seront alimenté par la boucle sur la liste de service. Cette boucle appelant la function stat Service pour chaque service
// clés = numéro de mois
$serviceByMonth=[];
//array qui récupère infos pour boucler sur id_services
$serviceById=[];
// tableau de service array[id_service]=full_name
$indexService=[];
$currentMonth=date('n');

foreach ($servicesList as $servicesUtiles)
{
	$indexService[$servicesUtiles['id']]=$servicesUtiles['full_name'];
	for ($mois=1; $mois<=$currentMonth  ; $mois++)
	{

		$allService=statServices($pdoBt, $mois,$annee, $servicesUtiles['id']);
		foreach($allService as $thisService)
		{
			if($thisService['nb_msg']==0){
				$serviceByMonth[$mois][$servicesUtiles['id']]['full_name']=$servicesUtiles['full_name'];
				$serviceByMonth[$mois][$servicesUtiles['id']]['nb_msg']=0;
				$serviceById[$servicesUtiles['id']][$mois]=0;

			}
			else
			{
				$serviceByMonth[$mois][$servicesUtiles['id']]['full_name']=$thisService['full_name'];
				$serviceByMonth[$mois][$servicesUtiles['id']]['nb_msg']=$thisService['nb_msg'];
				$serviceById[$servicesUtiles['id']][$mois]=$thisService['nb_msg'];
			}
		}
	}
}
	/*-----------------------------------------------------------------------------------------------

	#5 GENERATION DU FICHIER XLS DE NB DE DEMANDES PAR SERVICES

	 ----------------------------------------------------------------------------------------------*/
	$classeurServices= new Spreadsheet();
	$feuil= $classeurServices->getActiveSheet();
	$filenameServices =$year. " - nb de demandes par service"  . '.xlsx';

	/*----------------------------------------------
	ligne de titre avec les mois
	 ----------------------------------------------*/
	$feuil->setCellValue('A1',"Services");
	$indexCol=1;//B
	foreach ($serviceByMonth as $key => $value)
	{
		$ligUn=1;
		$feuil->setCellValue($col[$indexCol].$ligUn,$monthsFr[$key]);
		$indexCol++;
	}
	$feuil->setCellValue($col[$indexCol].$ligUn,"total");

	/*----------------------------------------------
	colonne avec nom services
	 ----------------------------------------------*/
	$ligServices=2;
	foreach ($indexService as $nomService) {
		$feuil->setCellValue($col[0].$ligServices,$nomService);
		$ligServices++;
	}

	/*----------------------------------------------
	ligne par ligne, on affiche pour chaque mois le nombre de messages
	 ----------------------------------------------*/
	$sommeMois=[];
	$sommeAnnee=0;
	$ligXl=2;
	//affichage : un ligne par service en en colonne les mois
	foreach ($serviceById as $key => $value)
	{
		$sommeService=0;
		//on utilise la valeur de mois pour changer de colonne. On commence à 1 cad B
		for ($mois=1; $mois<=$currentMonth  ; $mois++)
		{

			$feuil->setCellValue($col[$mois].$ligXl,$value[$mois]);
			$sommeService=$sommeService +$value[$mois];
			$sommeMois[$mois]=$sommeMois[$mois]+$value[$mois];
		}
		//on avance d'une colonne pour écrire le total de la ligne (service)
		$feuil->setCellValue($col[$mois].$ligXl,$sommeService);
		$sommeAnnee=$sommeAnnee+$sommeService;
		// ligne suivante
		$ligXl++;
	}
	/*----------------------------------------------
	ligne des totaux
	 ----------------------------------------------*/
	$feuil->setCellValue($col[0].$ligXl,"Total");
	for ($mois=1; $mois<=$currentMonth  ; $mois++)
	{
		$feuil->setCellValue($col[$mois].$ligXl,$sommeMois[$mois]);
		$feuil->getColumnDimension($col[$indexCol])->setAutoSize(true);
	}
	/*----------------------------------------------
	total annuel
	 ----------------------------------------------*/
	$feuil->setCellValue($col[$mois].$ligXl,$sommeAnnee);
	$w=new Xlsx($classeurServices);
	$w->save($filenameServices);


/*-----------------------------------------------------------------------------------------------

	#6 MAG CONNECTES PAR MOIS ET PAR CENTRALE

----------------------------------------------------------------------------------------------*/


//----------------------------------------------------------------
//			LISTE DES MAGS
//
// 3 CAS - 3 requetes : tous les mag (pas de centrale choisi centrale= all) - une centrale choisi mais pas de mag en particulier (magasins = allmag) - un mag choisi
//----------------------------------------------------------------

/*--------------------------------------------
	REQUETES => $magList
 ---------------------------------------------*/

//toutes centrales
if($centrale=="all")
{
	$reqSca=$pdoBt->query("SELECT * FROM sca3 WHERE galec<>'' AND LEFT(mag,3)<>'***'  AND LEFT(mag,2)<>'**'  AND LEFT(mag,3)<>'xxx' AND LEFT(mag,3)<>'SCA' AND centrale <>'SLOVENIE' ORDER BY galec");
	$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
}
//tout mag
elseif($magasins=="allMag")
{
		// si une centrale : récup mag de la centrale sélectionnée dans le sca3
	$reqSca=$pdoBt->prepare("SELECT * FROM sca3 WHERE galec<>''AND LEFT(mag,3)<>'***' AND LEFT(mag,3)<>'xxx' AND centrale= :centrale ORDER BY galec");
	$reqSca->execute(array(
		':centrale' =>$centrale
	));
	$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
}
else
//uniquement un mag
{
	$reqSca=$pdoBt->prepare("SELECT * FROM sca3 WHERE mag= :mag");
	$reqSca->execute(array(
		':mag' =>$magasins
	));
	$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
}

/*--------------------------------------------
	REORG DE $magList en Smag
 ---------------------------------------------*/
// clé = pano galec =>name (nom du mag)
// 					=>centrale
// 					=>btlec
$mags=array();
foreach ($magList as $key => $magasins)
{
	//  DUMM !!!!!! if($magasins['centrale']==$centrale || $centrale=="all")
		$mags[$magasins['galec']]['name']= $magasins['mag'];
		$mags[$magasins['galec']]['centrale']= $magasins['centrale'];
		$mags[$magasins['galec']]['btlec']= $magasins['btlec'];

}

//------------------------------------------------------
//		function utilisé dans le tableau xls pour le calcul des sommmes
//------------------------------------------------------

function colSum($xlTitle,$col,$ligne){
	$colonne=$col[$xlTitle];
	$firstCell=$colonne .'3';
	$lastRow=$ligne -1;
	$lastCell=$colonne.$lastRow;
	$dayFormula="=SUM(".$firstCell.":".$lastCell.")";
	return $dayFormula;
}

//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-mig.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
 *********************************-->
<div class="container">
	<h1 class="blue-text text-darken-4">Suivi des connexions et demandes magasins</h1>

	<!-- ****************************************************************************
		#3 AFFICHAGE TABLEAU DES DEMANDES MAG PAR MOIS ET SERVICES SUR L'ANNEE EN COURS
	 ******************************************************************************-->
	<div class="row">
		<div class='col-1'></div>
		<div class='col'>
			<h2 class="blue-text text-darken-4 mb-5">Nombre de demandes par services </h2>

			<h3 class="text-center pb-5">Demandes par services sur l'année en cours </h3>
			<table class='striped' id="tableservice">
				<tr>
					<th >Service</th>
					<?php
					for ($mois=1; $mois<=$currentMonth  ; $mois++)
					{
						echo '<th class="text-right">'.$monthsFr[$mois].'</th>';
					}
					?>
					<th class="text-right">Total</th>
					</tr>
					<?php
						$sommeMois=[];
						$sommeAnnee=0;
						// x= mois / y= services
						foreach ($serviceById as $key => $value)
						{
							$sommeService=0;
							echo "<tr><td>" .$indexService[$key]."</td>";
							for ($mois=1; $mois<=$currentMonth  ; $mois++)
							{
								echo ' <td class="text-right"> '.$value[$mois] .'</td> ';
								$sommeService=$sommeService +$value[$mois];
								$sommeMois[$mois]=$sommeMois[$mois]+$value[$mois];
							}
							echo '<td class="text-right">'.$sommeService.'</td>';
							echo '</tr>';
							$sommeAnnee=$sommeAnnee+$sommeService;
						}
						echo "<tr><td>Total</td>";
						for ($mois=1; $mois<=$currentMonth  ; $mois++){
							echo '<td class="text-right">'.$sommeMois[$mois].'</td>';
						}
						echo '<td class="text-right">'.$sommeAnnee.'</td>';
					 ?>
					</tr>
				</table>

			</div>
			<div class='col-1'></div>
		</div>
	<!-- ****************************************************************************
		#4 FORMULAIRE POUR CHANGER L'ANNEE DU TABLEAU NB MSG MAG
	 ******************************************************************************-->
		 <div class="row">
			<!-- #5 lien  pour l'export -->
		 	<div class="col">
				<h5><i class="fa fa-download fa-lg px-3 my-4 blue-text" aria-hidden="true"></i><a class="blue-text" href="<?=$filenameServices?>">Exporter</a></h5>
	 		</div>
	 	<div class="col-2">
	 		<form method="post">
	 			<div class="form-group">
	 				<!-- <label for="exampleFormControlSelect1">Example select</label> -->
	 				<select class="form-control" name="annee_services">
	 					<option value="">année</option>
	 					<?php
	 					for($a=0;$a < sizeof($listYears); $a++)
	 					{
	 						echo "<option value='".$listYears[$a]."'";
	 						if(isset($annee) && $annee==$listYears[$a])
	 						{
	 							echo "selected='select'";
	 						}
	 						echo ">".$listYears[$a] ."</option>";

	 					}
	 					?>
	 				</select>
	 			</div>
	 			<div class="form-group">
	 				<p class="text-right">
	 					<button type="submit" id="main-form" class="btn btn-primary" name="form_services">Choisir</button>
	 				</p>
	 			</div>
	 		</form>

	 		<div class="col-2"></div>
	 	</div>
	 </div>



	<!-- ********************************
		#1 formulaire de sélection
	 *********************************-->
	   <div class="row">
	 	<div class="col-1"></div>
	 	<div class="col">

			<h2 class="blue-text text-darken-4 mb-5">Formulaire de sélection pour les demandes et les connexions magasins</h2>
		</div>
	</div>
	<div class="row">
		<div class="col-6 border int-padding">
			<p>Modifier la sélection : </p>
			<form method="post" class="" id="affichage">
				<div class="form-group row">
					<div class="col">
						<select name="start" class="form-control">
							<option value="" >du mois de</option>
							<option value="01" <?php if(isset($start) && $start=='01') echo "selected='select'";?> >Janvier</option>
							<option value="02" <?php if(isset($start) && $start=='02') echo "selected='select'";?> >Février</option>
							<option value="03" <?php if(isset($start) && $start=='03') echo "selected='select'";?> >Mars</option>
							<option value="04" <?php if(isset($start) && $start=='04') echo "selected='select'";?> >Avril</option>
							<option value="05" <?php if(isset($start) && $start=='05') echo "selected='select'";?> >Mai</option>
							<option value="06" <?php if(isset($start) && $start=='06') echo "selected='select'";?> >Juin</option>
							<option value="07" <?php if(isset($start) && $start=='07') echo "selected='select'";?> >Juillet</option>
							<option value="08" <?php if(isset($start) && $start=='08') echo "selected='select'";?> >Août</option>
							<option value="09" <?php if(isset($start) && $start=='09') echo "selected='select'";?> >Septembre</option>
							<option value="10" <?php if(isset($start) && $start=='10') echo "selected='select'";?> >Octobre</option>
							<option value="11" <?php if(isset($start) && $start=='11') echo "selected='select'";?> >Novembre</option>
							<option value="12" <?php if(isset($start) && $start=='12') echo "selected='select'";?> >Décembre</option>
						</select>
					</div>
					<div class="col">
						<select  name="year" class="custom-select">
							<option value="2018" selected="select">2018</option>
						</select>
					</div>
					<div class="col">
						<select name="end" class="form-control">
							<option value="" >au mois de</option>
							<option value="01" <?php if(isset($end) && $end=='01') echo "selected='select'";?> >Janvier</option>
							<option value="02" <?php if(isset($end) && $end=='02') echo "selected='select'";?> >Février</option>
							<option value="03" <?php if(isset($end) && $end=='03') echo "selected='select'";?> >Mars</option>
							<option value="04" <?php if(isset($end) && $end=='04') echo "selected='select'";?> >Avril</option>
							<option value="05" <?php if(isset($end) && $end=='05') echo "selected='select'";?> >Mai</option>
							<option value="06" <?php if(isset($end) && $end=='06') echo "selected='select'";?> >Juin</option>
							<option value="07" <?php if(isset($end) && $end=='07') echo "selected='select'";?> >Juillet</option>
							<option value="08" <?php if(isset($end) && $end=='08') echo "selected='select'";?> >Août</option>
							<option value="09" <?php if(isset($end) && $end=='09') echo "selected='select'";?> >Septembre</option>
							<option value="10" <?php if(isset($end) && $end=='10') echo "selected='select'";?> >Octobre</option>
							<option value="11" <?php if(isset($end) && $end=='11') echo "selected='select'";?> >Novembre</option>
							<option value="12" <?php if(isset($end) && $end=='12') echo "selected='select'";?> >Décembre</option>
						</select>
					</div>
					<div class="col">
						<select  name="year" class="custom-select">
							<option value="2018" selected="select">2018</option>
						</select>
					</div>
				</div>
				<div class="form-group row">
					<div class="col-6">
						<select name="centrale" class="custom-select" id="centrale">
							<option value="all">Toutes centrales</option>
							<option value="LECASUD" >LECASUD</option>
							<option value="SCACENTRE"  >SCACENTRE</option>
							<option value="SCAPALSACE" >SCAPALSACE</option>
							<option value="SCAPARTOIS">SCAPARTOIS</option>
							<option value="SCAPEST">SCAPEST</option>
							<option value="SCADIF" >SCADIF</option>
							<option value="SCAPNOR">SCAPNOR</option>
							<option value="SOCAMIL">SOCAMIL</option>
							<option value="SOCARA">SOCARA</option>
						</select>
					</div>
					<div class="col-6">
						<div id="mag-drop">
							<select id="magasins" name="magasins" class="custom-select">
								<option value='allMag'>tout magasins</option>
							</select>
						</div>
					</div>
				</div> <!-- ./form-group row -->
				<div class="form-group">
					<p class="text-right">
						<button type="submit" id="main-form" class="btn btn-primary" name="connexion">valider</button>
					</p>
				</div>
			</form>
		</div> <!-- ./col -->
		<div class="col-6"></div>
	</div> <!-- ./row  FIN FORMULAIRE DE SELECTION-->
	<br><br>
	<!-- ********************************************************************
		#2 AFFICHAGE GRAPH DES DEMANDES PAR SERVICES ( % données du formulaire)
	 *********************************************************************-->
	<div class="row">
		<div class='col'>
			<h2 class="blue-text text-darken-4 mb-5">Nombre de demandes par services </h2>
			<h3 class="text-center"><?= $hTitle ?> </h3>
			<!--
			EMPLACEMENT DU GRAPHQIUE
			  -->
			<div id="chartServices"></div>
		</div>
	</div>
		<!-- ****************************************************************************
		#6 TABLEAU DES CONNEXIONS MAG PAR JOURS % formulaire
	 ******************************************************************************-->
	<!-- #7lien  pour l'export -->
	<div class="row">
		<div class='col'>
			<h2 class="blue-text text-darken-4 my-5">Connexions magasins</h2>
			<h5><i class="fa fa-download fa-lg px-3 mb-4 blue-text" aria-hidden="true"></i>Exporter la sélection : <a class="blue-text" href="<?=$xlFileTitle?>"><?= $xlFileTitle ?></a></h5>
			<h3 class="text-center"><?= $hTitle ?> </h3>
		</div>
	</div>
	<?php
	/*----------------------------------------------------------------------

	#6 REQUETES => $statRes

	----------------------------------------------------------------------*/
	/*---------------------------------------------------------------------
	2 cas -> un mois, plusieurs mois
	recup sur un ou plusieurs mois les connexion réussies (user authentifié)
	ATTENTION : récup tous les mag sans tenir compte des entrées du formulaire
	----------------------------------------------------------------------*/


	/*--------------------------------------
		UN MOIS
	 ---------------------------------------*/
	$nbMonth= intval($end-$start +1);
	if($nbMonth==1)
	{
		//date formaté pour la requete
		$formDate=$start."/".$year;
		//nb de jour dans le mois
		$nbDays= cal_days_in_month(CAL_GREGORIAN, $start, $year);
			//récup toutes les connexion réussies pour tout les utilisateurs en fonction du mois
		$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, DATE_FORMAT(date_heure, '%m') as mois, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND description='user authentifié' AND site='portail BT' AND DATE_FORMAT(date_heure, '%m/%Y') = :formDate ORDER BY users.galec ASC");
		$reqStat->execute(array(
			':formDate'	=>$formDate
		));
		$statRes=$reqStat->fetchAll(PDO::FETCH_ASSOC);
		/*--------------------------------------------
		REORG DE $statRes en SstatArr
		---------------------------------------------*/
		// clé = pano galec =>name (nom du mag)
		// 					=>centrale
		// 					=>jour[jour]=jour

		$statArr=[];
		$actuGalec="";
		foreach ($statRes as $key => $stat)
		{
			// si mag des stats est dans la liste du sca3
			if(isset($mags[$stat['galec']]))
			{
				if($stat['galec']!=$actuGalec)
				{
					$statArr[$stat['galec']]['name']=$mags[$stat['galec']]['name'];
					$statArr[$stat['galec']]['centrale']=$mags[$stat['galec']]['centrale'];
					$statArr[$stat['galec']]['jour'][$stat['jour']]=$stat['jour'];
					$actuGalec=$stat['galec'];
				}
				else
				{
					$statArr[$stat['galec']]['jour'][$stat['jour']]=$stat['jour'];
				}

			}
		}

		//ajout des mag qui ne se sont pas connectés mais qui sont dans la centrale sélectionnée
		foreach ($mags as $key => $value)
		{
			if(!isset($statArr[$key]))
			{
				// echo "missing " .$key .$mags[$key]['name']."<br>";
				$statArr[$key]['name']=$mags[$key]['name'];
				$statArr[$key]['centrale']=$mags[$key]['centrale'];
				$statArr[$key]['jour']="";

			}
		}
		//trie tableau par pano galec
		ksort($statArr);
		//----------------------------------------------------------------
		//				AFFICHAGE PERIODE 1 MOIS
		//----------------------------------------------------------------
		echo "<div class='row'><div class='col'>";
				//force chiffre => tableau monthsFr
		$start= $start + 0;
		echo "<h3 class='blue-text text-darken-4'>". $monthsFr[$start]."</h3><br>";
		echo "<div class='nopadding'><table class='striped' id='tableconnexion'><tr><td>Galec</td><td>Magasin</td><td>Centrale</td>";
				//ligne d'entête
		for ($j=1; $j <= $nbDays ; $j++)
		{
					// $xlsHeader=$xlsHeader. "'".$j ."',";
					// calcul lettre du jour dayTxt
			$jourTxt=new DateTime($year.'-'.$start .'-'.$j);
			$jourTxt=$jourTxt->format('w');
			$dayTxt=$days[$jourTxt];
			echo "<td >" . $dayTxt ."<br>".$j ." </td>";
			// on créé un tableau âr colonne pour y calculer la somme des colonnes
			$totalCol[$j]=0;
		}
		echo "<td>Total</td>";

		$totalColTotal=0;
		foreach ($statArr as $galec => $statData)
		{
			$nbConnexionMag=0;

			echo "</tr><tr><td>".$galec.'</td><td>'. $statData['name'] .'</td><td>'.$statData['centrale'].'</td>';
			for ($i=1; $i <= $nbDays  ; $i++)
			{
				if(!isset($statData['jour'][$i]))
				{
					echo "<td>&nbsp;</td>";
				}
				else
				{
					echo "<td>x</td>";
					$nbConnexionMag++;
					$totalCol[$i]=$totalCol[$i] +1;
				}
			}
			echo "<td>" . $nbConnexionMag ."</td>";
			$totalColTotal=$totalColTotal +$nbConnexionMag;
		}

		//ligne de total
		echo"</tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>Total</td>";
		for ($m=1; $m <=$nbDays; $m++)
		{
			echo "<td>"	.$totalCol[$m]."</td>";
		}
		echo "<td>" .$totalColTotal."</td>";
		echo "</tr></table></div>";
		echo "</div></div>";


	// #7 génération fichier excel une centrale
		$spreadsheet = new Spreadsheet();
		$sheetName=$monthsFr[$start] .' ' .$year;
		$newSheet = new \PhpOffice\PhpSpreadsheet\Worksheet\Worksheet($spreadsheet, $sheetName);
		$spreadsheet->addSheet($newSheet,0);
		$sheetIndex = $spreadsheet->getIndex(
			$spreadsheet->getSheetByName('Worksheet')
		);
		$spreadsheet->removeSheetByIndex($sheetIndex);
		$sheet=$spreadsheet->setActiveSheetIndexByName($sheetName);
		$writer = new Xlsx($spreadsheet);
		$sheet->setCellValue("A1","Code galec");
		$sheet->setCellValue("B1","Magasin");
		$sheet->setCellValue("C1","Centrale");
		//ligne de titre
		for ($xlTitle=3; $xlTitle < $nbDays+3 ; $xlTitle++)
		{
			$colDate=$xlTitle-2;
			$jourTxt=new DateTime($year.'-'.$start .'-'.$colDate);
			$jourTxt=$jourTxt->format('w');
			$initialJour=$days[$jourTxt];
			$colLig1=$col[$xlTitle]."1";
			$colLig2=$col[$xlTitle]."2";
			$sheet->setCellValue($colLig1,$initialJour);
			$sheet->setCellValue($colLig2,$colDate);

		}
		$ligne=3;
		foreach ($statArr as $galec => $statData)
		{

			$sheet->setCellValue($col[0].$ligne,$galec);
			$sheet->setCellValue($col[1].$ligne,$statData['name']);
			$sheet->setCellValue($col[2].$ligne,$statData['centrale']);
			foreach ($statData['jour'] as $key => $value) {
				for ($i=1; $i <= $nbDays ; $i++)
				{
					if(!isset($statData['jour'][$i]))
					{
						$newCol=$i+2;
						$sheet->setCellValue($col[$newCol].$ligne," ");
						// echo "<td>&nbsp;</td>";
					}
					else
					{
						$newCol=$i+2;
						$sheet->setCellValue($col[$newCol].$ligne,"1");
					}
				}
			}
			$ligne++;

		}
		$sheet->getColumnDimension($col[0])->setAutoSize(true);
		$sheet->getColumnDimension($col[1])->setAutoSize(true);
		$sheet->getColumnDimension($col[2])->setAutoSize(true);



			// echo $ligne;
		$ligTotal="C".$ligne;
		$sheet->setCellValue($ligTotal,"TOTAL");

		//total colonne
		for ($xlTitle=3; $xlTitle < $nbDays+3 ; $xlTitle++)
		{
			$dayFormula=colSum($xlTitle,$col,$ligne);
				// echo "<br>formule ".$dayFormula;
			$sheet->setCellValue($col[$xlTitle].$ligne,$dayFormula);
			$sheet->getColumnDimension($col[$xlTitle])->setAutoSize(true);
		}
		//total par ligne => nb connexion d'un mag
		$lastCol=$col[$nbDays + 2];
		$colTotal=$col[$nbDays + 3];
		for ($row=3; $row <= $ligne; $row++)
		{
			$celResult=$colTotal.$row;
			$celOne='D'.$row;
			$celTwo=$lastCol . $row;
			$magFormula="=SUM(".$celOne.":".$celTwo.")";
			$sheet->setCellValue($celResult,$magFormula);

		}
		$writer->save($xlFileTitle);
			//fin génération magasin une centrale
	}
	// #6
	elseif($nbMonth > 1)
	{
		//----------------------------------------------------------------
		//				TRAITEMENT PERIODE PLUSIEURS MOIS - UNE OU PLUSIEURS CENTRALES
		//----------------------------------------------------------------
		// on crée le nouveau classeur avant d'entrer dans la boucle
		$spreadsheet = new Spreadsheet();


		//pour chaque mois, une nouvelle requete - un nouveau tableau, un nouveau traitement
		for ($k=0; $k < $nbMonth ; $k++)
		{
			//initialisation de la variable de somme de la colonne total
			$totalColTotal=0;	//attention passage en string donc on perd le 0 initiale
			$formDate=$start + $k."/".$year;
			// rajoute le 0 initiale pour les mois infèrieurs à 10
			if($formDate < 10)
			{
				$formDate="0" .$formDate;
			}
			// $formDate=date_format($formDate,"m/Y");
			// echo $formDate;
			$formMonth=$start + $k;
			$nbDays= cal_days_in_month(CAL_GREGORIAN, $formMonth, $year);
			// echo $nbDays;
			$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND site='portail BT' AND description='user authentifié' AND DATE_FORMAT(date_heure, '%m/%Y') = :formDate ORDER BY users.galec ASC");
			$reqStat->execute(array(
				':formDate'	=>$formDate
			));
			$statRes=$reqStat->fetchAll(PDO::FETCH_ASSOC);
			echo "<pre>";
				// var_dump($statRes);
			echo '</pre>';
			$statArr=[];
			$actuGalec="";
			foreach ($statRes as $key => $stat)
			{
				// si mag des stats est dans la liste du sca3
				if(isset($mags[$stat['galec']]))
				{
					if($stat['galec']!=$actuGalec)
					{

						$statArr[$stat['galec']]['name']=$mags[$stat['galec']]['name'];
						$statArr[$stat['galec']]['centrale']=$mags[$stat['galec']]['centrale'];
						$statArr[$stat['galec']]['jour'][$stat['jour']]=$stat['jour'];


						// $statArr[$stat['galec']]['jour'][$stat['mois']][$stat['jour']]=$stat['jour'];
						$actuGalec=$stat['galec'];
					}
					else
					{
						// $statArr[$stat['galec']]['jour'][$stat['mois']][$stat['jour']]=$stat['jour'];
						$statArr[$stat['galec']]['jour'][$stat['jour']]=$stat['jour'];

					}

				}
			}
			//ajout des mag qui ne se sont pas connectés mais qui sont dans la centrale sélectionnée
			foreach ($mags as $key => $value)
			{
				if(!isset($statArr[$key]))
				{
					// echo "missing " .$key .$mags[$key]['name']."<br>";
					$statArr[$key]['name']=$mags[$key]['name'];
					$statArr[$key]['centrale']=$mags[$key]['centrale'];
					$statArr[$key]['jour']="";

				}
			}
			//trie tableau par pano galec
			ksort($statArr);
			//AFFICHAGE
			echo "<div class='row'><div class='col'>";
			echo "<h3 class='blue-text text-darken-4'>". $monthsFr[$start + $k]."</h3><br>";
			echo "<table class='striped' id='tableconnexion'><tr><td>Galec</td><td>Magasin</td><td>Centrale</td>";

			// echo "<table class='striped'><tr><td>&nbsp;</td>";
			$thisMonth=$start + $k;
			for ($j=1; $j <= $nbDays ; $j++)
			{
				$jourTxt=new DateTime($year.'-'.$thisMonth.'-'.$j);
				$jourTxt=$jourTxt->format('w');
				$dayTxt=$days[$jourTxt];
				echo "<td >" . $dayTxt ."<br>".$j ." </td>";
				//création du tableau pour le calcul de la somme des colonnes
				$totalCol[$j]=0;
			}
			echo "<td>Total</td>";
			foreach ($statArr as $galec => $statData)
			{
				$nbConnexionMag=0;
				// echo "</tr><tr><td>".$galec.' - '. $statData['name'] ."</td>";
				echo "</tr><tr><td>".$galec.'</td><td>'. $statData['name'] .'</td><td>'.$statData['centrale'].'</td>';

				// foreach ($statData['jour'] as $key => $value) {
				for ($i=1; $i <= $nbDays ; $i++)
				{
					if(!isset($statData['jour'][$i]))
					{
						echo "<td>&nbsp;</td>";
					}
					else
					{
						echo "<td>x</td>";
						$nbConnexionMag++;
						$totalCol[$i]=$totalCol[$i] +1;
					}
				}
				echo "<td>" . $nbConnexionMag ."</td>";
				$totalColTotal=$totalColTotal +$nbConnexionMag;
			}
			//ligne total avec total colonne
			echo "</tr><tr><td>&nbsp;</td><td>&nbsp;</td><td>Total</td>";
			for ($m=1; $m <=$nbDays; $m++)
			{
				echo "<td>"	.$totalCol[$m]."</td>";
			}
			echo "<td>" .$totalColTotal."</td>";
			echo "</tr></table>";
			echo "</div></div>";
			//#7 génération fichier excel une centrale
			// $spreadsheet = new Spreadsheet();
			// crea feuille
			$sheetName=$monthsFr[$start + $k] .$year;
			$newSheet = new \PhpOffice\PhpSpreadsheet\Worksheet\Worksheet($spreadsheet, $sheetName);
			$spreadsheet->addSheet($newSheet, $k);

			if($spreadsheet->getSheetByName('Worksheet'))
			{
				$sheetIndex = $spreadsheet->getIndex(
					$spreadsheet->getSheetByName('Worksheet')
				);
				$spreadsheet->removeSheetByIndex($sheetIndex);
			}
			$sheet=$spreadsheet->setActiveSheetIndexByName($sheetName);

			$writer = new Xlsx($spreadsheet);
			$sheet->setCellValue("A1","Code galec");
			$sheet->setCellValue("B1","Magasin");
			$sheet->setCellValue("C1","Centrale");
			for ($xlTitle=3; $xlTitle < $nbDays+3 ; $xlTitle++)
			{
				$colDate=$xlTitle-2;
				$jourTxt=new DateTime($year.'-'.$thisMonth.'-'.$colDate);
				$jourTxt=$jourTxt->format('w');
				$initialJour=$days[$jourTxt];
				$colLig1=$col[$xlTitle]."1";
				$colLig2=$col[$xlTitle]."2";

				$sheet->setCellValue($colLig1,$initialJour);
				$sheet->setCellValue($colLig2,$colDate);

			}

			$ligne=3;
			foreach ($statArr as $galec => $statData)
			{

				$sheet->setCellValue($col[0].$ligne,$galec);
				$sheet->setCellValue($col[1].$ligne,$statData['name']);
				$sheet->setCellValue($col[2].$ligne,$statData['centrale']);


				foreach ($statData['jour'] as $key => $value) {
					for ($i=1; $i <= $nbDays ; $i++)
					{
						if(!isset($statData['jour'][$i]))
						{
							$newCol=$i+2;
							$sheet->setCellValue($col[$newCol].$ligne," ");
						}
						else
						{
							$newCol=$i+2;
							$sheet->setCellValue($col[$newCol].$ligne,"1");
						}
					}
				}
				$ligne++;

			}
			$sheet->getColumnDimension($col[0])->setAutoSize(true);
			$sheet->getColumnDimension($col[1])->setAutoSize(true);
			$sheet->getColumnDimension($col[2])->setAutoSize(true);
			// echo $ligne;
			$ligTotal="C".$ligne;
			$sheet->setCellValue($ligTotal,"TOTAL");
			//somme des colonnes
			for ($xlTitle=3; $xlTitle < $nbDays+3 ; $xlTitle++)
			{
				$dayFormula=colSum($xlTitle,$col,$ligne);
				$sheet->setCellValue($col[$xlTitle].$ligne,$dayFormula);
				$sheet->getColumnDimension($col[$xlTitle])->setAutoSize(true);
			}


			$lastCol=$col[$nbDays + 2];
			$colTotal=$col[$nbDays + 3];
			for ($row=3; $row <= $ligne; $row++)
			{
				$celResult=$colTotal.$row;
				$celOne='D'.$row;
				$celTwo=$lastCol . $row;
				$magFormula="=SUM(".$celOne.":".$celTwo.")";
				$sheet->setCellValue($celResult,$magFormula);

			}

			//------------------------------------------------------------------------------------------------------
		}// for nbmonth
		$writer->save($xlFileTitle);
	}
	else
	{
		echo "période incorrecte";
	}
	?>




</div>


</div>




<script src="https://cdn.zingchart.com/zingchart.min.js"></script>
<script type="text/javascript">


		$(document).ready(function(){
			$('#centrale').on('change',function(){
				//réinitialise la liste sinon les selections s'ajoutent
				$('#magasins').html("<option value='allMag'>tout magasins</option>");
				var centrale =$(this).val();
				// console.log (centrale);
				if (centrale){
					$.ajax({
						type:'POST',
						url:'ajaxMag.php',
						data:'centrale='+centrale,
						success:function(html){
							$('#magasins').append(html);
						}

					});
				}
					window.localStorage.setItem("magasins", magasins);

			});

			if(typeof(localStorage.getItem("magasins")) != 'undefined'){
				// document.getElementById("magasins").innerHTML=localStorage.getItem("magasins");
				// console.log(localStorage.getItem("magasins"));

			}



		});

		// #2 graphique demandes oar services
		var servicesData=[<?php
			foreach ($resDdServices as $dds) {
				echo   $dds['nb'] . ',';
			}
			?>];
			console.log(servicesData);
			var servicesLabels=[<?php
				foreach ($resDdServices as $dds) {
					echo '"'. $dds['full_name'] .'",';
				}
				?>];
				window.onload=function(){
					zingchart.render({
						id:"chartServices",
						width:1200,
						height:400,
						data:{
							"type":"bar",
							"title":{
								"text":"Nombre total de demandes : " + <?= $nbTotConn ?>
							},
							"plot": {
								"styles":["red","#ff6666","#ff99cc","#cc99ff","#6699ff","blue"],
								"value-box": {
									"text": "%v"
								}
							},
							"scale-x":{
								"item":{
									"font-size":10
								},
								"labels":servicesLabels,
							},
							"series":[
							{
								"values":servicesData
							}
							]
						}
					});
				};


			</script>



			<?php
//----------------------------------------------------
// VIEW - FOOTER
//----------------------------------------------------
			require '../view/_footer.php';

			?>