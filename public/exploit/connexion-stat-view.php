<div class="row">
	<div class="col">
		<h5>Connexions magasin</h5>
	</div>
</div>

<div class="row mb-3">
	<div class="col">
		<form method="post" action="<?=$_SERVER['PHP_SELF']?>">
			<div class="row">
				<div class="col">
					<div class="form-group">
						<select name="centrales[]" id="centrales" class="form-control" multiple>
							<?php foreach ($ldCentrales as $key => $centrale): ?>
								<?php if (isset($_POST['centrales'])): ?>
									<option value="<?=$centrale['id']?>" <?= (in_array($centrale['id'],$_POST['centrales']))? "selected" :""?>>
										<?php else: ?>
											<option value="<?=$centrale['id']?>">

											<?php endif ?>
											<?=$centrale['centrale']?>
										</option>
									<?php endforeach ?>
								</select>
							</div>
						</div>
						<div class="col-md-6 col-lg-4 col-xl-3">
							<div class="form-group">
								<label for="conn-date-start">Du mois de</label>
								<input type="month" class="form-control" id="conn-date-start" min="2018-01" max="<?=date('Y-m')?>" name="conn-date-start" value="<?=$startDateConn->format('Y-m')?>">
							</div>
						</div>
						<div class="col-md-6 col-lg-4 col-xl-3">
							<div class="form-group">
								<label for="conn-date-end">Au mois de </label>
								<input type="month" class="form-control" id="conn-date-end" name="conn-date-end" value="<?=$endDateConn->format('Y-m')?>">
							</div>
						</div>
						<div class="col-md-6 col-lg-4 col-xl-3 mt-4 pt-2 text-right">
							<button class="btn btn-primary" name="submit-conn" type="submit">Afficher</button>
						</div>
					</div>
				</form>
			</div>
		</div>

		<!-- une année par tableau donc nb année = taille tableau -->
		<?php for($yearIndex=$startDateConn->format('Y'); $yearIndex<=$endDateConn->format('Y'); $yearIndex++): ?>
		<?php
		$firstMonthOfActualYear=getStartMonth($periodConn[$yearIndex]);
		$lastMonthOfActualYear=getEndMonth($periodConn[$yearIndex])
		?>
		<?php for($month=$firstMonthOfActualYear;$month<=$lastMonthOfActualYear;$month++): ?>
			<h5><?= $monthsFr[$month].' ' .$yearIndex ?></h5>
			<table class="table-sm table-striped table-bordered">
				<tr>
					<th>galec</th>
					<th>mag</th>

					<?php for($day=1;$day<= getLastDayOfMonth($month,$yearIndex);$day++):?>
						<th><?=$day?></th>
					<?php endfor ?>
					<th>T</th>

				</tr>
				<?php for($i=0;$i<count($magList);$i++):?>
					<?php
					$daysInMonth=getLastDayOfMonth($month,$yearIndex);
		// nb colonne = nb jour + mag +centrale, +agelc +total
					$nbCol=$daysInMonth+4;

					if($thisCentrale==''){
						$nbMagCentrale=0;
						$nbConnCentrale=0;
						echo '<tr class="bg-white text-center font-weight-bold"><td  colspan="'. $nbCol .'">'.$arCentrale[$magInfo[$magList[$i]]['centrale']].' </td></tr>';

					}
					elseif($thisCentrale!=$magInfo[$magList[$i]]['centrale']){

						echo '<tr class="sum"><td colspan="'. $nbCol .'">En '.$arCentrale[$thisCentrale] . ', ' .$nbConnCentrale.' sur '.$nbMagCentrale.' magasins se sont connectés au moins une fois dans le mois </td></tr>';
						$nbMagCentrale=0;
						$nbConnCentrale=0;
						echo '<tr class="bg-white"><td class="text-center font-weight-bold" colspan="'. $nbCol .'">'.$arCentrale[$magInfo[$magList[$i]]['centrale']].' </td></tr>';
					}

					?>

					<tr>
						<td><?= $magList[$i]?></td>
						<td class="deno"><?= strtolower($magInfo[$magList[$i]]['deno'])?></td>

						<!-- si stat pour le mag -->
						<?php
						$magCon=0;
						$nbMagCentrale++;
						if(in_array($magList[$i],array_keys($statConn[$yearIndex][$month]))){
				// magasin qui se connecte danc on ajoute une fois avant de parcourir les jours
							$nbConnCentrale++;
							for($day=1;$day<= $daysInMonth;$day++){
								if (isset($statConn[$yearIndex][$month][$magList[$i]][$day])){
									echo '<td class="connection">'.$day.'</td>';
									$magCon++;
								}else{
									echo '<td class="'.strtolower((new DateTime($yearIndex.'-'.$month.'-'.$day))->format('D')).'">&nbsp;</td>';

								}
							}
						}else{
							for($day=1;$day<= getLastDayOfMonth($month,$yearIndex);$day++){
								echo '<td class="'.strtolower((new DateTime($yearIndex.'-'.$month.'-'.$day))->format('D')).'">&nbsp;</td>';

							}
						}
						echo '<td>'.$magCon.'</td>';
						echo '</tr>';
						$thisCentrale=$magInfo[$magList[$i]]['centrale'];
						?>

					<?php endfor ?>

					<tr class="sum"><td colspan="<?=$nbCol?>">En <?=$arCentrale[$thisCentrale].', ' .$nbConnCentrale .' sur '.$nbMagCentrale ?> magasins se sont connectés au moins une fois dans le mois</td></tr>
					<?php

					$nbConnCentrale=0;
					$nbMagCentrale=0;
					?>
				</table>
			<?php endfor ?>

		<?php endfor ?>



