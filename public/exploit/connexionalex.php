<?php

// require('../config/autoload.php');
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	echo "pas de variable session";
	header('Location:'. ROOT_PATH.'/index.php');
}
//----------------------------------------------------------------
//			css dynamique
//----------------------------------------------------------------
$page=(basename(__FILE__));
$page=explode(".php",$page);
$page=$page[0];
$cssFile=ROOT_PATH ."/public/css/".$page.".css";




$ddServices=$pdoBt->prepare("SELECT services.full_name, count(msg.id) as nb FROM `msg` left JOIN services ON services.id=msg.id_service WHERE services.full_name<>'test' GROUP BY `id_service`");
$ddServices->execute();
$resDdServices=$ddServices->fetchAll(PDO::FETCH_ASSOC);
$shortLabel=[];
foreach ($resDdServices as $key =>$dds) {
	if($dds['full_name']=="achats PEM GEM")
	{
		$resDdServices[$key]['full_name']="PEM GEM";
	}
	elseif($dds['full_name']=="achats gris")
	{
		$resDdServices[$key]['full_name']="gris";
	}
	elseif($dds['full_name']=="direction commerciale")
	{
		$resDdServices[$key]['full_name']="dir ciale";
	}
	else
	{
		$resDdServices[$key]['full_name']=$dds['full_name'];
	}
}
	// echo "<pre>";
	// var_dump($resDdServices);
	// echo '</pre>';


// traitement formulaire mag connecté par mois et centrales

if(isset($_POST['connexion']))
{
	extract($_POST);
}
else
{
	$month="05";
	$month2="-1";
	$year="2018";
	$centrale="Tous";
}
	// echo $month ."<br>";
	// echo $year ."<br>";
	// echo $centrale . "<br>";
	$formDate=$month."/".$year;
	// echo $formDate;
	$nbDays= cal_days_in_month(CAL_GREGORIAN, $month, $year);
	// echo "nb de jours ".$nbDays;
	// récup mag de la centrale sélectionnée dans le sca3
	//Rajout de la condition Tous demandé par M.Muller le 11/05
	if($centrale == 'Tous'){

	$reqSca=$pdoBt->query("SELECT * FROM sca3");

		}else{
	$reqSca=$pdoBt->prepare("SELECT * FROM sca3 WHERE centrale= :centrale");
	$reqSca->execute(array(
		':centrale' =>$centrale
	));
	}
	$magList=$reqSca->fetchAll(PDO::FETCH_ASSOC);
	// réorg tableau sous forme clé=pano galec => nom mag
	$mags=array();
	foreach ($magList as $key => $mag)
	{
		$mags[$mag['galec']]= $mag['mag'];

	}

$tiret='-';
//Rajout 2ème selection pour date à date demandé par M MULLER le 11/05
if($month2 == '-1'){
	$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND description='user authentifié' AND DATE_FORMAT(date_heure, '%m/%Y') = :formDate ORDER BY users.galec ASC");
		$reqStat->execute(array(
		':formDate'	=>$formDate
	));
}else{
	$reqStat=$pdoStat->prepare("SELECT users.galec, DATE_FORMAT(date_heure, '%e') as jour, date_heure, id_user  FROM stats_logs LEFT JOIN web_users.users ON stats.stats_logs.id_user=web_users.users.login WHERE web_users.users.type='mag' AND type_log ='prod' AND description='user authentifié' AND stats.stats_logs.date_heure BETWEEN '$year$tiret$month' AND '$year$tiret$month2' ORDER BY users.galec ASC");
		$reqStat->execute(array(
		':formDate'	=>$formDate,
		':formDate2'	=>$formDate2
	));


}

	$statRes=$reqStat->fetchAll(PDO::FETCH_ASSOC);
	$magArray=array();
	$precedentPano="";


	foreach ($statRes as $key => $stat)
	{
			// si le code galec des stats est trouvé dans le tableau de sca 3
		if(isset($mags[$stat['galec']]))
		{
			$key=$stat['galec']." - " .$mags[$stat['galec']];
			// echo $key;
			if($stat['galec']<>$actuPano)
			{
				// on commence un nouveau mag
				// echo "<br>" . $stat['galec'] ." - " . $mags[$stat['galec']] ."<br>";
				$actuPano= $stat['galec'];
				 // echo $stat['jour'];
				//on créé le "tableau mag"
				// $key=$stat['galec'] .$mags[$stat['galec']];
				// echo $key;
				$magArray[$key]=array();
				array_push($magArray[$key], $stat['jour']);

				// $magArray[$stat['galec']]=array();
				// array_push($magArray[$stat['galec']], $stat['jour']);

			}
			else
			{
				//tj même mag
				array_push($magArray[$key], $stat['jour']);
				// array_push($magArray[$stat['galec']], $stat['jour']);

				// echo ", ". $stat['jour'];

			}
		}
		else
			// si le mag n'appartient pas à la centrale, on avance
		{
			$actuPano= $stat['galec'];
		}
	}
// }






//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-mig.php');
include('../view/_navbar.php');



?>
<div class="container">

		<!-- <h1>Connexions magasins </h1> -->
		<!-- <div id="chartDiv"></div> -->
		<h1 class="blue-text text-darken-4">Demandes par services </h1>
		<p>&nbsp;</p>
		<!-- <div id="chartMsg"></div> -->

		<div id="chartServices"></div>
	<h1 class="blue-text text-darken-4">Magasins connectés par centrales et par mois</h1>
	<div class="row">

			<form method="post" >
			<div class="form-group row">
				<select  name="year" class="custom-select">
					<option value="2018" selected="select">2018</option>
				</select>
			</div>
			<div class="form-group row">
				<select  name="month" class="custom-select">
					<option value="01" <?=$month=='01' ? ' selected="selected"' : '' ?> >Janvier</option>
					<option value="02" <?=$month=='02' ? ' selected="selected"' : '' ?> >Février</option>
					<option value="03" <?=$month=='03' ? ' selected="selected"' : '' ?> >Mars</option>
					<option value="04" <?=$month=='04' ? ' selected="selected"' : '' ?> >Avril</option>
					<option value="05" <?=$month=='05' ? ' selected="selected"' : '' ?> >Mai</option>
					<option value="06" <?=$month=='06' ? ' selected="selected"' : '' ?> >Juin</option>
					<option value="07" <?=$month=='07' ? ' selected="selected"' : '' ?> >Juillet</option>
					<option value="08" <?=$month=='08' ? ' selected="selected"' : '' ?> >Août</option>
					<option value="09" <?=$month=='09' ? ' selected="selected"' : '' ?> >Septembre</option>
					<option value="10" <?=$month=='10' ? ' selected="selected"' : '' ?> >Octobre</option>
					<option value="11" <?=$month=='11' ? ' selected="selected"' : '' ?> >Novembre</option>
					<option value="12" <?=$month=='12' ? ' selected="selected"' : '' ?> >Décembre</option>


				</select>
<!-- Rajout 2ème menu selection pour choix date à date demandé par M.muller le 11/05 -->
				<select  name="month2" class="custom-select">
					<option value="-1" <?=$month2=='-1' ? ' selected="selected"' : '' ?> >Définir la période</option>
					<option value="01" <?=$month2=='01' ? ' selected="selected"' : '' ?> >Janvier</option>
					<option value="02" <?=$month2=='02' ? ' selected="selected"' : '' ?> >Février</option>
					<option value="03" <?=$month2=='03' ? ' selected="selected"' : '' ?> >Mars</option>
					<option value="04" <?=$month2=='04' ? ' selected="selected"' : '' ?> >Avril</option>
					<option value="05" <?=$month2=='05' ? ' selected="selected"' : '' ?> >Mai</option>
					<option value="06" <?=$month2=='06' ? ' selected="selected"' : '' ?> >Juin</option>
					<option value="07" <?=$month2=='07' ? ' selected="selected"' : '' ?> >Juillet</option>
					<option value="08" <?=$month2=='08' ? ' selected="selected"' : '' ?> >Août</option>
					<option value="09" <?=$month2=='09' ? ' selected="selected"' : '' ?> >Septembre</option>
					<option value="10" <?=$month2=='10' ? ' selected="selected"' : '' ?> >Octobre</option>
					<option value="11" <?=$month2=='11' ? ' selected="selected"' : '' ?> >Novembre</option>
					<option value="12" <?=$month2=='12' ? ' selected="selected"' : '' ?> >Décembre</option>
				</select>
			</div>	
			
	
			
			<div class="form-group row">

				<select name="centrale" class="custom-select">
					<option value="Tous" <?=$centrale=='Tous' ? ' selected="selected"' : '' ?> >Tous</option>
					<option value="LECASUD" <?=$centrale=='LECASUD' ? ' selected="selected"' : '' ?> >LECASUD</option>
					<option value="SCACENTRE" <?=$centrale=='SCACENTRE' ? ' selected="selected"' : '' ?> >SCACENTRE</option>
					<option value="SCAPALSACE" <?=$centrale=='SCAPALSACE' ? ' selected="selected"' : '' ?> >SCAPALSACE</option>
					<option value="SCAPARTOIS" <?=$centrale=='SCAPARTOIS' ? ' selected="selected"' : '' ?> >SCAPARTOIS</option>
					<option value="SCAPEST" <?=$centrale=='SCAPEST' ? ' selected="selected"' : '' ?> >SCAPEST</option>
					<option value="SCADIF" <?=$centrale=='SCADIF' ? ' selected="selected"' : '' ?> >SCADIF</option>
					<option value="SCAPNOR" <?=$centrale=='SCAPNOR' ? ' selected="selected"' : '' ?> >SCAPNOR</option>
					<option value="SOCAMIL" <?=$centrale=='SOCAMIL' ? ' selected="selected"' : '' ?> >SOCAMIL</option>
					<option value="SOCARA" <?=$centrale=='SOCARA' ? ' selected="selected"' : '' ?> >SOCARA</option>
				</select>
			</div>
				<input type="submit" name="connexion">
			<!-- </div> -->
			</form>
		</div>
		<div class="row">
			<?php
			echo "<table class='striped'><tr><td>&nbsp;</td>";
			for ($j=1; $j <= $nbDays ; $j++)
			{

//n'affiche rien sur le 2ème menu déroulant est identique au 1er menu déroulant
				if($month == $month2){
					// 
				}else{
				echo "<td>" .$j ."</td>";
				}
			}
//affiche la phrase si dessous pour montrer comment afficher le mois en cours			
			if($month == $month2){
echo "<td>Pour visualiser un mois uniquement, le deuxième menu déroulant doit être sur Définir la période</td>";

			}
			foreach ($magArray as $pano => $jour)
			{

								echo "</tr><tr><td>".$pano ."</td>";

				for ($i=1; $i <= $nbDays ; $i++)
				{

					if(in_array($i,$jour))
					{
						echo "<td>X</td>";
					}
					else
					{
						echo "<td>&nbsp;</td>";
					}




				}
			}



			echo "</tr></table>";
			?>
		</div>



	</div>




	<script src="https://cdn.zingchart.com/zingchart.min.js"></script>
	<script type="text/javascript">
		var servicesData=[<?php
			foreach ($resDdServices as $dds) {
				echo   $dds['nb'] . ',';
			}
			?>];
		var servicesLabels=[<?php
			foreach ($resDdServices as $dds) {
				echo '"'. $dds['full_name'] .'",';
			}
			?>];
			window.onload=function(){
								// zingchart.render({
								// 	id:"chartDiv",
								// 	width:1600,
								// 	height:400,
								// 	data:{
								// 		"type":"bar",
								// 		"title":{
								// 			"text":"Nombre de connexions par jour"
								// 		},
								// 		"plot": {
								// 			"value-box": {
								// 				"text": "%v"
								// 			}
								// 		},
								// 		"scale-x":{
								// 			"labels":myLabels
								// 		},
								// 		"series":[
								// 		{
								// 			"values":myData
								// 		}
								// 		]
								// 	}
								// });
								// zingchart.render({
								// 	id:"chartMsg",
								// 	width:1600,
								// 	height:400,
								// 	data:{
								// 		"type":"bar",
								// 		"title":{
								// 			"text":"Nombre de demandes mag par jour"
								// 		},
								// 		"plot": {
								// 			"value-box": {
								// 				"text": "%v"
								// 			}
								// 		},
								// 		"scale-x":{
								// 			"labels":msgLabels
								// 		},
								// 		"series":[
								// 		{
								// 			"values":msgData
								// 		}
								// 		]
								// 	}
								// });
								zingchart.render({
									id:"chartServices",
									width:1200,
									height:400,
									data:{
										"type":"bar",
										"title":{
											"text":"Nombre de demandes par services"
										},
										"plot": {
											"value-box": {
												"text": "%v"
											}
										},
										"scale-x":{
											"item":{
												"font-size":10
											},
											"labels":servicesLabels,
										},
										"series":[
										{
											"values":servicesData
										}
										]
									}
								});


							};


	</script>



	<?php
//----------------------------------------------------
// VIEW - FOOTER
//----------------------------------------------------
	require '../view/_footer.php';

	?>