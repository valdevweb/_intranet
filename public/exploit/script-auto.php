<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


require '../../Class/Db.php';
require '../../Class/BatchDao.php';
// require_once '../../vendor/autoload.php';


$errors=[];
$success=[];
$db=new Db();
$pdoUser=$db->getPdo('web_users');
$pdoEvo=$db->getPdo('evo');


$batchDao=new BatchDao($pdoEvo);

function arbo($racine) {
	$liste = glob($racine."/*");
	$resultat = array();

	foreach($liste as $element)
	{

		if(is_dir($element))
		{
			$resultat = array_merge($resultat, arbo($element));
		}
		else
		{
			array_push($resultat, $element);
		}
	}

	return $resultat;
}


$listDir=$batchDao->getBatchDirAppli(1);


$i=0;

if($_SESSION['id_web_user']!=981){
	echo "vous n'avez pas accès à cette page";
	exit();
}


foreach ($listDir as $dir) {
	$files[]=arbo(DIR_SITE.$dir['dir']);
}
if(isset($_POST['add'])){

	$index=key($_POST['add']);
	$fullDir=str_replace(DIR_SITE,"",$_POST["fulldir"][$index]);
	$dirArray=explode("/",$fullDir);
	$dir=$dirArray[0];
	$idDir=$batchDao->getIdDir($dir);
	$page=$dirArray[1];
	$url=SITE_ADDRESS."/".$dir."/".$page;

	$descr=$_POST["descr"][$index];
	$batchDao->addBatch($idDir['id'], $url, $page, $descr);
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'],true,303);
}

$listBatch=$batchDao->getBatchAppli(1);


//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>

<div class="container">
	<div class="row py-5">
		<div class="col">
			<h1 class="text-main-blue">Scripts</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="row">
		<div class="col">

			<table class="table table-sm">
				<thead class="thead-dark">
					<tr>
						<th>dir</th>
						<th>page</th>
						<th>descr</th>
					</tr>
				</thead>
				<tbody>
					<?php foreach ($listBatch as $key => $batch): ?>

						<tr>
							<td class="nowrap bg-light-blue"><?=$batch['dir']?></td>
							<td class="nowrap bg-light-blue"><?=$batch['page']?></td>
							<td><?=$batch['descr']?></td>
						</tr>
						<tr>
							<td></td>
							<td class="alert-secondary" colspan="2"><?=$batch['url']?></td>
						</tr>
					<?php endforeach ?>

				</tbody>
			</table>
		</div>
	</div>

	<div class="row">
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post">


				<table class="table table-sm">
					<thead class="thead-dark">
						<tr>
							<th>Emplacement</th>
							<th>Add</th>
						</tr>
					</thead>
					<tbody>


						<?php foreach ($files as $fileKey => $value): ?>

							<?php foreach ($files[$fileKey] as $keyKey => $value): ?>
								<?php

								$pageArr=explode("/", $files[$fileKey][$keyKey]);
								$page=end($pageArr);
								// echo $page;
								$pageExist=$batchDao->pageIsInBatch($page, 1)

								?>
								<?php if (empty($pageExist)): ?>
									<tr>
										<td colspan="2"><?=$files[$fileKey][$keyKey]?></td>
									</tr>
									<tr>
										<td>
											<div class="form-group">
												<div class="form-group">
													<label for="descr">Description :</label>

													<textarea class="form-control" name="descr[<?=$i?>]"  row="3"></textarea>
												</div>

											</div>
										</td>
										<td class="">
											<button class="btn btn-primary" type="submit" name="add[<?=$i?>]">Add</button>
										</td>
										<input type="hidden" class="form-control" name="page[<?=$i?>]" value="<?=$page?>" >
										<input type="hidden" class="form-control" name="fulldir[<?=$i?>]"  value="<?=$files[$fileKey][$keyKey]?>">

									</tr>
									<?php $i++; ?>


								<?php endif ?>


							<?php endforeach ?>
						<?php endforeach ?>
					</tbody>
				</table>
			</form>

		</div>
	</div>



</div>

<?php
require '../view/_footer-bt.php';
?>