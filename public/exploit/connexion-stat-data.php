<?php
function getCentrale($pdoMag){
	$req=$pdoMag->query("SELECT centrale, id_ctbt as id FROM centrales WHERE stats=1 ORDER BY centrale");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getConnexion($pdoStat,$startDateConn,$endDateConn,$idCentralesList){
	$centrales=' AND (' .join(' OR ', array_map(function($value){return 'centrale='.$value;},$idCentralesList)) .')';

	$req=$pdoStat->prepare("SELECT
		DATE_FORMAT(date_heure,'%c') as mois,
		DATE_FORMAT(date_heure,'%Y') as year,
		DATE_FORMAT(date_heure,'%e') as jour,
		DATE_FORMAT(date_heure,'%Y-%m-%d') as date_entiere,
		id_web_user,
		magasin.mag.galec
		FROM stats_logs
		LEFT JOIN web_users.users ON stats_logs.id_user=web_users.users.login
		LEFT JOIN magasin.mag ON web_users.users.galec=magasin.mag.galec
		WHERE site='portail BT' AND type_log='prod' AND description='user authentifiÃ©' AND magasin.mag.galec IS NOT NULL
		AND web_users.users.type='mag'
		AND DATE_FORMAT(date_heure, '%Y-%m') BETWEEN :datestart AND :dateend

		GROUP BY DATE_FORMAT(date_heure,'%Y-%m-%d'),`id_web_user`
		ORDER BY centrale, deno, date_heure ");
	$req->execute([
		':datestart'		=>$startDateConn->format('Y-m'),
		':dateend'			=>$endDateConn->format('Y-m')
	]);
	// return $req->errorInfo();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getMag($pdoUser,$idCentralesList){
	$centrales=' AND (' .join(' OR ', array_map(function($value){return 'centrale='.$value;},$idCentralesList)) .')';
	$req=$pdoUser->prepare("SELECT deno, centrale, users.galec FROM users LEFT JOIN magasin.mag ON users.galec=magasin.mag.galec WHERE type= 'mag' AND gel=0 $centrales ORDER BY mag.centrale, deno");
	$req->execute();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}
$idCentralesList=[];
$thisCentrale='';
$periodConn=[];
$magInfo=[];
$nbMagCentrale=0;
$nbConnCentrale=0;
$arCentrale=MagHelpers::getListCentraleStats($pdoMag);
$ldCentrales=getCentrale($pdoMag);


if(isset($_POST['submit-conn'])){
	if(!isset($_POST['centrales'])){
		$idCentralesList=array_keys($arCentrale);

	}else{

		$idCentralesList=$_POST["centrales"];
	}
		$endDateConn=new DateTime($_POST['conn-date-end']);
		$startDateConn=new DateTime($_POST['conn-date-start']);
}else{
	$endDateConn=$startDateConn=new DateTime();
	$idCentralesList=array_keys($arCentrale);
}

$connexions=getConnexion($pdoStat,$startDateConn,$endDateConn,$idCentralesList);
$mags=getMag($pdoUser,$idCentralesList);

foreach ($mags as $mag) {
	$magList[]=$mag['galec'];
	$magInfo[$mag['galec']]['centrale']=$mag['centrale'];
	$magInfo[$mag['galec']]['deno']=$mag['deno'];
}


foreach ($connexions as $conn) {
	$statConn[$conn['year']][$conn['mois']][$conn['galec']][$conn['jour']]=$conn['date_entiere'];
	$periodConn[$conn['year']][$conn['mois']]=0;
}

