<?php

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

$spreadsheet = new Spreadsheet();
$sheet = $spreadsheet->getActiveSheet();
$row=1;
for($yearIndex=$startDateConn->format('Y'); $yearIndex<=$endDateConn->format('Y'); $yearIndex++){
	if (isset($periodConn[$yearIndex])){
		$firstMonthOfActualYear=getStartMonth($periodConn[$yearIndex]);
		$lastMonthOfActualYear=getEndMonth($periodConn[$yearIndex]);
		$sheet->setCellValue('A'.$row, 'Année');
		$sheet->setCellValue('B'.$row, 'Mois');
		$sheet->setCellValue('c'.$row, 'Centrale');
		$sheet->setCellValue('d'.$row, 'Galec');
		$sheet->setCellValue('e'.$row, 'Deno');

		for($month=$firstMonthOfActualYear;$month<=$lastMonthOfActualYear;$month++){
			$moisParcouru=$monthsFr[$month];
			$anneeParcourue=$yearIndex;
			// echo "mois et annee parcourue".$moisParcouru. " ".$anneeParcourue;
			// echo "<br>";

			for($day=1;$day<= getLastDayOfMonth($month,$yearIndex);$day++){
				$colDay=5+$day;
				$colDay=getNameFromNumber($colDay);
				$sheet->setCellValue($colDay.$row, $day);
			}
			$row++;
		// 		// parcours mag
			for($i=0;$i<count($magList);$i++){
				$centraleParcourue=$magInfo[$magList[$i]]['centrale'];
				$galecParcouru=$magList[$i];
				$denoParcouru=$magInfo[$magList[$i]]['deno'];
				$sheet->setCellValue('A'.$row, $anneeParcourue);
				$sheet->setCellValue('B'.$row, $moisParcouru);
				$sheet->setCellValue('c'.$row, $centraleParcourue);
				$sheet->setCellValue('d'.$row, $galecParcouru);
				$sheet->setCellValue('e'.$row, $denoParcouru);

				$daysInMonth=getLastDayOfMonth($month,$yearIndex);
		// nb colonne = nb jour + mag +centrale, +agelc +total
				$nbCol=$daysInMonth+5;

				$magCon=0;
					// si mag présent dans tableau pour annee et mois
				if(in_array($magList[$i],array_keys($statConn[$yearIndex][$month]))){
				// on parcours les jours
					for($day=1;$day<= $daysInMonth;$day++){
						$colDay=5+$day;

						$colDay=getNameFromNumber($colDay);
						if (isset($statConn[$yearIndex][$month][$magList[$i]][$day])){
							$sheet->setCellValue($colDay.$row, 1);
							$magCon++;
						}else{
							$sheet->setCellValue($colDay.$row, 0);
						}
					}
				}else{
					for($day=1;$day<= getLastDayOfMonth($month,$yearIndex);$day++){
						$colDay=5+$day;

						$colDay=getNameFromNumber($colDay);
						$sheet->setCellValue($colDay.$row, 0);
							// on met vide sur toute les colonnes
					}
				}
					// on inscrit le total des connexion mag
				$lastCol=$nbCol+1;
				$lastCol=getNameFromNumber($lastCol);
				$sheet->setCellValue($lastCol.$row, $magCon);
				$row++;
			}
				// ligne nb de connexion pour le mois pour la der centrale

			$nbConnCentrale=0;
			$nbMagCentrale=0;

		}
			 //endfor
	}
			//endif

}
			 //endfor










$filename="extraction connexions mag.xlsx";
header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
header('Content-Disposition: attachment;filename="'.$filename.'"');
header('Cache-Control: max-age=0');

$writer = \PhpOffice\PhpSpreadsheet\IOFactory::createWriter($spreadsheet, 'Xlsx');
$writer->save('php://output');
exit();









