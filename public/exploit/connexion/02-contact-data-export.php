<?php

use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;

if (!empty($stats)){
	$spreadsheet = new Spreadsheet();
	$sheet = $spreadsheet->getActiveSheet();
	$row=1;


	// <!-- on parcourt les années selectionnées de la date de  -->
	for($yearIndex=$startDate->format('Y'); $yearIndex<=$endDate->format('Y'); $yearIndex++){

		$anneeParcourue=$yearIndex;
		if (isset($period[$yearIndex])){
		// entete
			$sheet->setCellValue('A'.$row, 'Service');
			$col=1;
			for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++){
				$colLetter=getNameFromNumber($col);
				$sheet->setCellValue($colLetter.$row, $monthsFr[$month]. $yearIndex);
				$col++;
			}
			$colLetter=getNameFromNumber($col);
			$sheet->setCellValue($colLetter.$row, "total");
			$row++;
			for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++){

				$moisParcouru=$month;
				$moisStrParcouru=$monthsFr[$month];
				$newService='';
				$sumPerMonth=[];

				for($i=0;$i<count($sArr);$i++){
					for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++){
						if($sArr[$i]!=$newService){
							$nomService=$sArr[$i];
							$newService=$sArr[$i];
							$sommeService=0;
							$col=1;
							$sheet->setCellValue('A'.$row, $nomService);
						}else{

							$newService=$sArr[$i];


						}
						if(isset($statServices[$yearIndex][$sArr[$i]][$month])){
							$colLetter=getNameFromNumber($col);
							$sheet->setCellValue($colLetter.$row, $statServices[$yearIndex][$sArr[$i]][$month]);
							$sommeService=$sommeService+$statServices[$yearIndex][$sArr[$i]][$month];
							if(isset($sumPerMonth[$month])){
								$sumPerMonth[$month]+=$statServices[$yearIndex][$sArr[$i]][$month];
							}else{
								$sumPerMonth[$month]=$statServices[$yearIndex][$sArr[$i]][$month];
							}

						}else{
							$colLetter=getNameFromNumber($col);
							$sheet->setCellValue($colLetter.$row, 0);
						}

						$col++;

						if($month==getEndMonth($period[$yearIndex])){
							$colLetter=getNameFromNumber($col);
							$sheet->setCellValue($colLetter.$row, $sommeService);

							// echo  "some service ".$sommeService;
						}
						// echo "<br>";

					}
					$row++;

				}
			}


		}

	}

	$filename="export-contacts.xlsx";
	header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
	header('Content-Disposition: attachment;filename="'.$filename.'"');
	header('Cache-Control: max-age=0');

	$writer = \PhpOffice\PhpSpreadsheet\IOFactory::createWriter($spreadsheet, 'Xlsx');
	$writer->save('php://output');
	exit;

}



