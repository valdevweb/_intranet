<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	echo "pas de variable session";
	header('Location:'. ROOT_PATH.'/index.php');
}
//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";

//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
// require_once '../../vendor/autoload.php';

require '../../Class/Helpers.php';

//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);
/*----------------------------------------------------------
FONCTIONNALITES :
tableau recap des imports (5 derniers): date du der import + nom fichier
										nb erreurs signalées+ nb modif (suppression ajout)

listes des adresses lotus sans correspondances (non trouvé dans carnet d'adresse E.Leclerc) - retirer LCOMMERCE

listes de moodif => col nouveau ,col suppression



-------------------------------------------------------*/


 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];




//------------------------------------------------------
//			FONCTION
//------------------------------------------------------
function getErrorList($pdoUser,$idErr){
	$req=$pdoUser->prepare("SELECT * FROM mag_ld WHERE errors = :idErr ORDER BY errors, ld_full");
	$req->execute([
		':idErr'	=>$idErr
	]);
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getAllErrors($pdoUser){
	$req=$pdoUser->prepare("SELECT * FROM mag_ld WHERE errors !=0 ORDER BY errors, ld_full");
	$req->execute();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}
function getLegendErr($pdoUser){
	$req=$pdoUser->query("SELECT * FROM mag_ld_error_nb ORDER BY id");
	return $req->fetchAll(PDO::FETCH_KEY_PAIR);
}
function getNbok($pdoUser){
	$req=$pdoUser->query("SELECT count(id) as sum FROM mag_ld WHERE errors =0");
	$data=$req->fetch(PDO::FETCH_ASSOC);
	return $data['sum'];
}
function getNbTotal($pdoUser){
	$req=$pdoUser->query("SELECT count(id) as sum FROM mag_ld");
	$data=$req->fetch(PDO::FETCH_ASSOC);
	return $data['sum'];
}
function getOld($pdoUser){
	// ce qui n'est pas dans la vieille table
	$req=$pdoUser->query("SELECT * FROM mag_ld_old");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getLastImport($pdoUser){
	$req=$pdoUser->query("SELECT *,DATE_FORMAT(date_import, '%d-%m-%Y') as dateimport FROM lotus_imports ORDER BY id desc limit 1");
	return $req->fetch(PDO::FETCH_ASSOC);
}

function getHisto($pdoUser){
	$req=$pdoUser->query("SELECT *,DATE_FORMAT(date_import, '%d-%m-%Y') as dateimport FROM lotus_histo LEFT JOIN lotus_imports ON lotus_histo.id_new=lotus_imports.id");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function search($pdoUser)
{
	$req=$pdoUser->prepare("SELECT * FROM mag_ld  LEFT JOIN mag ON mag_ld.galec=mag.galec WHERE concat(mag_ld.galec, mag.deno,mag.btlec, mag.city,mag_ld.ld_full, mag_ld.email) LIKE :search AND mag_ld.galec!='' ORDER BY mag_ld.ld_full");
	$req->execute(array(
		':search' =>'%'.$_POST['search_strg'] .'%'
	));
	return $req->fetchAll(PDO::FETCH_ASSOC);
 // return $req->errorInfo();
}
// $search=search($pdoUser);
$searchLotus="";
if(isset($_POST['search_form'])){
	$searchLotus=search($pdoUser);
}


if(isset($_POST['clear_form'])){
	$_POST=[];
	$searchLotus="";
}


$histos= getHisto($pdoUser);
$modif=['supprimé','ajouté'];

$ldToDelete=getErrorList($pdoUser, 2);
$allErrors=getAllErrors($pdoUser);
$legend=getLegendErr($pdoUser);
$nbok=getNbok($pdoUser);
$nbko=count($allErrors);
$nblig=getNbTotal($pdoUser);

$lastImport=getLastImport($pdoUser);


$wErr=0;
$wLdfull="";
$lig=2;

//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container-fluid bg-white">
	<h1 class="text-main-blue py-5 ">Listes de diffusion</h1>

	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>

	<div class="row">
		<div class="col">
			<h5 class="text-main-blue"><i class="fas fa-angle-double-right mr-3 bg-blue-ico"></i>Rechercher une liste de diffusion ou un mail</h5>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post" >
				<div class="row">
					<div class="col-4">
						<div class="form-group">
							<input class="form-control mr-5 pr-5" placeholder="liste diffu, deno, ville, pano galec, code btlec, email" name="search_strg" id="" type="text"  value="<?=isset($search_strg)? $search_strg: false?>">
						</div>
					</div>
					<div class="col">
						<button class="btn btn-primary mr-5" type="submit" id="" name="search_form"><i class="fas fa-search pr-2"></i>Rechercher</button>
						<button class="btn btn-blue" type="submit" id="" name="clear_form"><i class="fas fa-eraser pr-2"></i>Effacer</button>
					</div>
				</div>
			</form>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<?php if (!empty($searchLotus)): ?>
				<?php foreach ($searchLotus as $key => $found): ?>

					<?php if ($found['ld_full']!=$wLdfull): ?>
						<div class="text-main-blue font-weight-bold"><?= $found['ld_full']  ?> : </div>
						<?= $found['email'] ?>
						<?php $wLdfull=$found['ld_full'];?> -
						<?php else: ?>
							<?= $found['email'] ?>

							<?php $wLdfull=$found['ld_full']; ?> -
						<?php endif ?>

					<?php endforeach ?>
				<?php endif ?>
			</div>
		</div>

		<div class="row mt-5">
			<div class="col">
				<h5 class="text-main-blue"><i class="fas fa-angle-double-right mr-3 bg-blue-ico"></i>Anomalies du dernier import de liste de diffusion</h5>
			</div>
		</div>

		<div class="row mb-3">
			<div class="col-lg-1"></div>

			<div class="col">

				<div class="text-center text-main-blue">
					<span class="pr-5">
						Date dernier import : <?=$lastImport['dateimport']?>
					</span>
					<span class="pr-5">
						Nb d'entrées : <?= $nblig?>
					</span>
					<span class="pr-5">
						Nb adresses valides	: <?=$nbok?>
					</span>
					Nb adresses invalides : <?= $nbko?>

				</div>

			</div>
			<div class="col-lg-1"></div>

		</div>

		<div class="row">
			<div class="col">
				<!-- start table -->
				<table class="table table-sm">
					<tr class="thead-dark">
						<th>Nom lotus</th>
						<th>Suffixe</th>
						<th>lotus</th>
						<th>Detail</th>
					</tr>
					<?php foreach ($allErrors as $error): ?>
						<?php if($error['ld_short'] !='LCOMMERCE'): ?>
							<?php if($error['errors']!=$wErr): ?>
								<tr  class="bg-light-blue">
									<td colspan="5" class="text-center font-weight-bold">Code erreur #<?=$error['errors'] . ' - '.$legend[$error['errors']]?></td>
								</tr>
								<tr>
									<td><?=$error['ld_short']?></td>
									<td><?=$error['ld_suffixe']?></td>

									<td><?=$error['lotus']?></td>
									<td><?=$error['error_detail']?></td>
								</tr>
								<?php $wErr=$error['errors']?>

								<?php else: ?>
									<tr>
										<td><?=$error['ld_short']?></td>
										<td><?=$error['ld_suffixe']?></td>

										<td><?=$error['lotus']?></td>
										<td><?=$error['error_detail']?></td>
									</tr>
								<?php endif ?>
							<?php endif ?>


						<?php endforeach ?>

					</thead>
					<tbody>
						<tr>
							<td></td>
						</tr>
					</tbody>
				</table>
				<!-- ./table -->
			</div>
		</div>


		<div class="row mt-5">
			<div class="col">
				<h5 class="text-main-blue"><i class="fas fa-angle-double-right mr-3 bg-blue-ico"></i>Historique des modifications apportées sur les listes de diffusion</h5>
				<p></p>
			</div>
		</div>
		<div class="row">
			<div class="col">
				<!-- start table -->
				<table class="table table-sm">
					<thead class="thead-dark">
						<tr>
							<th>Liste de diffusion</th>
							<th>Email</th>
							<th>Modification</th>
							<th>date de modif</th>
						</tr>
					</thead>
					<tbody>
						<?php if (isset($histos) && !empty($histos)) : ?>
						<?php foreach ($histos as $histo): ?>
							<tr>
								<td><?= $histo['ld_full']?></td>
								<td><?= $histo['email']?></td>
								<td><?=$modif[$histo['added']]?></td>
								<td><?=$histo['dateimport']?></td>

							</tr>
						<?php endforeach ?>
					<?php endif ?>

					<?php if(isset($deleted) && !empty($deleted)): ?>
					<?php foreach ($deleted as $del): ?>
						<tr>
							<td><?= $del['ld_full']?></td>
							<td><?= $del['email']?></td>
							<td>adresse mail qui n'est plus dans le nouvel import</td>
						</tr>
					<?php endforeach ?>
				<?php endif ?>


			</tbody>
		</table>
		<!-- ./table -->

	</div>
</div>

<!-- ./container -->
</div>

<?php
require '../view/_footer-bt.php';
?>