<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}
//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";

//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
// require_once '../../vendor/autoload.php';

require '../../Class/Helpers.php';

//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);
/*----------------------------------------------------------
FONCTIONNALITES :
tableau recap des imports (5 derniers): date du der import + nom fichier
										nb erreurs signalées+ nb modif (suppression ajout)

listes des adresses lotus sans correspondances (non trouvé dans carnet d'adresse E.Leclerc) - retirer LCOMMERCE

listes de moodif => col nouveau ,col suppression



-------------------------------------------------------*/


 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];




//------------------------------------------------------
//			FONCTION
//------------------------------------------------------
function getErrorList($pdoMag,$idErr){
	$req=$pdoMag->prepare("SELECT * FROM lotus_ld WHERE errors = :idErr ORDER BY errors, ld_full");
	$req->execute([
		':idErr'	=>$idErr
	]);
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getAllErrors($pdoMag){
	$req=$pdoMag->prepare("SELECT * FROM lotus_ld WHERE errors !=0 ORDER BY errors, ld_full");
	$req->execute();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}
function getLegendErr($pdoMag){
	$req=$pdoMag->query("SELECT * FROM lotus_ld_error_nb ORDER BY id");
	return $req->fetchAll(PDO::FETCH_KEY_PAIR);
}
function getNbok($pdoMag){
	$req=$pdoMag->query("SELECT count(id) as sum FROM lotus_ld WHERE errors =0");
	$data=$req->fetch(PDO::FETCH_ASSOC);
	return $data['sum'];
}
function getNbTotal($pdoMag){
	$req=$pdoMag->query("SELECT count(id) as sum FROM lotus_ld");
	$data=$req->fetch(PDO::FETCH_ASSOC);
	return $data['sum'];
}
function getOld($pdoMag){
	// ce qui n'est pas dans la vieille table
	$req=$pdoMag->query("SELECT * FROM lotus_ld_old");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function getLastImport($pdoMag){
	$req=$pdoMag->query("SELECT *,DATE_FORMAT(date_import, '%d-%m-%Y') as dateimport FROM lotus_imports ORDER BY id desc limit 1");
	return $req->fetch(PDO::FETCH_ASSOC);
}

function getHisto($pdoMag){
	$req=$pdoMag->query("SELECT *,DATE_FORMAT(date_import, '%d-%m-%Y') as dateimport FROM lotus_histo LEFT JOIN lotus_imports ON lotus_histo.id_new=lotus_imports.id");
	return $req->fetchAll(PDO::FETCH_ASSOC);
}

function search($pdoMag)
{
	$req=$pdoMag->prepare("SELECT * FROM lotus_ld  LEFT JOIN mag ON lotus_ld.galec=mag.galec WHERE concat(lotus_ld.galec, mag.deno,mag.id, mag.ville,lotus_ld.ld_full, lotus_ld.email) LIKE :search AND lotus_ld.galec!='' ORDER BY lotus_ld.ld_full");
	$req->execute(array(
		':search' =>'%'.$_POST['search_strg'] .'%'
	));
	return $req->fetchAll(PDO::FETCH_ASSOC);
 // return $req->errorInfo();
}
// $search=search($pdoMag);
$searchLotus="";
if(isset($_POST['search_form'])){
	$searchLotus=search($pdoMag);


}


if(isset($_POST['clear_form'])){
	$_POST=[];
	$searchLotus="";
}




$modif=['supprimé','ajouté'];
$allErrors=getAllErrors($pdoMag);



$ldToDelete=getErrorList($pdoMag, 2);


$legend=getLegendErr($pdoMag);
$nbok=getNbok($pdoMag);
$nbko=count($allErrors);
$nblig=getNbTotal($pdoMag);

$lastImport=getLastImport($pdoMag);


$wErr=0;
$wLdfull="";
$lig=2;

//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container-fluid bg-white">
	<h1 class="text-main-blue py-5 ">Listes de diffusion</h1>

	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>

	<div class="row">
		<div class="col">
			<h5 class="text-main-blue"><i class="fas fa-angle-double-right mr-3 bg-blue-ico"></i>Rechercher une liste de diffusion ou un mail</h5>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post" >
				<div class="row">
					<div class="col-4">
						<div class="form-group">
							<input class="form-control mr-5 pr-5" placeholder="liste diffu, deno, ville, pano galec, code btlec, email" name="search_strg" id="" type="text"  value="<?=isset($search_strg)? $search_strg: false?>">
						</div>
					</div>
					<div class="col">
						<button class="btn btn-primary mr-5" type="submit" id="" name="search_form"><i class="fas fa-search pr-2"></i>Rechercher</button>
						<button class="btn btn-blue" type="submit" id="" name="clear_form"><i class="fas fa-eraser pr-2"></i>Effacer</button>
					</div>
				</div>
			</form>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<?php if (!empty($searchLotus)): ?>
				<?php foreach ($searchLotus as $key => $found): ?>

					<?php if ($found['ld_full']!=$wLdfull): ?>
						<div class="text-main-blue font-weight-bold"><?= $found['ld_full']  ?> : </div>
						<?= $found['email'] ?>
						<?php $wLdfull=$found['ld_full'];?> -
						<?php else: ?>
							<?= $found['email'] ?>

							<?php $wLdfull=$found['ld_full']; ?> -
						<?php endif ?>

					<?php endforeach ?>
				<?php endif ?>
			</div>
		</div>

		<div class="row mt-5">
			<div class="col">
				<h5 class="text-main-blue"><i class="fas fa-angle-double-right mr-3 bg-blue-ico"></i>Anomalies du dernier import de liste de diffusion</h5>
			</div>
		</div>

		<div class="row my-3">


			<div class="col">

				<div class=" text-main-blue">
					<span class="pr-5">
						Date dernier import : <?=$lastImport['dateimport']?>
					</span>
					<span class="pr-5">
						Nb d'entrées : <?= $nblig?>
					</span>
					<span class="pr-5">
						Nb adresses valides	: <?=$nbok?>
					</span>
					Nb adresses invalides : <?= $nbko?>

				</div>

			</div>


		</div>

		<div class="row pt-3">

			<div class="col-6">
				<!-- start table -->


					<?php foreach ($allErrors as $error): ?>

						<?php if($error['errors']!=$wErr): ?>
							<?php if ($wErr!=0): ?>
							</tbody>
						</table>
					<?php endif ?>
					<table class="table table-sm border">
						<thead>
							<tr class="thead-dark">
								<th class='fit'>Nom lotus</th>
								<th class='fit'>Suffixe</th>
								<th class='fit'>lotus</th>

							</tr>
						</thead>
						<tbody>
							<tr class="bg-light-blue">
								<td colspan="3" class="text-center font-weight-bold fit">Code erreur #<?=$error['errors'] . ' - '.$legend[$error['errors']]?></td>
							</tr>
							<tr>
								<td class="fit"><?=$error['ld_short']?></td>
								<td class="fit"><?=$error['ld_suffixe']?></td>

								<td class="fit"><?=$error['lotus']?></td>
							</tr>


							<?php $wErr=$error['errors']?>

							<?php else: ?>
								<tr>
									<td class="fit"><?=$error['ld_short']?></td>
									<td class="fit"><?=$error['ld_suffixe']?></td>

									<td class="fit"><?=$error['lotus']?></td>
								</tr>
							<?php endif ?>
						<?php endforeach ?>
					</tbody>
				</table>


		</div>
		<div class="col-6"></div>

	</div>



</div>

<!-- ./container -->
</div>

<?php
require '../view/_footer-bt.php';
?>