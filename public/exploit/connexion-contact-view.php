<div class="row">
	<div class="col">
		<h5>Demandes par services</h5>
	</div>
</div>
<div class="row mb-3">
	<div class="col">
		<form method="post" action="<?=$_SERVER['PHP_SELF']?>">
			<div class="row">
				<div class="col text-center text-orange">
					Filtrer par services
				</div>
			</div>
			<div class="row justify-content-around">
				<div class="col-auto">
					<?php foreach ($servicesList as $key => $service): ?>
						<?php if ($countbox==$halfServices ): ?>
							<?php $countbox=0 ?>

						</div>
						<div class="col-auto">

						<?php endif ?>
						<div class="form-check">
							<input class="form-check-input" type="checkbox" value="<?=$service['id']?>" id="<?=$service['id']?>" name="services[]" <?= FormHelpers::checkCheckedArray($service['id'], 'services') ?>>
							<label class="form-check-label" for="<?=$service['id']?>"><?=$service['service']?></label>
						</div>
						<?php $countbox++ ?>
					<?php endforeach ?>
				</div>
			</div>
			<div class="row">
				<div class="col text-center text-orange">
					Changer la période
				</div>
			</div>
			<div class="row  justify-content-center">
				<div class="col-md-6 col-lg-4 col-xl-3">
					<div class="form-group">
						<label for="date-start">Du mois de</label>
						<input type="month" class="form-control" id="date-start" min="2018-01" max="<?=date('Y-m')?>" name="date-start" value="<?=$startDate->format('Y-m')?>">
					</div>
				</div>
				<div class="col-md-6 col-lg-4 col-xl-3">
					<div class="form-group">
						<label for="date-end">Au mois de </label>
						<input type="month" class="form-control" id="date-end" name="date-end" value="<?=$endDate->format('Y-m')?>">
					</div>
				</div>
				<div class="col-md-6 col-lg-4 col-xl-3 mt-4 pt-2 text-right">
					<button class="btn btn-primary" name="submit-service" type="submit">Afficher</button>
				</div>
			</div>


		</form>


	</div>
</div>

<div class="row justify-content-center">
	<div class="col-auto">
		<div class="border light-shadow p-3">
			<div class="bg-light-grey  border">
				<p class="text-center text-blue" id="relance">Demandes par service</p>

				<?php foreach ($graphAr as $key => $value): ?>
				<?php
					// 150 = haute de la zone de graph donc de la barre la plus grande
					$height=$graphAr[$key]*150 /$maxDde;
				 ?>
				<div class="graph-div text-center">
					<div class="graph-zone">
						<div class="bar" style="height:<?=$height?>px"></div>
						<p class="vertical-text "><?=$graphAr[$key]?></p>
					</div>
					<p class="graph-txt"><?=$key?></p>
				</div>
				<?php endforeach ?>
			</div>
		</div>
	</div>

</div>



<!-- on parcourt les années selectionnées de la date de  -->
<?php for($yearIndex=$startDate->format('Y'); $yearIndex<=$endDate->format('Y'); $yearIndex++): ?>
<?= $yearIndex?>
<div class="row ">
	<div class="col">
		<table class="table table-sm table-striped table-responsive-md servicetable" id="services<?= $yearIndex?>">
			<thead>
				<tr>
					<th class="sortable" onclick="sortTable(0);">Services</th>
					<!-- ./table -->
					<?php for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++): ?>
					<th class="text-right sortable" onclick="sortTable('services<?= $yearIndex?>',<?=$month?>);"><?=$monthsFr[$month]?></th>
				<?php endfor ?>
				<th class="text-right sortable" onclick="sortTable('services<?= $yearIndex?>',<?=$month?>);">TOTAL</th>
			</tr>
		</thead>
		<?php
		$newService='';
		$sumPerMonth=[];

		for($i=0;$i<count($sArr);$i++){
			for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++){

				if($sArr[$i]!=$newService){
					echo '</tr>';
					echo '<tr>';
					echo '<td class="text-right">'.$sArr[$i].'</td>';
					$newService=$sArr[$i];
					$sommeService=0;

				}
				if(isset($statServices[$yearIndex][$sArr[$i]][$month])){

					echo '<td class="text-right">'. $statServices[$yearIndex][$sArr[$i]][$month] .'</td>';
					$sommeService=$sommeService+$statServices[$yearIndex][$sArr[$i]][$month];
						// on en profite pour calculer la somme par mois en créant un nouveau tableau indexé par le numéro de mois
						// à chaque fois que nécessaire
					if(isset($sumPerMonth[$month])){
						$sumPerMonth[$month]+=$statServices[$yearIndex][$sArr[$i]][$month];
					}else{
						$sumPerMonth[$month]=$statServices[$yearIndex][$sArr[$i]][$month];

					}

				}else{
					echo '<td class="text-right">0</td>';
				}
				if($month==getEndMonth($period[$yearIndex])){
					echo '<td class="text-right font-weight-bold" >'.$sommeService.'</td>';
				}
			}

		}

		?>
	</tr>
	<tfoot>
		<tr class="font-weight-bold">
			<td class="text-right">TOTAL</td>
			<?php for($month=getStartMonth($period[$yearIndex]);$month<=getEndMonth($period[$yearIndex]);$month++): ?>
			<td class="text-right"><?=$sumPerMonth[$month]?></td>
		<?php endfor?>
		<td class="text-right"><?=array_sum($sumPerMonth)?></td>
	</tr>
</tfoot>
</table>
</div>
</div>
<?php endfor ?>

