<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}
require '../../Class/Db.php';

//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
require_once '../../Class/DroitDao.php';
require_once '../../Class/UserHelpers.php';
require_once '../../Class/UserDao.php';



//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);


 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];

$db=new Db();
$pdoUser=$db->getPdo('web_users');
// SELECT users.login, users.galec, id_user,id_droit, fonction, service, intern_users.id_group, id_service FROM `attributions` LEFT JOIN users ON id_user= users.id
// LEFT JOIN droits ON id_droit=droits.id
// LEFT JOIN intern_users ON id_user=intern_users.id_web_user
// LEFT JOIN services ON intern_users.id_service= services.id
// WHERE users.id_type=1 ORDER BY login, id_droit

$listUserType=UserHelpers::listUserType($pdoUser);
$listDroits=UserHelpers::listDroit($pdoUser);
$listService=UserHelpers::listService($pdoUser);
$listServiceGroup=UserHelpers::listServiceGroup($pdoUser);


$droitDao=new DroitDao($pdoUser);
$userDao=new UserDao($pdoUser);

$listDroits=$droitDao->listDroits();
$listAttributionTypeSav=$droitDao->getAttributionByType(3);
$listAttributionTypeBt=$droitDao->getAttributionByType(1);
$listAttributionTypeMag=$droitDao->getAttributionByType(2);
$listAttributionTypeAdh=$droitDao->getAttributionByType(4);
$listAttributionTypeCentrale=$droitDao->getAttributionByType(5);
$listAttributionTypeFou=$droitDao->getAttributionByType(6);
$listAttributionTypeLcom=$droitDao->getAttributionByType(7);
$listAttributionTypeTrans=$droitDao->getAttributionByType(10);


$listAttributionSav=$droitDao->getAttributionUsersByType(3);



if (isset($_POST['id_service'])) {

	$listServiceAttrib=$userDao->getUserAttributionsByService($_POST['id_service']);

}
$user="";

//------------------------------------------------------
//			FONCTION
//------------------------------------------------------

// 982
//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container">
	<h1 class="text-main-blue py-5 ">Droits</h1>

	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="row">
		<div class="col">
			<ul>
				<li><a href="#type-user">type user</a></li>
				<li><a href="#droit-mag">liste droits existants pour mag</a></li>
				<li><a href="#droit-bt">liste droits existants pour bt</a></li>
				<li><a href="#droit-sav">liste droits existants pour sav</a></li>
				<li><a href="#droit-fou">liste droits existants pour fournisseurs</a></li>
				<li><a href="#attrib-sav">Liste droit utilisateur sav</a></li>
				<li><a href="#droits">Liste droits</a></li>
			</ul>
		</div>
	</div>

	<div class="row">
		<div class="col">
			Liste des droits
		</div>
	</div>

	<div class="row">
		<div class="col">

			<table class="table table-sm">
				<thead class="thead-dark">
					<tr>
						<th>id</th>
						<th>Droit</th>
						<th>Description</th>
						<th>Module</th>
					</tr>
				</thead>
				<tbody>


					<?php foreach ($listDroits as $key => $droit): ?>
						<?php
						$class="";
						if($droit['id_appli']==1){
							$class="text-main-blue";
						}elseif($droit['id_appli']==3){
							$class="text-orange";

						}elseif($droit['id_appli']==5){
							$class="text-green";

						}elseif($droit['id_appli']==6){
							$class="text-red";
						}elseif($droit['id_appli']==29){
							$class="text-blue-flashy";
						}

						?>
						<tr class="<?=$class?>">
							<td><?=$droit['id']?></td>
							<td><?=$droit['fonction']?></td>
							<td><?=$droit['description']?></td>
							<td><?=$droit['id_module']?></td>
						</tr>
					<?php endforeach ?>
				</tbody>
			</table>

		</div>
	</div>
	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits par services</h5>

		</div>

	</div>
	<div class="row">

		<div class="col-3">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post">

				<div class="form-group">
					<label for="id_service"></label>
					<select class="form-control" name="id_service" id="id_service" onchange='this.form.submit()'>
						<option value="">Sélectionner</option>
						<?php foreach ($listService as $keyService => $value): ?>
							<option value="<?=$keyService?>"><?=$listService[$keyService]?></option>
						<?php endforeach ?>
					</select>
				</div>
			</form>

		</div>
	</div>
	<?php if (isset($listServiceAttrib) && !empty($listServiceAttrib)): ?>
	<div class="row">
		<div class="col text-center">
			Service <?=$listService[$_POST['id_service']]?>
		</div>
	</div>

	<div class="row">
		<div class="col">

			<table class="table table-sm">
				<thead class="thead-dark">
					<tr>
						<th>id_web_user</th>
						<th>Nom</th>
						<th>id droit</th>
						<th>Droit</th>
					</tr>
				</thead>
				<tbody>
					<?php foreach ($listServiceAttrib as $attrib): ?>
						<?php if ($user !=$attrib['id_web_user']): ?>
							<tr>
								<td><?=$attrib['id_web_user']?></td>
								<td><?=$attrib['prenom']. ' ' .$attrib['nom']?></td>
								<td><?=$attrib['id_droit']?></td>
								<td><?=$attrib['fonction']?></td>
							</tr>
							<?php else: ?>
								<tr>
									<td></td>
									<td></td>
									<td><?=$attrib['id_droit']?></td>
									<td><?=$attrib['fonction']?></td>
								</tr>
							<?php endif ?>
							<?php $user=$attrib['id_web_user'] ?>

						<?php endforeach ?>

					</tbody>
				</table>²
			</div>
		</div>
	<?php endif ?>

	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Type d'utilisateurs</h5>
		</div>
	</div>
	<div class="row" id="type-user">
		<div class="col four-col">
			<?php if (!empty($listUserType)): ?>
				<?php foreach ($listUserType as $keyType => $value): ?>
					<?=$keyType . '- '.$listUserType[$keyType]?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits BT</h5>
		</div>
	</div>
	<div class="row" id="droit-mag">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeBt)): ?>
				<?php foreach ($listAttributionTypeBt as $key => $droitBt): ?>
					<?= $droitBt['id_droit']. ' ' . $droitBt['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>

	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits SAV</h5>
		</div>
	</div>
	<div class="row" id="droit-sav">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeSav)): ?>
				<?php foreach ($listAttributionTypeSav as $key => $droitSav): ?>
					<?= $droitSav['id_droit']. ' ' . $droitSav['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>


	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits Mag</h5>
		</div>
	</div>
	<div class="row" id="droit-sav">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeMag)): ?>
				<?php foreach ($listAttributionTypeMag as $key => $droitMag): ?>
					<?= $droitMag['id_droit']. ' ' . $droitMag['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>

	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits Adh</h5>
		</div>
	</div>
	<div class="row" id="droit-sav">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeAdh)): ?>
				<?php foreach ($listAttributionTypeAdh as $key => $droitAdh): ?>
					<?= $droitAdh['id_droit']. ' ' . $droitAdh['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>

	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits Centrale</h5>
		</div>
	</div>
	<div class="row" id="droit-sav">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeCentrale)): ?>
				<?php foreach ($listAttributionTypeCentrale as $key => $droitCentrale): ?>
					<?= $droitCentrale['id_droit']. ' ' . $droitCentrale['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>

	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits Fou</h5>
		</div>
	</div>
	<div class="row" id="droit-sav">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeFou)): ?>
				<?php foreach ($listAttributionTypeFou as $key => $droitFou): ?>
					<?= $droitFou['id_droit']. ' ' . $droitFou['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits Lcom</h5>
		</div>
	</div>
	<div class="row" id="droit-sav">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeLcom)): ?>
				<?php foreach ($listAttributionTypeLcom as $key => $droitLcom): ?>
					<?= $droitLcom['id_droit']. ' ' . $droitLcom['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<h5 class="pt-5 pb-2">Droits Trans</h5>
		</div>
	</div>
	<div class="row" id="droit-sav">
		<div class="col four-col">
			<?php if (!empty($listAttributionTypeTrans)): ?>
				<?php foreach ($listAttributionTypeTrans as $key => $droitTrans): ?>
					<?= $droitTrans['id_droit']. ' ' . $droitTrans['fonction']?><br>
				<?php endforeach ?>
			<?php endif ?>
		</div>
	</div>



	<div class="row">
		<div class="col">
			<h5>droits utilisateurs sav</h5>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<?php if (!empty($listAttributionSav)): ?>

				<table class="table table-sm" id="attrib-sav">
					<thead class="thead-dark">
						<tr>
							<th>id attribution</th>
							<th>id_web_user</th>
							<th>login</th>
							<th>id_droit</th>
							<th>nom droit</th>
						</tr>
					</thead>
					<tbody>
						<?php foreach ($listAttributionSav as $key => $attrib): ?>

							<tr>
								<td><?=$attrib['id']?></td>
								<td><?=$attrib['id_user']?></td>
								<td><?=$attrib['login']?></td>
								<td><?=$attrib['id_droit']?></td>
								<td><?=$attrib['fonction']?></td>
							</tr>
						<?php endforeach ?>

					</tbody>
				</table>
			<?php endif ?>

		</div>
	</div>
	<div class="row">
		<div class="col five-col" id="droits">
			<?php if (!empty($listDroits)): ?>
				<?php foreach ($listDroits as $keyDroit => $value): ?>
					<?=$keyDroit . ' '.$listDroits[$keyDroit]?><br>
				<?php endforeach ?>

			<?php endif ?>
		</div>
	</div>


	<!-- ./container -->
</div>

<?php
require '../view/_footer-bt.php';
?>