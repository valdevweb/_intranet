<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


require '../../Class/Db.php';
require '../../Class/BatchDao.php';
// require_once '../../vendor/autoload.php';


$errors=[];
$success=[];
$db=new Db();
$pdoUser=$db->getPdo('web_users');
$pdoEvo=$db->getPdo('evo');

$batchDao=new BatchDao($pdoEvo);

if(!isset($_POST['date'])){
	$date=date('Y-m-d');
}else{
	$date=$_POST['date'];
}

$param=" AND DATE_FORMAT( date_insert, '%Y-%m-%d') = '".$date."'";

$listErrors=$batchDao->getBatchError($param);


if(isset($_POST['save'])){
	$id=$_POST['save'];
	echo $id;
	if(isset($_POST['clos']) && isset($_POST['clos'][$id])){
		$done=1;
	}else{
		$done=0;
	}
	$batchDao->updateError($id, $done, $_POST['cmt'][$id]);
	$successQ='?success';
	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);

}



//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>

<div class="container-fluid bg-white">
	<div class="row py-5">
		<div class="col">
			<h1 class="text-main-blue">Batch Monitoring</h1>
		</div>
	</div>
	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="row">
		<div class="col"></div>
		<div class="col-auto">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post">
				<div class="form-group">
					<label for="date">Date</label>
					<input type="date" class="form-control" name="date" id="date" onchange='this.form.submit()' value="<?=isset($_POST['date'])?$_POST['date']:""?>">
				</div>
			</form>
		</div>
		<div class="col"></div>

	</div>
	<div class="row">
		<div class="col-1"></div>
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post">

				<?php if (isset($listErrors)): ?>

					<table class="table table-sm">
						<thead class="thead-dark">
							<tr>
								<th>id</th>
								<th>Appli</th>
								<th>Batch</th>
								<th>ligne</th>
								<th>Erreur</th>
								<th>Cmt</th>
								<th>Cloturer</th>
								<th>Enregistrer</th>
							</tr>
						</thead>
						<tbody>
							<?php foreach ($listErrors as $key => $error): ?>
								<tr>

									<td><?=$error['id']?></td>
									<td><?=$error['appli']?></td>
									<td><?=$error['page']?></td>
									<td><?=$error['id_table']?></td>

									<td><?=$error['msg']?></td>
									<td>
										<div class="form-group">
											<input type="text" class="form-control" name="cmt[<?=$error['id']?>]"  value="<?=$error['cmt']?>">
										</div>
									</td>
									<td>
										<div class="form-check">
											<input class="form-check-input" type="checkbox" value="1" name="clos[<?=$error['id']?>]">
											<label class="form-check-label">Cloturer</label>
										</div>
									</td>
									<td>
										<button class="btn btn-primary" type="submit" name="save" value="<?=$error['id']?>">Enregistrer</button>
									</td>
								</tr>

							<?php endforeach ?>
						</tbody>
					</table>
				</form>

			<?php endif ?>
		</div>
		<div class="col-1"></div>

	</div>

</div>

<?php
require '../view/_footer-bt.php';
?>