<?php



if(!isset($_FILES['opp_files']['tmp_name'][0]) || empty($_FILES['opp_files']['tmp_name'][0])){
		$errors[]="Vous devez sélectionner au moins un fichier pour l'opportunité";
	}
	foreach ($notMandatoryFields as $key => $field) {
		if(empty($_POST[$field['field']])){
			$errors[]=$field['warning'];
		}
	}

	if(isset($_FILES['opp_files']['tmp_name'][0]) && !empty($_FILES['opp_files']['tmp_name'][0])){

		for ($i=0; $i <count($_FILES['opp_files']['tmp_name']) ; $i++) {
			$orginalFilename=$_FILES['opp_files']['name'][$i];
			$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);

			$filenameNoExt = basename($orginalFilename, '.'.$ext);
			$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
			// echo $filename;
			// echo "<br>";
			$uploaded=move_uploaded_file($_FILES['opp_files']['tmp_name'][$i],DIR_UPLOAD_OPP.$filename );
			if($uploaded==false){
				$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée";
			}else{
				$listFilenameOpp[]=$filename;
			}
		}
	}

	if(isset($_FILES['addons_files']['tmp_name'][0]) &&  !empty($_FILES['addons_files']['tmp_name'][0])){

		for ($i=0; $i <count($_FILES['addons_files']['tmp_name']) ; $i++) {
			$orginalFilename=$_FILES['addons_files']['name'][$i];
			$ext = pathinfo($orginalFilename, PATHINFO_EXTENSION);
			$filenameNoExt = basename($orginalFilename, '.'.$ext);
			$filename = str_replace(' ', '_', $filenameNoExt) . '_' . time() . '.' . $ext;
			// echo $filename;
			// echo "<br>";
			$uploaded=move_uploaded_file($_FILES['addons_files']['tmp_name'][$i],DIR_UPLOAD_OPP.$filename );
			if($uploaded==false){
				$errors[]="Nous avons rencontré avec votre fichier, votre demande n'a pas pu être enregistrée 2";
			}else{
				$listFilenameAddons[]=$filename;
			}
		}
	}

	if(empty($errors)){
		$idOpp=$oppDao->addOpportunite();
		if(isset($idOpp)&& ($idOpp>0)){
			for ($i=0; $i < count($listFilenameOpp); $i++) {
				$ext = pathinfo($listFilenameOpp[$i], PATHINFO_EXTENSION);
				$image=(in_array(strtolower($ext),$imgExt))? 1:0;
				$oppDao->addMainFile($idOpp,$listFilenameOpp[$i],$image,$i);
			}
			if(isset($_POST['icons'])){
				$oppDao->addIcons($idOpp,$_POST['icons']);
			}
			if(!empty($listFilenameAddons)){
				for ($i=0; $i < count($listFilenameAddons); $i++) {
					$oppDao->addAddonsFile($idOpp,$listFilenameAddons[$i], $_POST['intitule'][$i]);
				}
			}
			header("Location: opp-preview.php?id=".$idOpp,true,303);

		}else{
			$errors[]="Une erreur est survenue, impossible d'enregistrer l'opportunité";
		}
	}
