<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}
require '../../config/db-connect.php';

//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
require_once '../../vendor/autoload.php';
require_once '../../Class/OccPaletteMgr.php';



//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);

function addImport($pdoOcc, $filename, $maxPalette, $dateEndLimite){
	$req=$pdoOcc->prepare("INSERT INTO import_excel( filename, max_palette, date_end_limite, date_import, id_web_user) VALUES  (:filename, :max_palette, :date_end_limite, :date_import, :id_web_user)");
	$req->execute([
		':filename'		=> $filename,
		':max_palette'	=>$maxPalette,
		':date_end_limite'		=>$dateEndLimite,
		':date_import'		=>date('Y-m-d H:i:s'),
		':id_web_user'		=>$_SESSION['id_web_user']
	]);

	return $pdoOcc->lastInsertId();
}

function addPalette($pdoOcc, $palette, $idImport){
	$req=$pdoOcc->prepare("INSERT INTO palettes (palette, statut, import, date_crea) VALUES  (:palette, :statut, :import, :date_crea)");
	$req->execute([
		':palette'		=>$palette,
		':statut'		=>1,
		':import'		=>$idImport,
		':date_crea'	=>date('Y-m-d H:i:s'),
	]);
	return $pdoOcc->lastInsertId();
}
function insertArticle($pdoOcc, $idPalette, $idImport,$articlePalette, $designation,$ean, $qte, $pa, $pvc, $marge)	{
	$req=$pdoOcc->prepare("INSERT INTO palettes_articles (id_palette, id_import, article_palette, designation, ean, quantite, pa, pvc, marge, date_insert) VALUES  (:id_palette, :id_import, :article_palette, :designation, :ean, :quantite, :pa, :pvc, :marge, :date_insert)");
	$req->execute([
		':id_palette'	=>$idPalette,
		':id_import'	=>$idImport,
		':article_palette'	=>$articlePalette,
		':designation'	=>$designation,
		':ean'	=>$ean,
		':quantite'	=>$qte,
		':pa'	=>$pa,
		':pvc'	=>$pvc,
		':marge'	=>$marge,
		':date_insert'	=>date('Y-m-d H:i:s'),
	]);
	return $pdoOcc->lastInsertId();
}


function getAssortiment($pdoOcc){
	$req=$pdoOcc->query(" SELECT articles_qlik.*, cmt, file FROM articles_qlik
		LEFT JOIN articles_qlik_cmt ON articles_qlik.article_qlik= articles_qlik_cmt.article
		LEFT JOIN fiche_prod ON articles_qlik.article_qlik= fiche_prod.article WHERE qte_qlik !=0 ORDER BY article_qlik");
	return $req->fetchAll();
}

function insertPaletteCmt($pdoOcc){
	$req=$pdoOcc->prepare("INSERT INTO import_cmt (id_import, cmt, date_insert, date_end) VALUES (:id_import, :cmt, :date_insert, :date_end)");
	$req->execute([
		':id_import'=>$_POST['import'],
		':cmt'	=>$_POST['palettes-cmt'],
		':date_insert'	=>date('Y-m-d H:i:s'),
		':date_end'	=>$_POST['date-end']
	]);
	// return $req->errorInfo();
}


function addFicheProd($pdoOcc, $article, $file){
	$req=$pdoOcc->prepare("INSERT INTO fiche_prod (article, file) VALUES (:article, :file)");
	$req->execute([
		':article'		=>$article,
		':file'			=>$file
	]);
	return $req->rowCount();
}

 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];
$occPaletteDao=new OccPaletteMgr($pdoOcc);
use PhpOffice\PhpSpreadsheet\Spreadsheet;
use PhpOffice\PhpSpreadsheet\Writer\Xlsx;


$listAssortiment=getAssortiment($pdoOcc);

$listImport=$occPaletteDao->getListImport();
$listCmt=$occPaletteDao->getListCmtImport();
$listPaletteImport=$occPaletteDao->getListPaletteByStatut(1);
$arCmt=[];

foreach ($listCmt as $key => $cmt) {
	$arCmt[$cmt['id_import']]['cmt'][]=$cmt['cmt'];
	$arCmt[$cmt['id_import']]['id'][]=$cmt['id'];

}



// import des connées excel :
// table occ_import excel => recup id
// table palette => 1 pour import
// table occ_article => recup les id palette.....


if(isset($_POST['send'])){
	if(!empty($_POST['max_palette']) && empty($_POST['date_end_limite'])){
		$errors[]="Si vous limitez la quantité de palette, vous devez préciser à quelle date cette limite devra être otée";
	}
	if($_FILES['file']['error']===0 && empty($errors)){
		$uploadDir=DIR_UPLOAD."excel\\";
		$filename=new SplFileInfo($_FILES['file']['name']);

		if(!move_uploaded_file($_FILES['file']['tmp_name'],$uploadDir.$filename)){
			$errors[]="erreur d'upload, le fichier n'a pas pu être enregistré";
		}


		if(empty($errors)){

			$reader = \PhpOffice\PhpSpreadsheet\IOFactory::createReader('Xlsx');
			$reader->setReadDataOnly(TRUE);

			$path=DIR_UPLOAD."\\excel\\";
			$fxls=$path.$filename;
			$spreadsheet = $reader->load($fxls);
			$worksheet = $spreadsheet->getActiveSheet();
			$highestRow = $worksheet->getHighestRow();
			// 1 ajout fichier dans table imporyt et recup id
			$maxPalette=(empty($_POST['max_palette']))? null: $_POST['max_palette'];
			$dateEndLimite=(empty($_POST['date_end_limite']))? null: $_POST['date_end_limite'];
			$idImport=addImport($pdoOcc, $filename,$maxPalette, $dateEndLimite );

			$firstPalette=true;
			for ($row = 2; $row <=$highestRow; ++$row){
					// $worksheet->unmergeCells('A29:C35');
				$ean=$worksheet->getCell('A' . $row)->getValue();
				$libelle=$worksheet->getCell('B' . $row)->getValue();
				$qte=$worksheet->getCell('C' . $row)->getValue();
				$palette=$worksheet->getCell('D' . $row)->getValue();
				$arPalette[]=$palette;
				$pa=$worksheet->getCell('E' . $row)->getValue();
				$pvc=$worksheet->getCell('F' . $row)->getValue();
				$taux=$worksheet->getCell('G' . $row)->getValue();
				$articlePalette=$worksheet->getCell('H' . $row)->getValue();
				$excelData[]=
				[
					'ean'	=>$ean,
					'libelle'	=>$libelle,
					'qte'		=>$qte,
					'palette'	=>$palette,
					'pa'		=>$pa,
					'pvc'		=>$pvc,
					'taux'		=>round(($taux*100),2),
					'article_palette'		=>$articlePalette,
				];

			}


			//ajout dans table palete et recup id et créa tableau palette
			$arPalette=array_unique($arPalette);
			$arPalette = array_values($arPalette);


			for($i=0;$i<count($arPalette); $i++){
				$idPalette=addPalette($pdoOcc, $arPalette[$i], $idImport);
				$newArPalette[$arPalette[$i]]=$idPalette;

			}


			foreach ($excelData as $key => $data) {
				insertArticle($pdoOcc, $newArPalette[$data['palette']], $idImport, $data['article_palette'],  $data['libelle'],$data['ean'], $data['qte'], $data['pa'], $data['pvc'], $data['taux']);
			}

		}

		$successQ='?success=import';
		unset($_POST);
		header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
	}


}

if(isset($_POST['insert_global_cmt'])){
	if(empty($_POST['palettes-cmt'])||empty($_POST['date-end']) || empty($_POST['import'])){
		$errors[]="Merci de remplir tous les champs";
	}
	if(empty($error)){

		$done=insertPaletteCmt($pdoOcc);
		$successQ='?success=cmt';
		unset($_POST);
		header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
	}
}



if(isset($_POST['add-file'])){
	$uploadDir=DIR_UPLOAD."\\occasion\\";
	foreach ($_FILES['file']['name'] as $keyFile => $value) {
		if(!empty($_FILES['file']['name'][$keyFile])){
			$uploaded=move_uploaded_file($_FILES['file']['tmp_name'][$keyFile],$uploadDir.$_FILES['file']['name'][$keyFile]);
			addFicheProd($pdoOcc, $_POST['article'][$keyFile], $_FILES['file']['name'][$keyFile]);
		}
	}

	unset($_POST);
	header("Location: ".$_SERVER['PHP_SELF'],true,303);
}



if(isset($_GET['mask'])){
	$req=$pdoOcc->prepare("UPDATE import_excel SET mask= 1 WHERE id=:id");
	$req->execute([
		':id'		=>$_GET['mask']
	]);

	$successQ='#cmt-import';

	header("Location: ".$_SERVER['PHP_SELF'].$successQ,true,303);
}

if(isset($_GET['success'])){
	$arrSuccess=[
		'cmt'=>'Commentaire ajouté avec succès',
		'import'=>'le fichier a été traité avec succès',

	];
	$success[]=$arrSuccess[$_GET['success']];
}


//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container">
	<div class="row">
		<div class="col">
			<h1 class="text-main-blue py-3">Gestion GT occasion </h1>
		</div>
	</div>
	<div class="row mb-5">
		<div class="col text-center">
			<a href="#nav-article" class="mini-nav">Gestion articles</a>
			<a href="#nav-import" class="mini-nav">Gestion des fichiers imports</a>
			<a href="#nav-palette" class="mini-nav">Gestion des palettes</a>
			<a href="#nav-import" class="mini-nav">Import fichiers</a>
		</div>
	</div>

	<div class="row">
		<div class="col-lg-1"></div>
		<div class="col">
			<?php
			include('../view/_errors.php');
			?>
		</div>
		<div class="col-lg-1"></div>
	</div>
	<div class="bg-separation mb-3"></div>


	<div class="row">
		<div class="col">
			<h4 class="text-main-blue" id="nav-article">Ajout de commentaires et de fiches produits</h4>

			<div class="alert alert-primary">
				Veuillez saisir les commentaires directement dans le tableau. Ils s'enregistrent au fur et à mesure de la saisie
			</div>
		</div>
	</div>


	<div class="row ">
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post" enctype="multipart/form-data">

				<table class="table table-sm">
					<thead class="thead-dark">
						<tr>
							<th class="article">Article</th>

							<th >Désignation</th>
							<th >Fournisseur</th>
							<th class="ean">EAN</th>
							<th class="text-center">Commentaires</th>
							<th><i class="fas fa-file-pdf"></i></th>

						</tr>
					</thead>
					<tbody>
						<?php foreach ($listAssortiment as $key => $assor): ?>
							<tr>
								<td ><?=$assor['article_qlik']?></td>
								<td><?=$assor['design_qlik']?></td>
								<td><?=$assor['fournisseur_qlik']?></td>
								<td><?=$assor['ean_qlik']?></td>
								<td contenteditable="true" class="cmt" id="<?=$assor['article_qlik']?>"><?=$assor['cmt']?></td>
								<td>
									<?php if (isset($assor['file'])): ?>
										<a href="<?=URL_UPLOAD.'occasion/'.$assor['file'] ?>" target="_blank"><i class="fas fa-file-pdf fa-lg pt-2"></i></a>
									<?php endif ?>

								</td>



							</tr>
							<?php if (!isset($assor['file'])): ?>
								<tr class="bg-light-grey">

									<td colspan="6">
										<div class="row">
											<div class="col-auto">
												Ajouter une fiche technique :

											</div>

											<div class="col-auto">

												<label class="btn btn-upload btn-file text-center">
													<input type="file" name="file[<?=$key?>]" data="<?=$key?>" class='form-control-file'>Sélectionner

													<input type="hidden" name="article[<?=$key?>]" value="<?=$assor['article_qlik']?>">
												</label>

											</div>
											<div class="col" class="msg" id="filename_<?=$key?>" ></div>
											<div class="col-auto">
												<button class="btn btn-primary hidden" name="add-file" id="<?=$key?>">Envoyer</button>
											</div>
										</div>


									</td>
								</tr>
							<?php endif ?>

						<?php endforeach ?>

					</tbody>
				</table>
			</form>
		</div>
	</div>
	<div class="bg-separation mb-3"></div>
	<div class="row my-3">
		<div class="col">
			<h4 class="text-main-blue" id="nav-import">Ajout de commentaires par fichier d'import </h4>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post">
				<div class="row">
					<div class="col">
						<div class="form-group">
							<label for="import"></label>
							<select class="form-control" name="import" id="import" required>
								<option value="">Sélectionner un import</option>
								<?php foreach ($listImport as $key => $import): ?>
									<option value="<?=$import['id']?>"><?=$import['filename']?></option>
								<?php endforeach ?>

							</select>
						</div>
					</div>
					<div class="col"></div>
				</div>
				<div class="row">
					<div class="col">
						<div class="form-group">
							<label for="palettes-cmt">Commentaire :</label>
							<textarea class="form-control" name="palettes-cmt" id="palettes-cmt" required></textarea>
						</div>
					</div>
					<div class="col-lg-3">
						<div class="form-group">
							<label for="date-end">Date de fin</label>
							<input type="date" class="form-control" name="date-end" id="date-end" required>
						</div>
					</div>
				</div>

				<div class="row mb-3">
					<div class="col text-right"><button class="btn btn-primary" name="insert_global_cmt">Valider</button></div>
				</div>
			</form>
		</div>
	</div>
	<div class="row">
		<div class="col">
			<h5 class="text-main-blue" id="cmt-import">Commentaires actuels</h5>
			<div class="alert alert-info">
				Pour ne plus afficher un fichier d'import dans la liste déroulante "ajout de commentaires par fichier d'import" et dans le tableau des commentaire, vous pouvez le masquer en cliquant sur l'icône <i class="fas fa-eye-slash"></i>
			</div>
		</div>
	</div>
	<div class="row">
		<div class="col">

			<table class="table table-sm">
				<thead class="thead-dark">
					<tr>
						<th>#</th>
						<th>Fichier</th>
						<th>Date import</th>
						<th>Commentaires</th>
						<th>Masquer</th>
					</tr>
				</thead>
				<tbody>
					<?php foreach ($listImport as $key => $import): ?>

						<tr>
							<td><?=$import['id']?></td>
							<td><?=$import['filename']?></td>
							<td><?=date('d-m-Y', strtotime($import['date_import']))?></td>
							<td>
								<?php if (isset($arCmt[$import['id']])): ?>
									<?php for($i=0; $i< count($arCmt[$import['id']]['cmt']);$i++): ?>
										<?=$arCmt[$import['id']]['cmt'][$i]?><br>
									<?php endfor ?>
								<?php endif ?>
							</td>
							<td><a href="?mask=<?=$import['id']?>"><i class="fas fa-eye-slash"></i></a></td>
						</tr>
					<?php endforeach ?>

				</tbody>
			</table>
		</div>
	</div>
	<div class="bg-separation mb-3"></div>
	<div class="row my-3">
		<div class="col">
			<h4 class="text-main-blue" id="nav-palette">Ajout de commentaires sur une palette </h4>
		</div>
	</div>

	<?php if (isset($listPaletteImport)): ?>
		<div class="row">
			<div class="col">

				<table class="table table-sm">
					<thead class="thead-dark">
						<tr>
							<th>Fichier import</th>
							<th>Palette</th>
							<th>Commentaire</th>
						</tr>
					</thead>
					<tbody>


						<?php foreach ($listPaletteImport as $key => $palette): ?>
							<tr>
								<td class="import"><?=$palette['filename']?></td>
								<td class="article text-right"><?=$palette['palette']?></td>
								<td contenteditable="true" class="cmt-palette" id="<?=$palette['id']?>"><?=$palette['cmt_palette']?></td>
							</tr>
						<?php endforeach ?>
					</tbody>
				</table>
			<?php endif ?>
		</div>
	</div>
	<div class="bg-separation mb-3"></div>
	<div class="row">
		<div class="col">
			<h4 class="text-main-blue" id="nav-import">Import fichiers palettes GT occasion</h4>
		</div>
	</div>

	<div class="row">
		<div class="col">
			<form action="<?= htmlspecialchars($_SERVER['PHP_SELF'])?>" method="post" enctype="multipart/form-data" name="files">
				<div class="row">
					<div class="col">
						<div class="alert alert-secondary">
							Pour limiter le nombre de palettes commandables par magasin pendant une periode donnée sur un fichier d'import, saisissez la quantité limite et la date à partir de laquelle, la limitation est levée
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-auto">
						<div class="form-group">
							<label for="max_palette">Quantité limite :</label>
							<input type="text" class="form-control" name="max_palette" id="max_palette">
						</div>
					</div>
					<div class="col-auto">
						<div class="form-group">
							<label for="date_end_limite">Commande libre à partir du : </label>
							<input type="date" class="form-control" name="date_end_limite" id="date_end_limite">
						</div>
					</div>
					<!-- <div class="col"></div> -->
				</div>
				<div class="row">
					<div class="col">
						<div id="file-upload">
							<fieldset>
								<p class="pt-2">Document :</p>
								<div class="form-group">
									<p><input type="file" name="file" class='form-control-file' onchange='this.form.submit()'></p>
								</div>
							</fieldset>
						</div>
					</div>
				</div>
				<div class="row pt-4">
					<div class="col">
						<p class="text-right">
							<button type="submit" id="submit" class="btn btn-primary" name="send">Envoyer</button>
						</p>
					</div>
					<!-- <div class="col"></div> -->

				</div>

			</form>
		</div>
	</div>

	<!-- ./container -->
</div>

<script type="text/javascript">
	$(document).ready(function(){
		$('.cmt').click(function(){
			$(this).addClass('edit-mode');
		});
		$(".cmt").focusout(function(){
			console.log("edit");
			$(this).removeClass("edit-mode");
			var id = this.id;
			var value = $(this).text();

			$.ajax({
				url: 'ajax-cmt-article.php',
				type: 'post',
				data: { value:value, id:id },
				success:function(response){
					console.log('Save successfully');
				}
			});

		});

		$('.cmt-palette').click(function(){
			$(this).addClass('edit-mode');
		});
		$(".cmt-palette").focusout(function(){

			$(this).removeClass("edit-mode");
			var id = this.id;
			console.log("id" +id);
			var value = $(this).text();

			$.ajax({
				url: 'ajax-cmt-palette.php',
				type: 'post',
				data: { value:value, id:id },
				success:function(response){
					console.log(response);
				}
			});

		});

		$('input[type="file"]').change(function(e){
			var nbFiles=e.target.files.length;
			var idName=$(this).attr("data") ;
			console.log(idName);

			for (var i = 0; i < nbFiles; i++){
            // var fileName = e.target.files[0].name;
            filename=e.target.files[i].name;
            console.log(filename);



        }
        $('#filename_'+idName).empty();
        $('#filename_'+idName).append("<span class='alert-danger p-1'>Fichier sélectionné : " +filename + "</span>");
        $('#'+idName).removeClass('hidden');
        $('#'+idName).addClass('show');



    });

	});

</script>



<?php
require '../view/_footer-bt.php';
?>