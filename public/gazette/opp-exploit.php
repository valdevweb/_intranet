<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	echo "pas de variable session";

}
//			css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";


//------------------------------------------------------
//			REQUIRES
//------------------------------------------------------
// require_once '../../vendor/autoload.php';
require_once '../../Class/FormHelpers.php';
require_once '../../Class/OpportuniteDAO.php';



//---------------------------------------
//	ajout enreg dans stat
//---------------------------------------
// require "../../functions/stats.fn.php";
// addRecord($pdoStat,basename(__file__),'consultation', "fichiers d'info du service achats", 101);


 //------------------------------------------------------
//			DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];
$listFilenameOpp=[];
$listFilenameAddons=[];
$imgExt=['jpg', 'jpeg', 'png','gif'];
$oppDao=new OpportuniteDAO($pdoBt);
$listActiveOpp=$oppDao->getActiveOpp();




define("DIR_UPLOAD_OPP",DIR_UPLOAD."opportunites\\");
define("URL_UPLOAD_OPP",URL_UPLOAD."opportunites/");
$notMandatoryFields=[
	0 =>[
		'field' =>'salon',
		'warning'=>'Le champ salon doit être rempli'
	],
	1 =>[
		'field' =>'cata',
		'warning'=>'Le champ catalogue doit être rempli'
	],
	2 =>[
		'field' =>'title',
		'warning'=>'Le champ titre doit être rempli'
	],
	3 =>[
		'field' =>'date_start',
		'warning'=>'Vous devez saisir une date de mise en ligne'
	],

	4 =>[
		'field' =>'date_end',
		'warning'=>'Vous devez saisir une date de mise à dispo'
	]
];

$ico=["new", "tel", "brii"];

if(isset($_POST['add_new'])){
	// tests vide
	// include 'opp-exploit-save-new.php';
	echo "<pre>";
	print_r($_FILES);
	print_r($_POST);
	echo '</pre>';


}
//------------------------------------------------------
//			FONCTION
//------------------------------------------------------


//------------------------------------------------------
//			VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container-fluid bg-white">
	<div class="row">
		<div class="col-md-1 col-lg-2"></div>
		<div class="col">
			<h1 class="text-main-blue pt-5 pb-3">Opportunités</h1>
			<div class="row">
				<div class="col-lg-1"></div>
				<div class="col">
					<?php
					include('../view/_errors.php');

					?>
				</div>
				<div class="col-lg-1"></div>
			</div>
			<div class="row mb-3">
				<div class="col">
					<h4 class="text-main-blue">Liste des opportunités en cours</h4>
				</div>
			</div>
			<div class="row my-5">
				<div class="col-md-1"></div>
				<div class="col">
					<?php if (!empty($listActiveOpp)): ?>
						<table class="table table-sm light-shadow">
							<thead class="thead-light">
								<tr>
									<th>Titre</th>
									<th>Date limite</th>
									<th>GT</th>
									<th>Voir</th>
									<th>Modifier</th>
									<th>Supprimer</th>
								</tr>
							</thead>
							<tbody>
								<?php foreach ($listActiveOpp as $key => $activeOpp): ?>
									<tr>
										<td><?=$activeOpp['title']?></td>
										<td><?=date('d/m/Y', strtotime($activeOpp['date_end']))?></td>
										<td><?=($activeOpp['gt']==1)? "Multimédia" : "blanc"?></td>
										<td><a href="opp-preview.php?id=<?=$activeOpp['id']?>" class="btn btn-primary">Voir</a></td>
										<td><a href="opp-edit.php?id=<?=$activeOpp['id']?>" class="btn btn-primary">Modifier</a></td>
										<td><a href="opp-delete.php?id=<?=$activeOpp['id'] ?>" class="btn btn-danger delete-opp" >Supprimer</a></td>

									</tr>
								<?php endforeach ?>
							</tbody>
						</table>
						<?php else: ?>
							<div class="alert alert-secondary">Aucune opportunité n'est en cours</div>
						<?php endif ?>
					</div>
					<div class="col-md-1"></div>
				</div>
				<hr>
				<div class="row mb-3">
					<div class="col">
						<h4 class="text-main-blue">Ajouter une opportunité</h4>
					</div>
				</div>
				<div class="row pb-5">
					<div class="col border rounded light-shadow p-3 text-main-blue">
						<form method="post" enctype="multipart/form-data" name="new_opp" id="new_opp">
							<div class="row">
								<div class="col-xl-6">
									<div class="form-group">
										<label for="title">Titre de l'opportunité :</label>
										<input type="text" class="form-control" name="title" id="title" value="<?=FormHelpers::restorePost('title')?>">
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col">
									<div class="form-group">
										<label for="date_start">Date de début (mise en ligne)</label>
										<input type="date" class="form-control date-width" name="date_start" id="date_start"
										value="<?=(!isset($_POST['date_start']))? date('Y-m-d'): $_POST['date_start']?>">
									</div>
								</div>

								<div class="col">
									<div class="form-group">
										<label for="date_end">Date de fin (fin de remontée)</label>
										<input type="date" class="form-control date-width" name="date_end" id="date_end"
										value="<?=FormHelpers::restorePost('date_end')?>"
										>
									</div>
								</div>
							</div>
							<div class="row">

								<div class="col">
									<div class="form-group">
										<label for="salon">Numéro de salon :</label>
										<input type="text" class="form-control" name="salon" id="salon"
										value="<?=FormHelpers::restorePost('salon')?>"
										>
									</div>
								</div>
								<div class="col">
									<div class="form-group">
										<label for="cata">Catalogue :</label>
										<input type="text" class="form-control" name="cata" id="cata"
										value="<?=FormHelpers::restorePost('cata')?>"
										>
									</div>
								</div>
								<div class="col">
									<div class="form-group">
										<label for="dispo">Dispo entrepôt :</label>
										<input type="text" class="form-control" name="dispo" id="dispo"
										value="<?=FormHelpers::restorePost('dispo')?>"
										>
									</div>
								</div>
								<div class="col">
									<label>GT :</label>
									<div class="form-check">
										<input class="form-check-input" type="radio" value="0" id="gt-blanc" name="gt" <?=FormHelpers::checkChecked(0,'gt')?>>
										<label class="form-check-label" for="gt-blanc">Blanc</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="radio" value="1" id="gt-blanc" name="gt" <?=FormHelpers::checkChecked(1,'gt')?>>
										<label class="form-check-label" for="gt-blanc">Multimédia</label>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col">
									<div class="form-group">
										<label for="descr">Description :</label>
										<textarea class="form-control" name="descr" id="descr" row="3"><?=FormHelpers::restorePost('descr')?></textarea>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col">
									<p class="heavy pt-2">Ajouter des icônes :</p>

									<div class="form-check">
										<input class="form-check-input" type="checkbox" value="0" id="icon1" name="icons[]"
										<?=FormHelpers::checkCheckedArray(0,'icons')?>>
										<label class="form-check-label" for="icon1">Nouveauté</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" value="1" id="icon2" name="icons[]"
										<?=FormHelpers::checkCheckedArray(1,'icons')?>>

										<label class="form-check-label" for="icon2">TEL</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" value="2" id="icon3" name="icons[]"
										<?=FormHelpers::checkCheckedArray(2,'icons')?>>
										<label class="form-check-label" for="icon3">BRII</label>
									</div>
								</div>

							</div>
							<div class="row">
								<div class="col">
									<div class="row">
										<div class="col">
											<p class="heavy pt-2">Fichiers de l'opportunité :</p>
										</div>
									</div>
									<div class="row rounded bg-verylight-blue mx-1 pt-2">
										<div class="col">
											<div id="filelistopp">
												<span class="text-main-blue heavy">Fichier(s) sélectionnés : <br></span>
											</div>
										</div>
										<div class="col text-right align-self-end">
											<div class="form-group">
												<label class="btn btn-upload btn-file text-center">
													<input type="file" name="opp_files[]" class='form-control-file' multiple="">
													Sélectionner
												</label>
											</div>
											<div class="form-group">
												<input type="hidden" class="form-control" name="hidden_opp_size" id="hidden_opp_size">
											</div>
										</div>
									</div>
								</div>
								<div class="col">
									<div class="row">
										<div class="col mr-3">
											<p class="heavy pt-2">Pièces jointes :</p>
										</div>
									</div>
									<div class="row rounded bg-verylight-blue mx-1  pt-2">
										<div class="col">
											<div id="filelistaddon">
												<span class="text-main-blue heavy">Fichier(s) sélectionnés : <br></span>
											</div>
										</div>
										<div class="col text-right align-self-end">
											<div class="form-group">
												<label class="btn btn-upload btn-file text-center">
													<input type="file" name="addons_files[]" class='form-control-file' multiple="">
													Sélectionner
												</label>
											</div>
											<div class="form-group">
												<input type="hidden" class="form-control" name="hidden_addons_size" id="hidden_addons_size">
											</div>


										</div>
									</div>
								</div>
							</div>
							<div class="row mt-3">
								<div class="col"></div>
								<div class="col">
								</div>
							</div>
							<div class="row mt-3">
								<div class="col"></div>
								<div class="col" id="zone-intitule">

								</div>
							</div>
							<div class="row mt-5">
								<div class="col">
									<div class="file-error"></div>
								</div>
							</div>

							<div class="row">
								<div class="col">
									<div class="alert alert-warning">
										<i class="fas fa-lightbulb pr-3"></i>Pour sélectionner plusieurs fichiers, maintenez la touche CTRL appuyée
									</div>
								</div>
							</div>
							<div class="row">
								<div class="col"></div>
								<div class="col text-center">
									<div class="form-group">
										<input type="submit" class="btn btn-primary" name="add_new" id="add_new" value="Enregistrer">
									</div>
								</div>
								<div class="col pt-2">
									<div id="wait"></div>
								</div>
							</div>

						</form>
					</div>
				</div>

			</div>
			<div class="col-md-1 col-lg-2"></div>
		</div>




		<!-- ./container -->
	</div>
	<script type="text/javascript">

		$(document).ready(function(){


			function getReadableFileSizeString(fileSizeInBytes) {
				var i = -1;
				var byteUnits = [' ko', ' Mo', ' Go'];
				do {
					fileSizeInBytes = fileSizeInBytes / 1024;
					i++;
				} while (fileSizeInBytes > 1024);

				return Math.max(fileSizeInBytes, 0.1).toFixed(1) + byteUnits[i];
			};
			$('.delete-opp').click(function(){
				console.log("dddd");
				return confirm("Etes vous sûr de vouloir supprimer l'opportunité ?");
			});



			$('input[name="opp_files[]"]').change(function(){
				var totalSize=0;
				var fileName='';
				var fileList='';
				var nbFiles = $(this).get(0).files.length;


				for (var i = 0; i < nbFiles; ++i) {
					var fileSize=$(this).get(0).files[i].size;
					fileName=$(this).get(0).files[i].name;
					totalSize = totalSize+fileSize;
					fileList += fileName + '<br>';
				}


				$('#hidden_opp_size').val(totalSize);
				hiddenAddonSize=$('#hidden_addons_size').val();

				if(typeof(hiddenAddonSize)!="undefined" && hiddenAddonSize!=null && hiddenAddonSize!=0){
					totalSize=parseInt(hiddenAddonSize)+totalSize;
				}


				if(totalSize <= 52428800){
					$(".file-error").text("");
					$('input[type="submit"]').removeAttr('disabled','disabled');
					console.log("taille totale ok " + getReadableFileSizeString(totalSize));

				}else{
					$('input[type="submit"]').attr('disabled','disabled');
					$(".file-error").append("<div class='alert alert-danger'>Impossible de télécharger les fichiers vers le serveur, la taille totale des fichiers est de "+getReadableFileSizeString(totalSize)+". Vous ne pouvez pas dépasser 50Mo</div>");

				}

				titre='<p><span class="text-main-blue heavy">Fichier(s) sélectionnés: <br></span>'
				end='</p>';
				all=titre+fileList+end;
				$('#filelistopp').empty();

				$('#filelistopp').append(all);
				fileList="";
			});




			$('input[name="addons_files[]"]').change(function(){

				var totalSize=0;
				var fileName='';
				var fileList='';
				var nbFiles = $(this).get(0).files.length;
				var formGroup="<div class='form-group'>";
				var endDiv="</div>";
				var titre="<div class='text-main-blue heavy'>Donner un intitulé au fichier :</div>";
				$("#zone-intitule").empty();

				for (var i = 0; i < nbFiles; ++i) {
					var fileSize=$(this).get(0).files[i].size;
					fileName=$(this).get(0).files[i].name;
					totalSize = totalSize+fileSize;
					fileList += fileName + '<br>';

					var label="<label>"+fileName+"</label>";
					var input="<input type='text' class='form-control'  name='intitule[" +i +"]'>";

					$("#zone-intitule").append(titre+formGroup+label+input+endDiv);
				}

				$('#hidden_addons_size').val(totalSize);
				hiddenOppSize=$('#hidden_opp_size').val();

				if(typeof(hiddenOppSize)!="undefined" && hiddenOppSize!=null && hiddenOppSize!=0){
					totalSize=parseInt(hiddenOppSize)+totalSize;
				}


				if(totalSize <= 52428800){
					$(".file-error").text("");
					$('input[type="submit"]').removeAttr('disabled','disabled');
					console.log("taille totale ok "+ getReadableFileSizeString(totalSize));

				}else{
					$('input[type="submit"]').attr('disabled','disabled');
					$(".file-error").append("<div class='alert alert-danger'>Impossible de télécharger les fichiers vers le serveur, la taille totale des fichiers est de "+getReadableFileSizeString(totalSize)+". Vous ne pouvez pas dépasser 50Mo</div>");


					console.log("nb de fichier et taille totale NON ok. taille" +getReadableFileSizeString(totalSize));

				}
				titre='<p><span class="text-main-blue heavy">Fichier(s) sélectionnés : <br></span>'
				end='</p>';
				all=titre+fileList+end;
				$('#filelistaddon').empty();
				$('#filelistaddon').append(all);
				fileList="";


			});

			$("#new_opp").submit(function(){
				console.log("ddd");
				$("#wait" ).append('<i class="fas fa-spinner"></i>&nbsp;&nbsp;<span class="pl-3">Merci de patienter</span>')
			});


		});

	</script>
	<?php
	require '../view/_footer-bt.php';
	?>