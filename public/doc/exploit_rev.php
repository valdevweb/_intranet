<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
	header('Location:'. ROOT_PATH.'/index.php');
	exit();
}

require '../../config/db-connect.php';

//----------------------------------------------------------------
require "../../functions/stats.fn.php";
$descr="signaler la mise à dispo de nouveaux reversements";
$page=basename(__file__);
$action="consultation";
$code=101;
addRecord($pdoStat,$page,$action, $descr,$code);

//----------------------------------------------------------------
//			css dynamique
//----------------------------------------------------------------
// $page=basename(__file__);
$pageCss=explode(".php",$page);
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";

//header et nav bar
include ('../view/_head-bt.php');
include ('../view/_navbar.php');

//----------------------------------------------------------------
//			functions
//----------------------------------------------------------------
function getRevType($pdoBt)
{
	$req=$pdoBt->query("SELECT name, id FROM doc_type WHERE category='reversement' ORDER BY ordre");
	$req->execute();
	return $req->fetchAll(PDO::FETCH_ASSOC);
}
$revList=getRevType($pdoBt);

function addRev($pdoBt,$idType,$divers)
{
	$req=$pdoBt->prepare("INSERT INTO reversements (id_type,date_rev,date_info,divers) VALUES (:id_type,:date_rev,:date_info,:divers)");
	$req->execute(array(
		':id_type'	=>$idType,
		':date_rev'	=>$_POST['date_depot'],
		':date_info' =>date('Y-m-d H:i:s'),
		':divers'	=>$divers
	));
	return $req->rowCount();
}

// $nbTotalCheckBox=count($revList);
// $newCol=round($nbTotalCheckBox/2);
// $check=0;
$errors=[];
$success=[];
if(isset($_POST['submit']))
{
	if(isset($_POST['date_depot']) && !empty($_POST['date_depot']) && isset($_POST['form_rev_type']) && count($_POST['form_rev_type']) !=0)
	{
		$nbDoc=0;
		foreach ($_POST['form_rev_type'] as $revType)
		{
			if($revType==18)
			{
				$detail=$_POST['detail'];
				$done=addRev($pdoBt,$revType,$detail);
				if($done==1)
				{
					$nbDoc++;
				}
				else
				{
					$errors[]="Une info n'a pas pu être ajoutée";
				}
				// stats
				$descr="info sur reversement divers (".$detail.")";
				$action="ajout d'information";
				$code=210;
				addRecord($pdoStat,$page,$action, $descr,$code);
			}
			else
			{
				$detail="";
				$done=addRev($pdoBt,$revType,$detail);
				if($done==1)
				{
					$nbDoc++;
				}
				else
				{
					$errors[]="Une info n'a pas pu être ajoutée";
				}

					// stats
				$descr="info sur reversement doc_type : ".$revType;
				$action="ajout d'information";
				$code=210;
				addRecord($pdoStat,$page,$action, $descr,$code);
			}
		}
		if($nbDoc>1)
		{
			$success[]="Les dépôts de documents ont bien été pris en compte";
		}else{
			$success[]="Le dépôt de document a bien été pris en compte";
		}


	}
	else
	{
		$errors[]="incomplet";
	}

}







?>
<?php

//contenu
include('exploit_rev.ct.php');


// footer avec les scripts et fin de html
include('../view/_footer-bt.php');
?>