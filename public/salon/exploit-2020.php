<?php
require('../../config/autoload.php');
if(!isset($_SESSION['id'])){
  header('Location:'. ROOT_PATH.'/index.php');
  exit();
}
require '../../config/db-connect.php';

//      css dynamique
//----------------------------------------------------------------
$pageCss=explode(".php",basename(__file__));
$pageCss=$pageCss[0];
$cssFile=ROOT_PATH ."/public/css/".$pageCss.".css";

require_once '../../Class/FormationDAO.php';




function getListFournisseur($pdoBt){
  $req=$pdoBt->query("SELECT * FROM salon_fournisseurs");
  return $req->fetchAll(PDO::FETCH_ASSOC);

}

function getFournisseurParticipants($pdoBt, $idFournisseur){
  $req=$pdoBt->prepare("SELECT * FROM salon_fournisseurs_presence WHERE id_fournisseur = :id_fournisseur");
  $req->execute([
    ':id_fournisseur' =>$idFournisseur
  ]);
  return $req->fetchAll(PDO::FETCH_ASSOC);

}




$formationDOA=new FormationDAO($pdoBt);
$listCreneau=$formationDOA->getCreneaux($pdoBt);
$listInscrit=$formationDOA->getIncriptionByFormation($pdoBt, 1);

$listFournisseur=getListFournisseur($pdoBt);




// require_once '../../vendor/autoload.php';



//------------------------------------------------------
//      FONCTION
//------------------------------------------------------

//------------------------------------------------------
//      DECLARATIONS
//------------------------------------------------------
$errors=[];
$success=[];

//------------------------------------------------------
//      VIEW
//------------------------------------------------------
include('../view/_head-bt.php');
include('../view/_navbar.php');
?>
<!--********************************
DEBUT CONTENU CONTAINER
*********************************-->
<div class="container-fluid bg-white">

  <div class="row">
    <div class="col">
      <h1 class="text-main-blue pt-5 ">Salon BTLec 2020</h1>

    </div>
    <div class="col text-right"></div>

  </div>
  <div class="row">
    <div class="col-lg-1"></div>
    <div class="col">
      <?php
      include('../view/_errors.php');
      ?>
    </div>
    <div class="col-lg-1"></div>
  </div>
  <div class="row">
    <div class="col text-center">
      <a href="#badges pr-5">Badges fournisseur</a> - <a href="#badges-intern pr-5">Badges Internes</a> - <a href="#formation">Inscription formation</a>
    </div>
  </div>
  <div class="row mt-5 mb-3">
    <div class="col">
      <div class="text-main-blue heavy">
        <h4 id="badges">Inscriptions aux formations </h4>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col">

      <table class="table table-sm">
        <thead class="thead-dark text-small">
          <col><col><col><col><col><col><col>
          <col><col><col><col><col><col><col>
          <col><col><col>
          <tr class="bg-black">
            <th></th>
            <th colspan="8">Choix 1</th>
            <th colspan="8">Choix 2</th>
          </tr>
        </thead>

          <tr class="bg-black">
            <td>Magasin</td>
            <td colspan="<?=count($listCreneau)?>">Mardi</td>
            <td colspan="<?=count($listCreneau)?>">Mercredi</td>
            <td colspan="<?=count($listCreneau)?>">Mardi</td>
            <td colspan="<?=count($listCreneau)?>">Mercredi</td>
          </tr>
        <tbody>
          <tr class="text-small text-right">
            <td></td>
            <?php foreach ($listCreneau as $key => $creneau): ?>
              <td><?=$creneau['start'] .'<br>' .$creneau['end']?></td>
            <?php endforeach ?>
            <?php foreach ($listCreneau as $key => $creneau): ?>
              <td><?=$creneau['start'] .'<br>' .$creneau['end']?></td>
            <?php endforeach ?>
            <?php foreach ($listCreneau as $key => $creneau): ?>
              <td><?=$creneau['start'] .'<br>' .$creneau['end']?></td>
            <?php endforeach ?>
            <?php foreach ($listCreneau as $key => $creneau): ?>
              <td><?=$creneau['start'] .'<br>' .$creneau['end']?></td>
            <?php endforeach ?>
          </tr>
          <?php foreach ($listInscrit as $key => $inscr): ?>
            <tr class="text-right">
              <td class="text-left"><?=$inscr['deno']?></td>
              <td><?= ($inscr['id_creneau_1']==1 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_1']==2 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_1']==3 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_1']==4 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_1']==1 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_1']==2 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_1']==3 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_1']==4 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>

              <td><?= ($inscr['id_creneau_2']==1 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_2']==2 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_2']==3 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_2']==4 && $inscr['mardi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_2']==1 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_2']==2 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_2']==3 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>
              <td><?= ($inscr['id_creneau_2']==4 && $inscr['mercredi']=="1") ? $inscr['nb'] : ""?></td>

            </tr>


          <?php endforeach ?>
        </tbody>
      </table>
    </div>
  </div>
  <div class="row">
    <div class="col text-right">
      <a href="xl-formation.php"><button class="btn btn-green">Export Excel</button></a>
    </div>
  </div>
  <div class="row mt-5 mb-3">
    <div class="col">
      <div class="text-main-blue heavy">
        <h4 id="badges-interne">Badges interne</h4>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-auto">
      <p><a href="pdf-bt-multiple.php"><button class="btn btn-primary" id="generate-bt">1- Générer tout les badges</button></a></p>
    </div>
    <div class="col" id="msg">

    </div>
  </div>


  <div class="row mt-5 mb-3">
    <div class="col">
      <div class="text-main-blue heavy">
        <h4 id="badges">Badges fournisseurs </h4>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-auto">
      <p><a href="pdf-fournisseur-multiple.php"><button class="btn btn-primary" id="generate">1- Générer tout les badges</button></a></p>
    </div>
    <div class="col" id="msg">

    </div>
  </div>

  <div class="row">
    <div class="col">

      <table class="table">
        <thead class="thead-dark">
          <tr>
            <th>Nom du fournisseur</th>
            <th>Nom des personnes présentes</th>
            <th>Badges</th>
          </tr>
        </thead>
        <tbody>
          <?php foreach ($listFournisseur as $key => $fournisseurMain): ?>
            <?php $fournisseurs=getFournisseurParticipants($pdoBt, $fournisseurMain['id']);?>

            <tr>
              <td><?=$fournisseurMain['fournisseur']?></td>
              <td>
                <?php foreach ($fournisseurs as $key => $f): ?>
                  <?=$f['nom'] .' ' .$f['prenom']?><br>
                <?php endforeach ?>
              </td>
              <td><a href="pdf-fournisseur.php?id=<?=$fournisseurMain['id']?>" class="<?= ($f['printed']==0)? 'btn btn-primary' :' btn btn-secondary'?>">Badge</a></td>
            </tr>
          <?php endforeach ?>

        </tbody>
      </table>

    </div>
  </div>


  <!-- ./container -->
</div>

<script type="text/javascript">

$(document).ready(function(){

  $('#generate').on("click", function(){

    $('#msg').append("<div='text-danger'>Merci de patienter, la génération des badges prend un certain temps. Une nouvelle page s'affichera quand les badges seront prêts</div>");

  });
    $('#generate-bt').on("click", function(){

    $('#msg').append("<div='text-danger'>Merci de patienter, la génération des badges prend un certain temps. Une nouvelle page s'affichera quand les badges seront prêts</div>");

  });

});

</script>



<?php
require '../view/_footer-bt.php';
?>